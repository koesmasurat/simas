<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - Enterprise</title>
    <link rel="icon" href="https://github.com/koesmasurat/simas/blob/main/simas%20logo4kecil.png?raw=true" type="image/png">
    
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:ital@1&display=swap" rel="stylesheet">
    
    <!-- PDF.js for AI Parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <!-- JS Utilities -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Markdown Parser for AI Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root { --glass-bg: rgba(255, 255, 255, 0.1); --glass-border: rgba(255, 255, 255, 0.2); --text-light: #f8f9fa; --emerald-accent: #f97316; --blue-accent: #3b82f6; --sidebar-width: 310px; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); background-attachment: fixed; color: var(--text-light); min-height: 100vh; overflow-x: hidden; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .white-panel { background: #ffffff !important; color: #333 !important; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); overflow: hidden; }
        .white-panel .card { border: none; box-shadow: none; }
        .white-panel h2, .white-panel h3, .white-panel label { color: #333 !important; }
        
        .glass-form-card { background: rgba(0, 0, 0, 0.6) !important; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; color: white !important; padding: 20px; box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .glass-form-card h3 { color: white !important; }
        .glass-form-card label { color: #f8f9fa !important; }
        .glass-form-card .form-control, .glass-form-card .form-select { background-color: #ffffff; color: #333333; border: none; }

        /* DASHBOARD CARDS */
        .dash-card { transition: transform 0.2s; cursor: pointer; border-radius: 12px; overflow: hidden; position: relative; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .dash-icon { position: absolute; right: 15px; bottom: 15px; font-size: 3rem; opacity: 0.2; }
        .welcome-header { background: linear-gradient(90deg, #0f172a, #334155); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }

        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 200; }
        .login-card { width: 100%; max-width: 450px; padding: 2.5rem; text-align: center; border-radius: 16px; position: relative; z-index: 201; }
        #door-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: flex; pointer-events: none; }
        .door-panel { width: 50%; height: 100%; background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%); position: relative; transition: transform 1.5s cubic-bezier(0.77, 0, 0.175, 1); box-shadow: 0 0 50px rgba(0,0,0,0.5); z-index: 101; }
        .door-open #door-left { transform: translateX(-100%); } .door-open #door-right { transform: translateX(100%); }
        
        #tsparticles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 150; pointer-events: none; transition: opacity 1.5s, filter 1.5s; }
        #tsparticles.in-background { z-index: 0 !important; opacity: 0.2 !important; filter: blur(2px); }
        
        #appContent { display: none; width: 100%; min-height: 100vh; position: relative; z-index: 50; } .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: var(--sidebar-width); max-width: var(--sidebar-width); background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); position: fixed; height: 100vh; z-index: 1000; display: flex; flex-direction: column; transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar.toggled { margin-left: calc(var(--sidebar-width) * -1); } .sidebar-scroll { flex-grow: 1; overflow-y: auto; padding: 1rem; scrollbar-width: thin; }
        #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); } #content.toggled { margin-left: 0; }
        
        @media (max-width: 768px) {
            #sidebar { box-shadow: 5px 0 15px rgba(0,0,0,0.5); }
            #content { margin-left: 0 !important; padding: 15px; }
            .ai-chat-window { width: 95% !important; bottom: 80px !important; right: 2.5% !important; height: 60vh !important; }
        }

        .nav-link { color: rgba(255,255,255,0.8); border-radius: 6px; padding: 10px 15px; margin-bottom: 4px; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; }
        .nav-link:hover { background: rgba(255,255,255,0.15); color: #fff; padding-left: 20px; } .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; } .nav-link i { width: 25px; text-align: center; margin-right: 10px; }
        .submenu { padding-left: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-bottom: 5px; } .submenu .nav-link { font-size: 0.85em; padding: 8px 12px; }
        
        .badge-count { font-size: 0.75rem; padding: 3px 8px; border-radius: 20px; margin-left: auto; background: rgba(255, 255, 255, 0.1); color: #ccc; display: none; transition: all 0.3s; } 
        .badge-count.has-data { display: inline-block; background: #ef4444; color: #fff; font-weight: bold; box-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
        #count-arsipku.has-data { background: #28a745 !important; }

        .table { font-size: 0.85rem; } .table th { background-color: #f1f5f9; color: #475569; font-weight: 600; }
        .modal-content { background: #fff; color: #333; }
        .perm-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 0.8rem; }
        .perm-category { grid-column: span 2; font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: var(--emerald-accent); border-bottom: 1px solid #eee; }
        .tab-pane { display: none; } .tab-pane.active { display: block; animation: fadeIn 0.4s; } 
        .restricted-feature { display: none !important; } 
        #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .user-list-item { padding: 5px 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .user-list-item:hover { background-color: #f8f9fa; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Timeline & Modals */
        .timeline { position: relative; padding-left: 30px; border-left: 2px solid #ddd; margin: 20px 0; }
        .timeline-item { position: relative; margin-bottom: 25px; }
        .timeline-item::before { content: ''; position: absolute; left: -36px; top: 0; width: 14px; height: 14px; border-radius: 50%; background: #fff; border: 3px solid #007bff; }
        .timeline-item.success::before { border-color: #28a745; background: #28a745; }
        .timeline-item.warning::before { border-color: #ffc107; background: #ffc107; }
        .timeline-date { font-size: 0.8rem; color: #888; margin-bottom: 4px; }
        .timeline-content { background: #f8f9fa; padding: 10px 15px; border-radius: 8px; border: 1px solid #e9ecef; }
        
        /* Modal Disposisi Style */
        #modalDisposisi .modal-content { background-color: rgba(255, 255, 0, 0.5) !important; backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.3); }
        #modalDisposisi .modal-title, #modalDisposisi label { color: #000 !important; }
        #dispTargetContainer { background-color: rgba(255, 255, 255, 0.85) !important; color: #000 !important; border: 1px solid #dee2e6; }
        #containerPembuat label { color: #212529 !important; font-weight: 500; }

        /* AI Button */
        .btn-ai-sparkle { background: linear-gradient(45deg, #6b21a8, #d946ef); color: white; border: none; transition: all 0.3s ease; }
        .btn-ai-sparkle:hover { background: linear-gradient(45deg, #581c87, #c026d3); color: white; box-shadow: 0 0 15px rgba(217, 70, 239, 0.5); transform: translateY(-1px); }

        /* AI Chat Widget */
        .ai-chat-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #f97316 0%, #d946ef 100%); box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4); color: white; font-size: 24px; border: none; cursor: pointer; z-index: 9990; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; justify-content: center; }
        .ai-chat-btn:hover { transform: scale(1.1) rotate(10deg); box-shadow: 0 6px 20px rgba(249, 115, 22, 0.6); }
        .ai-chat-window { position: fixed; bottom: 100px; right: 30px; width: 380px; height: 500px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 9991; display: none; flex-direction: column; overflow: hidden; border: 1px solid rgba(255,255,255,0.5); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .ai-header { background: linear-gradient(90deg, #f97316, #ec4899); padding: 15px; color: white; display: flex; justify-content: between; align-items: center; }
        .ai-messages { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f8f9fa; }
        .ai-msg { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; position: relative; word-wrap: break-word; }
        .ai-msg.user { align-self: flex-end; background: #3b82f6; color: white; border-bottom-right-radius: 2px; }
        .ai-msg.bot { align-self: flex-start; background: white; color: #333; border: 1px solid #e5e7eb; border-bottom-left-radius: 2px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-input-area { padding: 10px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        .ai-input-area input { border-radius: 20px; padding-left: 15px; border: 1px solid #ddd; background: #f8f9fa; }
        .ai-input-area input:focus { outline: none; border-color: #f97316; background: white; }
        .typing-indicator { font-size: 12px; color: #888; font-style: italic; margin-left: 10px; display: none; }
        .ai-markdown table { width: 100%; border-collapse: collapse; font-size: 0.8rem; margin: 5px 0; }
        .ai-markdown th, .ai-markdown td { border: 1px solid #ddd; padding: 4px; }
        .ai-markdown th { background-color: #f1f5f9; }
    </style>
</head>
<body>
    <div id="tsparticles"></div>
    <div id="door-overlay"><div id="door-left" class="door-panel"></div><div id="door-right" class="door-panel"></div></div>
    <div id="loadingOverlay"><div class="text-center"><div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div><h5 class="text-white">Memproses Data...</h5></div></div>

    <!-- AI Chat Floating Button & Window -->
    <button class="ai-chat-btn restricted-feature" data-perm="chat_ai" onclick="toggleAIChat()" title="Tanya AI Database">
        <i class="fas fa-robot"></i>
    </button>
    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-header">
            <div class="d-flex align-items-center gap-2"><i class="fas fa-sparkles"></i> <strong>Asisten SIMAS</strong></div>
            <button class="btn btn-sm text-white" onclick="toggleAIChat()"><i class="fas fa-times"></i></button>
        </div>
        <div class="ai-messages" id="aiMessages">
            <div class="ai-msg bot">Halo! Saya asisten AI SIMAS. Anda bisa bertanya tentang data surat atau cara penggunaan aplikasi.</div>
        </div>
        <div class="typing-indicator" id="aiTyping">AI sedang mengetik...</div>
        <div class="ai-input-area">
            <input type="text" id="aiInput" class="form-control form-control-sm" placeholder="Ketik pertanyaan..." onkeypress="handleAiEnter(event)">
            <button class="btn btn-primary btn-sm rounded-circle" onclick="sendAiMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <datalist id="listKodeKlarifikasi"></datalist>
    <datalist id="listBagian">
        <option value="Direktur">Direktur</option>
        <option value="Wadir Umum & Keuangan">Wadir Umum & Keu</option>
        <option value="Wadir Pelayanan">Wadir Pelayanan</option>
        <option value="Bagian Administrasi & Umum">Bagian Adm & Umum</option>
        <option value="Bagian Keuangan">Bagian Keuangan</option>
        <option value="Bagian Program & Pelaporan">Bagian Program</option>
        <option value="Bidang Pelayanan Medik">Bidang Yanmed</option>
        <option value="Bidang Pelayanan Penunjang">Bidang Penunjang</option>
        <option value="Bidang Pelayanan Keperawatan">Bidang Keperawatan</option>
        <option value="Staf Administrasi">Staf Administrasi</option>
        <option value="Staf Pelayanan">Staf Pelayanan</option>
    </datalist>

    <div id="loginSection">
        <div class="glass-panel login-card">
            <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="100" class="mb-3">
            <h3 class="fw-bold text-white">SIMAS KOESMA</h3>
            <p class="text-white-50">Sistem Informasi Manajemen Arsip Surat</p>
            <div class="d-flex justify-content-center">
                <div id="g_id_onload" data-client_id="783459415718-mp0vsmd2lopajf2ut0aqc6drjrs95pu8.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_prompt="false"></div>
                <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_blue" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></div>
            </div>
        </div>
    </div>

    <div id="appContent">
        <div class="wrapper">
            <nav id="sidebar">
                <div class="p-3 text-center border-bottom border-white-50">
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                        <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" width="40">
                        <div class="text-start lh-1"><div class="fw-bold small">RSUD dr. R. KOESMA</div><div class="text-warning" style="font-size: 0.7rem;">SIMAS KOESMA</div></div>
                    </div>
                    <div class="bg-white bg-opacity-10 rounded p-2 mt-2"><div class="fw-bold text-truncate" id="userDisplayName">Pengguna</div><div class="badge bg-info text-dark" id="userRoleBadge">Role</div></div>
                </div>
                
                <div class="sidebar-scroll">
                    <button class="nav-link w-100 text-start" id="btn-home" onclick="activateTab('home-content', this); updateSidebarBadges();"><i class="fas fa-home"></i> Beranda</button>
                    <button class="nav-link w-100 text-start" onclick="openMyProfile()"><i class="fas fa-user-circle"></i> Profil Saya</button>
                    <button class="nav-link w-100 text-start text-warning" onclick="openSettingTujuan()"><i class="fas fa-user-friends"></i> Setting Tujuan</button>
                    
                    <div class="my-2 border-top border-white-50"></div>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="search_advanced" onclick="openAdvancedSearch()"><i class="fas fa-search"></i> Pencarian Lanjut (OCR)</button>
                    <div class="my-2 border-top border-white-50"></div>

                    <button class="nav-link w-100 text-start restricted-feature" data-perm="input_masuk" onclick="activateTab('input-masuk-content', this); autoFillAgendaMasuk(); setDefaultDatesMasuk();"><i class="fas fa-envelope-open-text"></i> Surat Masuk</button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="input_keluar" onclick="openInputKeluar(this)"><i class="fas fa-paper-plane"></i> Surat Keluar</button>
                    
                    <div class="my-2 border-top border-white-50"></div>
                    
                    <button class="nav-link w-100 text-start" id="btnInboxStaf" onclick="openDisposisiPage('staf', this)"><i class="fas fa-inbox"></i> Inboxku <span class="badge-count" id="count-staf">0</span></button>
                    <button class="nav-link w-100 text-start text-warning" id="btnArsipku" onclick="openArsipku(this)"><i class="fas fa-archive"></i> Arsipku (Selesai) <span class="badge-count" id="count-arsipku">0</span></button>
                    
                    <div id="delegationMenuContainer" style="display:none;">
                        <div class="my-2 border-top border-white-50"></div>
                        <div class="fw-bold text-white-50 px-3 py-1 small"><i class="fas fa-user-friends me-1"></i> Inbox Delegasi</div>
                        <div id="delegationLinks"></div>
                    </div>

                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_direktur" onclick="openDisposisiPage('direktur', this)">Inbox Direktur <span class="badge-count" id="count-direktur">0</span></button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_wadir_adm" onclick="openDisposisiPage('wadir_adm', this)">Inbox Wadir Umum & Keu <span class="badge-count" id="count-wadir_adm">0</span></button>
                    <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_wadir_pel" onclick="openDisposisiPage('wadir_pel', this)">Inbox Wadir Pelayanan <span class="badge-count" id="count-wadir_pel">0</span></button>
                    
                    <a class="nav-link w-100 text-start" id="btnInboxKabagParent" data-bs-toggle="collapse" href="#subKabag" role="button">Inbox Kabag/Kabid <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="subKabag">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_umum" onclick="openDisposisiPage('kabag_umum', this)">Kabag Umum <span class="badge-count" id="count-kabag_umum">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_keu" onclick="openDisposisiPage('kabag_keuangan', this)">Kabag Keu <span class="badge-count" id="count-kabag_keuangan">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabag_prog" onclick="openDisposisiPage('kabag_progpel', this)">Kabag Progpel <span class="badge-count" id="count-kabag_progpel">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_yanmed" onclick="openDisposisiPage('kabid_yanmed', this)">Kabid Yanmed <span class="badge-count" id="count-kabid_yanmed">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_penunjang" onclick="openDisposisiPage('kabid_penunjang', this)">Kabid Penunjang <span class="badge-count" id="count-kabid_penunjang">0</span></button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="inbox_kabid_kep" onclick="openDisposisiPage('kabid_keperawatan', this)">Kabid Kep <span class="badge-count" id="count-kabid_keperawatan">0</span></button>
                    </div>

                    <div class="my-2 border-top border-white-50"></div>
                    <a class="nav-link w-100 text-start text-info restricted-feature" id="btnArsipMasukParent" data-bs-toggle="collapse" href="#menuArsipMasuk" role="button"><i class="fas fa-folder-open"></i> Arsip Masuk <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="menuArsipMasuk">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_all" onclick="openArsipPage('masuk', 'all', this)">All (Semua)</button>
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_masuk_direktur" onclick="openArsipPage('masuk', 'direktur', this)">Direktur</button>
                        <!-- Tambahkan tombol arsip masuk lainnya sesuai kebutuhan -->
                    </div>

                    <a class="nav-link w-100 text-start text-success restricted-feature" id="btnArsipKeluarParent" data-bs-toggle="collapse" href="#menuArsipKeluar" role="button"><i class="fas fa-archive"></i> Arsip Keluar <i class="fas fa-chevron-down ms-auto small"></i></a>
                    <div class="collapse submenu" id="menuArsipKeluar">
                        <button class="nav-link w-100 text-start restricted-feature" data-perm="arsip_keluar_all" onclick="openArsipPage('keluar', 'all', this)">All (Semua)</button>
                        <!-- Tambahkan tombol arsip keluar lainnya -->
                    </div>

                    <div id="personalArsipContainer"></div>

                    <div class="my-2 border-top border-white-50"></div>
                    <button class="nav-link w-100 text-start text-danger restricted-feature" data-perm="setting_user" onclick="openSettingsPage(this)"><i class="fas fa-users-cog"></i> Pengaturan</button>
                </div>
                <div class="p-3 bg-dark bg-opacity-25 border-top border-white-50"><button class="btn btn-danger w-100" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button></div>
            </nav>

            <div id="content">
                <button type="button" id="sidebarCollapse" class="btn btn-outline-light mb-3"><i class="fas fa-bars"></i> Menu</button>
                <div class="tab-content">
                    
                    <!-- HOME DASHBOARD -->
                    <div class="tab-pane active white-panel p-4" id="home-content">
                        <div class="welcome-header d-flex justify-content-between align-items-center">
                            <div><h2 class="fw-bold mb-1" id="dashGreeting">Selamat Datang</h2><p class="mb-0 opacity-75" id="dashDate">...</p></div>
                            <div class="text-end"><h5 class="mb-0" id="dashUser">...</h5><span class="badge bg-warning text-dark" id="dashRole">...</span></div>
                        </div>
                        <div class="row g-4 mb-4">
                            <div class="col-md-4"><div class="card dash-card bg-primary text-white h-100" onclick="$('button:contains(Inboxku)').click()"><div class="card-body"><h6 class="card-title text-white-50 mb-1">Inbox Saya</h6><h2 class="display-4 fw-bold mb-0" id="dashInboxVal">0</h2><i class="fas fa-inbox dash-icon"></i></div></div></div>
                            <div class="col-md-4"><div class="card dash-card bg-success text-white h-100" onclick="$('#btnArsipMasukParent').click()"><div class="card-body"><h6 class="card-title text-white-50 mb-1">Surat Masuk RS</h6><h2 class="display-4 fw-bold mb-0" id="dashMasukVal">0</h2><i class="fas fa-envelope-open-text dash-icon"></i></div></div></div>
                            <div class="col-md-4"><div class="card dash-card bg-info text-white h-100" onclick="openArsipku()"><div class="card-body"><h6 class="card-title text-white-50 mb-1">Kinerja Saya</h6><h2 class="display-4 fw-bold mb-0" id="dashArsipVal">0</h2><i class="fas fa-check-circle dash-icon"></i></div></div></div>
                        </div>
                        <div class="row g-4">
                            <div class="col-lg-8"><div class="card h-100 shadow-sm border-0"><div class="card-header bg-white fw-bold py-3"><i class="fas fa-chart-bar text-primary me-2"></i>Tren Surat Masuk</div><div class="card-body"><canvas id="dashboardChart" style="max-height: 300px;"></canvas></div></div></div>
                            <div class="col-lg-4"><div class="card h-100 shadow-sm border-0"><div class="card-header bg-white fw-bold py-3">Akses Cepat</div><div class="card-body d-grid gap-2"><button class="btn btn-outline-primary text-start p-3 restricted-feature" data-perm="input_masuk" onclick="$('button:contains(Surat Masuk)').click()">Input Surat Masuk</button><button class="btn btn-outline-success text-start p-3 restricted-feature" data-perm="input_keluar" onclick="$('button:contains(Surat Keluar)').click()">Input Surat Keluar</button></div></div></div>
                        </div>
                    </div>

                    <!-- SEARCH RESULT -->
                    <div class="tab-pane white-panel p-4" id="search-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2">Hasil Pencarian</h3>
                        <div class="table-responsive"><table id="tableSearch" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Tgl</th><th>Agenda</th><th>Ref</th><th>Perihal</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- INPUT MASUK -->
                    <div class="tab-pane glass-form-card" id="input-masuk-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2 text-white">Catat Surat Masuk</h3>
                        <form id="formSuratMasuk">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label fw-bold">No. Agenda</label><input type="number" class="form-control" name="noAgenda" id="inNoAgenda" required></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tgl Surat</label><input type="date" class="form-control" id="sm_tglSurat" name="tglSurat" required></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tgl Terima</label><input type="date" class="form-control" name="tglTerima" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">No. Surat</label><input type="text" class="form-control" id="sm_noSurat" name="noSurat" required></div>
                                <div class="col-md-6"><label class="form-label fw-bold">Pengirim</label><input type="text" class="form-control" id="sm_pengirim" name="pengirim" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Kode Klarifikasi</label><input type="text" class="form-control" name="kodeKlarifikasi" list="listKodeKlarifikasi"></div>
                                <div class="col-12"><label class="form-label fw-bold">Perihal</label><textarea class="form-control" id="sm_perihal" name="perihal" rows="3" required></textarea></div>
                                <div class="col-12"><label class="form-label fw-bold">Upload File (PDF/IMG)</label><input type="file" class="form-control mb-2" id="fileSuratMasuk"><button type="button" class="btn btn-ai-sparkle w-100" onclick="autoFillSuratMasuk()"><i class="fas fa-magic me-2"></i>✨ Baca File & Isi Otomatis</button></div>
                                <div class="col-12" id="divRingkasanMasuk" style="display:none;"><label class="form-label fw-bold">Ringkasan (AI)</label><textarea class="form-control bg-light" name="ringkasan" id="sm_ringkasan" rows="3"></textarea></div>
                                <div class="col-12 mt-4"><button type="submit" class="btn btn-primary w-100 py-2">Simpan</button></div>
                            </div>
                        </form>
                    </div>

                    <!-- INPUT KELUAR -->
                    <div class="tab-pane glass-form-card" id="input-keluar-content">
                        <h3 class="fw-bold mb-4 border-bottom pb-2 text-white">Catat Surat Keluar</h3>
                        <form id="formSuratKeluar">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label fw-bold">No. Agenda</label><div class="input-group"><input type="text" class="form-control" name="noAgenda" id="outNoAgenda" required><button class="btn btn-warning fw-bold" type="button" onclick="openBookingModal('keluar')">Booking</button></div></div>
                                <div class="col-md-4"><label class="form-label fw-bold">No. Surat</label><input type="text" class="form-control" name="noSurat" id="sk_noSurat"></div>
                                <div class="col-md-4"><label class="form-label fw-bold">Tanggal</label><input type="date" class="form-control" name="tglSurat" id="sk_tglSurat" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Tujuan</label><input type="text" class="form-control" name="tujuan" id="sk_tujuan" required></div>
                                <div class="col-12"><label class="form-label fw-bold">Pembuat Surat</label><div class="input-group mb-2"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="text" class="form-control form-control-sm" id="searchPembuat" placeholder="Cari..." onkeyup="filterPembuatList()"></div><div id="containerPembuat" class="border rounded p-2 bg-white text-dark" style="max-height: 200px; overflow-y: auto;"></div><div class="mt-2"><div class="form-check"><input class="form-check-input" type="checkbox" id="chkManualPembuat" onchange="toggleManualPembuat(this)"><label class="form-check-label small text-white" for="chkManualPembuat">Lainnya (Ketik Manual)</label></div><input type="text" class="form-control mt-1" id="inputPembuatManual" placeholder="Ketik manual..." style="display:none;"></div></div>
                                <div class="col-12"><div class="d-flex justify-content-between align-items-end mb-1"><label class="form-label fw-bold mb-0">Perihal</label><button type="button" class="btn btn-sm btn-ai-sparkle py-0 px-2" onclick="aiRefinePerihal()"><i class="fas fa-magic me-1"></i>Perhalus Bahasa</button></div><textarea class="form-control" name="perihal" id="outPerihal" rows="3" required></textarea></div>
                                <div class="col-12"><label class="form-label fw-bold">Upload File</label><input type="file" class="form-control mb-2" id="fileSuratKeluar"><button type="button" class="btn btn-ai-sparkle w-100" onclick="autoFillSuratKeluar()"><i class="fas fa-magic me-2"></i>✨ Baca File & Isi Otomatis</button></div>
                                <div class="col-12" id="divRingkasanKeluar" style="display:none;"><label class="form-label fw-bold">Ringkasan (AI)</label><textarea class="form-control bg-light" name="ringkasan" id="sk_ringkasan" rows="3"></textarea></div>
                                <div class="col-12 mt-4"><button type="submit" class="btn btn-success w-100 py-2">Simpan</button></div>
                            </div>
                        </form>
                    </div>

                    <!-- INBOX -->
                    <div class="tab-pane white-panel p-4" id="disposisi-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><div><h3 class="fw-bold m-0">Inbox: <span class="text-warning" id="dispPageTitle">...</span></h3><div id="dispDelegationBanner" class="badge bg-warning text-dark mt-1" style="display:none;"><i class="fas fa-user-secret me-1"></i> Delegasi Akses</div></div><button class="btn btn-outline-primary btn-sm" onclick="refreshCurrentDisposisi()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableDisposisi" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th style="width:1%">Tgl</th><th style="width:1%">Agenda</th><th style="width:15%">Pengirim</th><th>Perihal</th><th style="width:25%">Disposisi</th><th style="width:1%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- ARSIPKU -->
                    <div class="tab-pane white-panel p-4" id="arsipku-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><h3 class="fw-bold m-0 text-success">Arsipku (Selesai)</h3><button class="btn btn-outline-success btn-sm" onclick="loadArsipku()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableArsipku" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th>Tgl Terima</th><th>Agenda</th><th>Perihal</th><th>Pengirim</th><th>Tindak Lanjut</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- ARSIP MASUK & KELUAR -->
                    <div class="tab-pane white-panel p-4" id="arsip-masuk-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><h3 class="fw-bold m-0">Arsip Masuk</h3><button class="btn btn-outline-info btn-sm" onclick="loadArsipMasuk()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableArsipMasuk" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th style="width:1%">Tgl</th><th style="width:1%">Agenda</th><th>Pengirim</th><th style="width:50%">Perihal</th><th style="width:1%">Status</th><th style="width:1%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>
                    <div class="tab-pane white-panel p-4" id="arsip-keluar-container">
                        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2"><h3 class="fw-bold m-0">Arsip Keluar</h3><button class="btn btn-outline-success btn-sm" onclick="loadArsipKeluar()">Refresh</button></div>
                        <div class="table-responsive"><table id="tableArsipKeluar" class="table table-hover table-bordered w-100 align-middle"><thead class="table-light"><tr><th style="width:1%">Agenda</th><th style="width:1%">Tgl</th><th style="width:25%">Tujuan</th><th style="width:40%">Perihal</th><th style="width:15%">Pembuat</th><th style="width:1%">Status</th><th style="width:1%">Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>

                    <!-- SETTINGS -->
                    <div class="tab-pane white-panel p-4" id="settings-content">
                        <h3 class="fw-bold m-0 text-danger mb-3 border-bottom pb-2">Pengaturan</h3>
                        <div class="d-flex gap-2 mb-3"><button class="btn btn-primary btn-sm" onclick="loadUsers()">Reload User</button><button class="btn btn-warning btn-sm" onclick="loadStorageStats()">Cek Storage</button></div>
                        <div class="card mb-4 border-warning shadow-sm"><div class="card-header bg-warning text-dark fw-bold">Infrastruktur Penyimpanan</div><div class="card-body"><div class="row g-3 text-center mb-3"><div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Server Utama (A)</h6><h5 id="disp-quota-A">...</h5><div class="progress" style="height:5px"><div id="prog-A" class="progress-bar bg-primary" style="width:0%"></div></div></div></div><div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Gudang 1 (B)</h6><h5 id="disp-quota-B">...</h5><div class="progress" style="height:5px"><div id="prog-B" class="progress-bar bg-success" style="width:0%"></div></div></div></div><div class="col-md-4"><div class="p-2 border rounded bg-light"><h6>Gudang 2 (C)</h6><h5 id="disp-quota-C">...</h5><div class="progress" style="height:5px"><div id="prog-C" class="progress-bar bg-warning" style="width:0%"></div></div></div></div></div><div class="d-flex justify-content-between align-items-center bg-light p-2 rounded"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="switchFailover" onchange="saveStorageSettings()"><label class="form-check-label fw-bold" for="switchFailover">Failover Otomatis</label></div><select class="form-select form-select-sm w-auto" id="selectActiveNode" onchange="saveStorageSettings()"><option value="0">Server Utama</option><option value="1">Gudang 1</option><option value="2">Gudang 2</option></select></div><div class="mt-2 text-end"><button class="btn btn-dark btn-sm" onclick="backupDatabase()"><i class="fas fa-download me-1"></i>Backup Database (XLSX)</button></div></div></div>
                        <h5 class="fw-bold mb-3">Daftar Pengguna</h5>
                        <div class="table-responsive"><table id="tableUsers" class="table table-striped w-100 align-middle"><thead class="table-dark"><tr><th>Email</th><th>Nama</th><th>Role</th><th>Status</th><th>Aksi</th></tr></thead><tbody></tbody></table></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal fade" id="modalFinishDisposition" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Selesaikan Tugas</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formFinishDisposition"><input type="hidden" id="fd_agenda"><div class="mb-3"><label class="form-label fw-bold">Keterangan:</label><textarea class="form-control" id="fd_note" rows="3" required></textarea></div><button type="button" class="btn btn-success w-100 fw-bold" onclick="submitFinishDisposition()">Simpan & Selesaikan</button></form></div></div></div></div>
    <div class="modal fade" id="modalSettingTujuan" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Atur Tujuan Disposisi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="input-group mb-3"><span class="input-group-text"><i class="fas fa-search"></i></span><input type="text" class="form-control" id="searchSettingTujuan" placeholder="Cari..." onkeyup="filterSettingTujuan()"></div><div id="listSettingTujuan" class="border rounded p-2 bg-light" style="max-height: 300px; overflow-y: auto;"></div></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveSettingTujuan()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalUpdateProfile" data-bs-backdrop="static" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-primary"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Update Profil</h5></div><div class="modal-body"><form id="formUpdateProfile"><div class="mb-3"><label class="form-label small">Nama</label><input type="text" class="form-control" id="prof_nama" required></div><div class="mb-3"><label class="form-label small">Bidang</label><input class="form-control" list="listBagian" id="prof_bidang" required></div><div class="mb-3"><label class="form-label small">WA</label><input type="number" class="form-control" id="prof_wa" required></div><input type="hidden" id="prof_email"><button type="submit" class="btn btn-primary w-100">Simpan</button><button type="button" class="btn btn-secondary w-100 mt-2" id="btnCancelProfile" data-bs-dismiss="modal">Batal</button></form></div></div></div></div>
    <div class="modal fade" id="modalHistory" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h5 class="modal-title">History Surat</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="historyLoading" class="text-center py-3"><div class="spinner-border text-info"></div></div><div id="historyContent" style="display:none;"><div class="alert alert-light border"><div id="histPerihal" class="fs-6 fw-bold">...</div></div><div class="timeline" id="timelineContainer"></div></div></div><div class="modal-footer"><a id="btnShareWA" target="_blank" class="btn btn-success w-100 fw-bold"><i class="fab fa-whatsapp me-2"></i>Share WA</a></div></div></div></div>
    <div class="modal fade" id="modalDisposisi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Kirim Disposisi</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formDisposisi"><input type="hidden" id="dispIdSurat"><div class="alert alert-light border shadow-sm mb-3"><small class="text-muted d-block fw-bold">Perihal:</small><span id="dispPerihal" class="fs-6 text-dark">...</span></div><div class="mb-3"><label class="fw-bold small mb-1">Tanggal:</label><input type="date" class="form-control" id="dispTglDisposisi"></div><div class="mb-3"><label class="fw-bold small mb-1">Tujuan:</label><div id="dispTargetContainer" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"></div></div><div class="mb-3"><div class="d-flex justify-content-between align-items-center mb-1"><label class="fw-bold small mb-0">Instruksi:</label><button type="button" class="btn btn-sm btn-ai-sparkle py-0 px-2" onclick="aiSuggestDisposition()"><i class="fas fa-robot me-1"></i>Saran AI</button></div><textarea class="form-control" id="dispInstruksi" rows="4"></textarea></div><button type="button" class="btn btn-warning w-100 fw-bold" onclick="submitDisposisi()">Kirim</button></form></div></div></div></div>
    <div class="modal fade" id="modalEditDisposisi" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-danger text-white"><h5 class="modal-title">Edit Disposisi</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditDisposisi"><input type="hidden" id="ed_agenda"><div class="mb-3"><label class="small fw-bold">Direktur</label><div id="box_ed_direktur" class="border p-2 rounded bg-light mb-1"></div><textarea id="val_ed_isi_direktur" class="form-control form-control-sm" rows="2"></textarea></div><div class="mb-3"><label class="small fw-bold">Wadir</label><div id="box_ed_wadir" class="border p-2 rounded bg-light mb-1"></div><textarea id="val_ed_isi_wadir" class="form-control form-control-sm" rows="2"></textarea></div><div class="mb-3"><label class="small fw-bold">Kabid/Kabag</label><input type="text" class="form-control form-control-sm mb-1" placeholder="Cari..." onkeyup="filterEditDispoStaf(this)"><div id="box_ed_kabid" class="border p-2 rounded bg-light mb-1" style="max-height:150px; overflow-y:auto"></div><textarea id="val_ed_isi_kabid" class="form-control form-control-sm" rows="2"></textarea></div><button type="button" class="btn btn-danger w-100" onclick="saveEditDisposisi()">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="modalStatusApproval" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h5 class="modal-title">Edit Approval</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formStatusApproval"><input type="hidden" id="esa_agenda"><div class="mb-3"><label class="form-label fw-bold">Tgl Tanda Tangan:</label><input type="date" class="form-control" id="esa_tanggal"></div><button type="button" class="btn btn-success w-100" onclick="saveStatusApproval()">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="modalEditUser" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Edit User</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light"><form id="formEditUser"><input type="hidden" id="editUserEmail"><div class="row g-2 mb-3 bg-white p-3 rounded shadow-sm"><div class="col-md-6"><label class="small fw-bold">Nama</label><input type="text" class="form-control" id="editUserName"></div><div class="col-md-3"><label class="small fw-bold">Role</label><select class="form-select" id="editUserRole"><option value="User">User</option><option value="Admin">Admin</option><option value="Super Admin">Super Admin</option></select></div><div class="col-md-3"><label class="small fw-bold">Status</label><select class="form-select" id="editUserStatus"><option value="Aktif">Aktif</option><option value="Blokir">Blokir</option></select></div><div class="col-md-6"><label class="small fw-bold">Bidang</label><input type="text" class="form-control" id="editUserBidang" list="listBagian"></div><div class="col-md-6"><label class="small fw-bold">WA</label><input type="text" class="form-control" id="editUserWA"></div><div class="col-12 border-top mt-2 pt-2"><label class="small fw-bold text-danger">Jabatan Struktural</label><select class="form-select border-danger" id="editUserJabatan"><option value="">- Staf Biasa -</option><option value="Direktur">Direktur</option><option value="Wadir Umum & Keuangan">Wadir Umum & Keuangan</option><option value="Wadir Pelayanan">Wadir Pelayanan</option><option value="Kabag Umum">Kabag Umum</option><option value="Kabag Keuangan">Kabag Keuangan</option><option value="Kabag Program">Kabag Program</option><option value="Kabid Yanmed">Kabid Yanmed</option><option value="Kabid Penunjang">Kabid Penunjang</option><option value="Kabid Keperawatan">Kabid Keperawatan</option></select></div></div><div class="row g-3"><div class="col-md-6"><div class="bg-white border rounded p-3 h-100"><label class="fw-bold text-success">Bawahan (Tujuan Disposisi)</label><input type="text" class="form-control form-control-sm mb-2" id="searchSubs" onkeyup="filterSubs()"><div id="listCandidates" class="border rounded p-2" style="max-height:200px;overflow-y:auto;background:#f9f9f9;"></div></div></div><div class="col-md-6"><div class="bg-white border rounded p-3 h-100 border-warning"><label class="fw-bold text-warning">Delegasi Inbox</label><input type="text" class="form-control form-control-sm mb-2" id="searchDelegations" onkeyup="filterDelegations()"><div id="listDelegations" class="border rounded p-2" style="max-height:200px;overflow-y:auto;background:#fffbe6;"></div></div></div></div><div class="bg-white p-3 rounded shadow-sm border mt-3" style="max-height: 400px; overflow-y: auto;"><div class="perm-grid" id="permissionContainer"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-primary" onclick="saveUserPermissions()">Simpan</button></div></div></div></div>
    <div class="modal fade" id="modalEditSuratMasuk" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Edit Surat Masuk</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditSuratMasuk"><div class="mb-3"><label>Agenda</label><input type="text" class="form-control" id="em_displayAgenda" disabled><input type="hidden" id="em_noAgenda"></div><div class="row g-2 mb-3"><div class="col-6"><label>Tgl Surat</label><input type="date" class="form-control" id="em_tglSurat"></div><div class="col-6"><label>Tgl Terima</label><input type="date" class="form-control" id="em_tglTerima"></div></div><div class="mb-3"><label>No Surat</label><input type="text" class="form-control" id="em_noSurat"></div><div class="mb-3"><label>Pengirim</label><input type="text" class="form-control" id="em_pengirim"></div><div class="mb-3"><label>Kode</label><input type="text" class="form-control" id="em_kodeKlarifikasi"></div><div class="mb-3"><label>Perihal</label><textarea class="form-control" id="em_perihal" rows="3"></textarea></div><div class="mb-3"><label>File</label><input type="file" class="form-control" id="em_file"></div><button type="button" class="btn btn-warning w-100" onclick="saveEditMasuk()">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="modalSearchAdvanced" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title">Pencarian Lanjut</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form onsubmit="event.preventDefault(); submitSearchAdvanced();"><div class="mb-3"><label>Kategori</label><select class="form-select" id="sa_category"><option value="masuk">Surat Masuk</option><option value="keluar">Surat Keluar</option></select></div><div class="mb-3"><label>Keyword</label><input type="text" class="form-control" id="sa_keyword"></div><div class="row g-2 mb-3"><div class="col-6"><label>Dari</label><input type="date" class="form-control" id="sa_start"></div><div class="col-6"><label>Sampai</label><input type="date" class="form-control" id="sa_end"></div></div><button type="submit" class="btn btn-primary w-100">Cari</button></form></div></div></div></div>
    <div class="modal fade" id="modalEditSuratKeluar" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title">Edit Surat Keluar</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="formEditSuratKeluar"><div class="mb-3"><label>Agenda</label><input type="text" class="form-control" id="ek_displayAgenda" disabled><input type="hidden" id="ek_noAgenda"></div><div class="mb-3"><label>Tgl Surat</label><input type="date" class="form-control" id="ek_tglSurat"></div><div class="mb-3"><label>No Surat</label><input type="text" class="form-control" id="ek_noSurat"></div><div class="mb-3"><label>Tujuan</label><input type="text" class="form-control" id="ek_tujuan"></div><div class="mb-3"><label>Perihal</label><textarea class="form-control" id="ek_perihal" rows="3"></textarea></div><div class="mb-3"><label>File</label><input type="file" class="form-control" id="ek_file"></div><button type="button" class="btn btn-warning w-100" onclick="saveEditKeluar()">Simpan</button></form></div></div></div></div>
    <div class="modal fade" id="modalBooking" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h5 class="modal-title">Booking Agenda</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="bookingCategory"><div class="alert alert-info">Terakhir: <strong id="lastAgendaDisplay">...</strong></div><div class="mb-3"><label>Nomor Booking</label><input type="number" class="form-control" id="bookingValue"></div><div class="mb-3"><label>Catatan</label><input type="text" class="form-control" id="bookingNote"></div><div class="d-flex gap-2"><button type="button" class="btn btn-secondary flex-grow-1" onclick="applyBooking()">Gunakan Saja</button><button type="button" class="btn btn-primary flex-grow-1" onclick="saveBooking()">Simpan Booking</button></div></div></div></div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles-slim@2.0.6/tsparticles.slim.bundle.min.js"></script>
    
    <script>
        // ==========================================
        // KONFIGURASI FRONTEND
        // =========================================
        
        // PENTING: GANTI URL DI BAWAH INI DENGAN URL DEPLOYMENT WEB APP ANDA
        // Caranya: Deploy -> New Deployment -> Web App -> Anyone -> Copy URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxll_gAlMvLBSTn_WdJbaGjp4lCeRgf82XX7YRzF4XyaZ631OHTaHMQQDQ687glfqu5_g/exec"; 
        
        let currentUserEmail = "", currentInboxLevel = "", currentArsipScope = "";
        let currentInboxContextEmail = "", currentInboxContextName = "", currentContextSubordinates = []; 
        let allUsersList = [], dashboardChart = null; 
        
        $(document).ready(function() { 
            if(sessionStorage.getItem('isLoggedIn')==='true'){ 
                currentUserEmail=sessionStorage.getItem('userEmail');
                try { currentContextSubordinates = JSON.parse(sessionStorage.getItem('userSubordinates') || "[]"); } catch(e) { currentContextSubordinates = []; }
                showApp(); renderSidebarPermissions(); loadRefCodes(); 
                const lastState = JSON.parse(sessionStorage.getItem('simas_last_state') || "{}");
                if(lastState.tabId) {
                    if(lastState.tabId.includes('arsip-masuk')) openArsipPage('masuk', lastState.context, null);
                    else if(lastState.tabId.includes('arsip-keluar')) openArsipPage('keluar', lastState.context, null);
                    else if(lastState.tabId.includes('disposisi')) openDisposisiPage(lastState.context, null, lastState.contextEmail, lastState.contextName);
                    else if(lastState.tabId.includes('arsipku')) openArsipku(null); 
                    else activateTab(lastState.tabId, null);
                } else loadDashboardStats();
                updateSidebarBadges();
            } 
            $('#sidebarCollapse').on('click', function(){ $('#sidebar, #content').toggleClass('toggled'); });
            tsParticles.load("tsparticles", { fpsLimit: 60, particles: { number: { value: 30, density: { enable: true, value_area: 800 } }, color: { value: "#ffffff" }, shape: { type: "image", image: [ { src: "data:image/svg+xml;utf8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23ffffff' d='M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z'/%3E%3C/svg%3E", width: 32, height: 32 } ] }, opacity: { value: 0.6, random: true }, size: { value: 20, random: true }, move: { enable: true, speed: 2 }, links: { enable: true, distance: 150, color: "#ffffff", opacity: 0.2, width: 1 } } });
            initMobileFeatures(); $(window).resize(initMobileFeatures);
        });

        function initMobileFeatures() {
            const isMobile = $(window).width() <= 768; const sidebar = $('#sidebar'); const content = $('#content');
            if (isMobile && !sidebar.hasClass('toggled')) { sidebar.addClass('toggled'); content.addClass('toggled'); }
            $(document).off('click.mobileOutside').on('click.mobileOutside', function(e) {
                if ($(window).width() <= 768 && !sidebar.hasClass('toggled') && !$(e.target).closest('#sidebar').length && !$(e.target).closest('#sidebarCollapse').length && !$(e.target).closest('.ai-chat-btn').length) { sidebar.addClass('toggled'); content.addClass('toggled'); }
            });
        }

        function saveAppState(tabId, context = null, contextEmail = null, contextName = null) { sessionStorage.setItem('simas_last_state', JSON.stringify({ tabId: tabId, context: context, contextEmail: contextEmail, contextName: contextName })); }
        function showLoading(s){$('#loadingOverlay').css('display',s?'flex':'none')}
        function showApp(){ $('#tsparticles').addClass('in-background'); $('#loginSection').fadeOut(500, ()=>{ $('#door-overlay').addClass('door-open'); setTimeout(()=>{ $('#appContent').fadeIn(500); $('#userDisplayName').text(sessionStorage.getItem('userName')); $('#userRoleBadge').text(sessionStorage.getItem('userRole')); $('#dashUser').text(sessionStorage.getItem('userName')); $('#dashRole').text(sessionStorage.getItem('userRole')); loadDashboardStats(); if(!sessionStorage.getItem('simas_last_state') && $('#btn-home').length) $('#btn-home').click(); }, 300); }); }
        function activateTab(t,e,cb){ $('.nav-link').removeClass('active'); if(e)$(e).addClass('active'); $('.tab-pane').removeClass('active'); $('#'+t).addClass('active'); if(t === 'home-content') loadDashboardStats(); if(cb)cb(); if(!['disposisi-container', 'arsip-masuk-container', 'arsip-keluar-container'].includes(t)) saveAppState(t, null); }

        function updateSidebarBadges() {
             fetch(`${GAS_URL}?action=get_dashboard_stats&email=${currentUserEmail}`).then(r=>r.json()).then(r => { if(r.status === 'success') { const d = r.data; updateBadge('#count-staf', d.inbox); updateBadge('#count-arsipku', d.arsipku); animateValue("dashInboxVal", parseInt($('#dashInboxVal').text())||0, d.inbox, 1000); animateValue("dashArsipVal", parseInt($('#dashArsipVal').text())||0, d.arsipku, 1000); animateValue("dashMasukVal", parseInt($('#dashMasukVal').text())||0, d.suratMasukMonth, 1000); } });
            const role = sessionStorage.getItem('userRole'); const perms = JSON.parse(sessionStorage.getItem('userPermissions')||"[]");
            if(role === 'Super Admin' || perms.some(p => p.startsWith('inbox_') && p !== 'inbox_staf')) {
                fetch(`${GAS_URL}?action=read_arsip_masuk&scope=all`).then(r=>r.json()).then(r => { if(r.status === 'success') { const counts = { direktur: 0, wadir_adm: 0, wadir_pel: 0, kabag_umum: 0, kabag_keuangan: 0, kabag_progpel: 0, kabid_yanmed: 0, kabid_penunjang: 0, kabid_keperawatan: 0 }; r.data.forEach(row => { if(row.status === 'Menunggu Disposisi') counts.direktur++; else if(row.status === 'Proses: Wadir') { const t = (row.tujuanDirektur || "").toLowerCase(); if(t.includes('umum') || t.includes('administrasi')) counts.wadir_adm++; else if(t.includes('pelayanan')) counts.wadir_pel++; } else if(row.status === 'Proses: Kabid') { const t = (row.tujuanWadir || "").toLowerCase(); if(t.includes('umum')) counts.kabag_umum++; else if(t.includes('keuang')) counts.kabag_keuangan++; else if(t.includes('program')) counts.kabag_progpel++; else if(t.includes('medik')) counts.kabid_yanmed++; else if(t.includes('penunjang')) counts.kabid_penunjang++; else if(t.includes('perawatan') || t.includes('kep')) counts.kabid_keperawatan++; } }); updateBadge('#count-direktur', counts.direktur); updateBadge('#count-wadir_adm', counts.wadir_adm); updateBadge('#count-wadir_pel', counts.wadir_pel); updateBadge('#count-kabag_umum', counts.kabag_umum); updateBadge('#count-kabag_keuangan', counts.kabag_keuangan); updateBadge('#count-kabag_progpel', counts.kabag_progpel); updateBadge('#count-kabid_yanmed', counts.kabid_yanmed); updateBadge('#count-kabid_penunjang', counts.kabid_penunjang); updateBadge('#count-kabid_keperawatan', counts.kabid_keperawatan); } });
            }
        }
        function updateBadge(selector, count) { const el = $(selector); el.text(count); if(count > 0) { el.addClass('has-data').css('display', 'inline-block'); } else { el.removeClass('has-data').hide(); } }
        function loadDashboardStats() {
            const now = new Date(); const hour = now.getHours(); let greeting = hour < 11 ? "Selamat Pagi" : hour < 15 ? "Selamat Siang" : hour < 18 ? "Selamat Sore" : "Selamat Malam";
            $('#dashGreeting').text(`${greeting}, ${sessionStorage.getItem('userName')}`); $('#dashUser').text(sessionStorage.getItem('userName')); $('#dashRole').text(sessionStorage.getItem('userRole')); $('#dashDate').text(now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })); updateSidebarBadges();
            fetch(`${GAS_URL}?action=get_dashboard_stats&email=${currentUserEmail}`).then(r=>r.json()).then(r => { if(r.status === 'success') renderDashboardChart(r.data.chartLabels, r.data.chartData); });
        }
        function animateValue(id, start, end, duration) { if (start === end) return; const range = end - start; let current = start; const increment = end > start ? 1 : -1; const stepTime = Math.abs(Math.floor(duration / range)); const obj = document.getElementById(id); const timer = setInterval(function() { current += increment; obj.innerHTML = current; if (current == end) clearInterval(timer); }, stepTime); }
        function renderDashboardChart(labels, data) { const ctx = document.getElementById('dashboardChart').getContext('2d'); if(dashboardChart) dashboardChart.destroy(); dashboardChart = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Surat Masuk', data: data, backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } } }); }
        function logout(){sessionStorage.clear();location.reload()}
        
        function handleCredentialResponse(r){ 
            showLoading(true); 
            fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'google_login',credential:r.credential})})
            .then(res=>res.json())
            .then(res=>{ 
                showLoading(false); 
                if(res.status==='success'){ 
                    sessionStorage.setItem('isLoggedIn','true'); sessionStorage.setItem('userEmail',res.data.email); sessionStorage.setItem('userRole',res.data.role); 
                    sessionStorage.setItem('userPermissions',JSON.stringify(res.data.permissions)); sessionStorage.setItem('userSubordinates',JSON.stringify(res.data.subordinates)); 
                    currentContextSubordinates = res.data.subordinates || []; sessionStorage.setItem('userDelegations', JSON.stringify(res.data.delegations || []));
                    sessionStorage.setItem('userName',res.data.name); sessionStorage.setItem('userBidang', res.data.bidang); sessionStorage.setItem('userJabatan', res.data.jabatan || "");
                    currentUserEmail=res.data.email; showApp(); renderSidebarPermissions(); loadRefCodes(); 
                    if(res.data.profileIncomplete) openUpdateProfileModal(res.data.email, res.data.name, true); updateSidebarBadges();
                } else { Swal.fire('Login Gagal',res.message,'error') } 
            }).catch(e=>{ showLoading(false); Swal.fire('Error Koneksi', 'Gagal terhubung ke server.\n1. Cek URL Deployment di Code.\n2. Pastikan Deploy sebagai "Anyone".', 'error') }) 
        }
        function openUpdateProfileModal(email, name, force=false) { $('#prof_email').val(email); $('#prof_nama').val(name); $('#prof_bidang').val(sessionStorage.getItem('userBidang') || ''); if(force) { $('#btnCancelProfile').hide(); new bootstrap.Modal(document.getElementById('modalUpdateProfile'), {backdrop: 'static', keyboard: false}).show(); } else { $('#btnCancelProfile').show(); new bootstrap.Modal(document.getElementById('modalUpdateProfile')).show(); } }
        function openMyProfile() { showLoading(true); fetch(`${GAS_URL}?action=get_my_profile&email=${currentUserEmail}`).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status === 'success') { $('#prof_email').val(r.data.email); $('#prof_nama').val(r.data.name); $('#prof_bidang').val(r.data.bidang); $('#prof_wa').val(r.data.wa); openUpdateProfileModal(r.data.email, r.data.name, false); } else { Swal.fire('Error', 'Gagal memuat profil', 'error'); } }); }
        $('#formUpdateProfile').on('submit', function(e){ e.preventDefault(); const d = { type: 'update_user_profile', email: $('#prof_email').val(), name: $('#prof_nama').val(), bidang: $('#prof_bidang').val(), wa: $('#prof_wa').val(), requestor: currentUserEmail }; showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status === 'success') { Swal.fire('Berhasil', 'Profil disimpan', 'success'); sessionStorage.setItem('userName', d.name); sessionStorage.setItem('userBidang', d.bidang); $('#userDisplayName').text(d.name); bootstrap.Modal.getInstance(document.getElementById('modalUpdateProfile')).hide(); } else { Swal.fire('Gagal', r.message, 'error'); } }); });
        
        function openArsipku(e) { activateTab('arsipku-container', e, loadArsipku); saveAppState('arsipku-container', null); }
        function loadArsipku() { showLoading(true); fetch(`${GAS_URL}?action=read_arsipku&email=${currentUserEmail}`).then(r => r.json()).then(r => { showLoading(false); const dt = $('#tableArsipku').DataTable({destroy: true, order: [[1, 'desc']]}); dt.clear(); if(r.data) r.data.forEach(d => { let perihalHtml = d.file ? `<a href="${d.file}" target="_blank" class="fw-bold text-decoration-none text-primary">${d.perihal} <i class="fas fa-paperclip text-muted small ms-1"></i></a>` : d.perihal; let aksi = `<button class="btn btn-sm btn-outline-info" onclick="viewHistory('${d.agenda}', '${d.file||""}', '${d.tglTerima}')"><i class="fas fa-eye"></i></button>`; dt.row.add([d.tglTerima, d.agenda, perihalHtml, d.pengirim, d.keterangan || '-', aksi]); }); dt.draw(); }).catch(e => { showLoading(false); Swal.fire('Error', 'Koneksi ke Arsipku Gagal', 'error'); }); }
        
        function openFinishModal(agenda) { $('#fd_agenda').val(agenda); $('#fd_note').val(''); new bootstrap.Modal(document.getElementById('modalFinishDisposition')).show(); }
        function submitFinishDisposition() { const agenda = $('#fd_agenda').val(); const note = $('#fd_note').val(); if(!note) return Swal.fire('Warning', 'Isi keterangan', 'warning'); bootstrap.Modal.getInstance(document.getElementById('modalFinishDisposition')).hide(); showLoading(true); const payload = { type: 'finish_disposition', agenda: agenda, email: currentUserEmail, note: note }; if(currentInboxContextEmail && currentInboxContextEmail !== currentUserEmail) payload.onBehalfOf = currentInboxContextEmail; fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json()).then(r => { showLoading(false); if(r.status === 'success') { Swal.fire('Sukses', 'Tugas diselesaikan.', 'success'); refreshCurrentDisposisi(); updateSidebarBadges(); } else { Swal.fire('Gagal', r.message, 'error'); } }); }
        
        function openDisposisiPage(l, e, overrideEmail = null, overrideName = null) {
            currentInboxLevel = l; currentInboxContextEmail = overrideEmail || currentUserEmail; currentInboxContextName = overrideName || "";
            if (overrideEmail && overrideEmail !== currentUserEmail) { currentContextSubordinates = []; fetch(`${GAS_URL}?action=get_my_profile&email=${overrideEmail}`).then(r=>r.json()).then(r=>{ if(r.status === 'success') currentContextSubordinates = r.data.subordinates || []; }); } else { currentContextSubordinates = JSON.parse(sessionStorage.getItem('userSubordinates') || "[]"); }
            let title = l.replace(/_/g, ' ').toUpperCase(); if (overrideName) { title += `: ${overrideName}`; $('#dispDelegationBanner').show(); } else { $('#dispDelegationBanner').hide(); } $('#dispPageTitle').text(title); activateTab('disposisi-container', e, refreshCurrentDisposisi); saveAppState('disposisi-container', l, currentInboxContextEmail, overrideName);
        }
        function refreshCurrentDisposisi(){ showLoading(true); fetch(`${GAS_URL}?action=read_inbox&level=${currentInboxLevel}&email=${currentInboxContextEmail}`).then(r=>r.json()).then(r=>{ showLoading(false); const dt=$('#tableDisposisi').DataTable({ destroy:true, language:{url:"//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json"}, order: [[ 1, 'desc' ]], autoWidth: false, columnDefs: [ { width: "1%", targets: [0, 1, 5] }, { width: "15%", targets: 2 }, { width: "25%", targets: 4 } ] }); dt.clear(); if(r.data) r.data.forEach(d=>{ let btnAction = `<div class="btn-group btn-group-sm"><button class="btn btn-outline-info" onclick="viewHistory('${d.agenda}', '${d.file||""}', '${d.tgl}')"><i class="fas fa-eye"></i></button>`; if(currentInboxLevel === 'staf') { btnAction += `<button class="btn btn-warning" data-id="${d.id}" data-perihal="${d.perihal.replace(/"/g, '&quot;')}" onclick="openDisposisiModal(this.dataset.id, this.dataset.perihal)"><i class="fas fa-share"></i></button><button class="btn btn-success" onclick="openFinishModal('${d.agenda}')"><i class="fas fa-check"></i></button>`; } else { btnAction += `<button class="btn btn-warning" data-id="${d.id}" data-perihal="${d.perihal.replace(/"/g, '&quot;')}" onclick="openDisposisiModal(this.dataset.id, this.dataset.perihal)">Proses</button>`; } btnAction += `</div>`; let perihalHtml = d.perihal; if(d.file) perihalHtml = `<a href="${d.file}" target="_blank" class="fw-bold text-decoration-none text-primary">${d.perihal} <i class="fas fa-paperclip small"></i></a>`; dt.row.add([ `<div class="text-nowrap">${d.tgl}</div>`, `<div class="text-nowrap fw-bold">${d.agenda}</div>`, `<div class="text-truncate" style="max-width: 150px;" title="${d.pengirim}">${d.pengirim}</div>`, perihalHtml, `<div class="small text-muted" style="max-height:60px; overflow-y:auto;">${d.instruksi || '-'}</div>`, btnAction ]); }); dt.draw(); updateSidebarBadges(); }).catch(e => { showLoading(false); Swal.fire('Error', 'Gagal memuat inbox. Cek koneksi.', 'error'); }); }
        
        function openArsipPage(t, s, e) { currentArsipScope = s; if(t==='masuk') { activateTab('arsip-masuk-container', e, loadArsipMasuk); saveAppState('arsip-masuk-container', s); } else { activateTab('arsip-keluar-container', e, loadArsipKeluar); saveAppState('arsip-keluar-container', s); } }
        
        function backupDatabase() { showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'get_backup_data', requestor: currentUserEmail }) }).then(r => r.json()).then(r => { showLoading(false); if (r.status === 'success') { const blob = new Blob([new Uint8Array(atob(r.data).split('').map(c => c.charCodeAt(0)))], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }); const a = document.createElement('a'); a.href = window.URL.createObjectURL(blob); a.download = `FULL_BACKUP_${new Date().toISOString().slice(0, 10)}.xlsx`; document.body.appendChild(a); a.click(); document.body.removeChild(a); Swal.fire('Berhasil', 'Backup didownload', 'success'); } else Swal.fire('Gagal', 'Hak akses ditolak.', 'error'); }).catch(e => { showLoading(false); Swal.fire('Error', 'Kesalahan jaringan', 'error'); }); }
        
        function renderSidebarPermissions(){ 
            const r=sessionStorage.getItem('userRole'); const p=JSON.parse(sessionStorage.getItem('userPermissions')||"[]"); const delegations = JSON.parse(sessionStorage.getItem('userDelegations')||"[]"); const userJabatan = sessionStorage.getItem('userJabatan'); 
            $('.restricted-feature').addClass('restricted-feature'); $('#btnArsipMasukParent').addClass('restricted-feature'); $('#btnArsipKeluarParent').addClass('restricted-feature'); $('#personalArsipContainer').empty();
            
            // AI Chat Button Logic
            if(r === 'Super Admin' || p.includes('chat_ai')) { $('.ai-chat-btn').removeClass('restricted-feature'); }

            const userFirstName = (sessionStorage.getItem('userName') || 'User').split(' ')[0];
            if (userJabatan && userJabatan !== "") { $('#btnInboxStaf').hide(); $('#btnArsipku').hide(); } else { $('#btnInboxStaf').show().html(`<i class="fas fa-inbox"></i> Inbox ${userFirstName} <span class="badge-count" id="count-staf">0</span>`); $('#btnArsipku').show().html(`<i class="fas fa-archive"></i> Arsip ${userFirstName} <span class="badge-count" id="count-arsipku">0</span>`); }
            let hasAnyArsipMasuk = false, hasAnyArsipKeluar = false; 
            if(r==='Super Admin'){ $('.restricted-feature').removeClass('restricted-feature'); $('#btnArsipMasukParent').removeClass('restricted-feature'); $('#btnArsipKeluarParent').removeClass('restricted-feature'); $('#btnInboxKabagParent').show(); hasAnyArsipKeluar = true; } 
            else { 
                if (userJabatan) { 
                    if (userJabatan.includes("Direktur")) { $('[data-perm="inbox_direktur"]').removeClass('restricted-feature'); $('[data-perm="arsip_masuk_direktur"]').removeClass('restricted-feature'); $('[data-perm="arsip_keluar_direktur"]').removeClass('restricted-feature'); }
                    if (userJabatan.includes("Wadir")) { $('[data-perm*="wadir"]').removeClass('restricted-feature'); }
                    if (userJabatan.includes("Kabag") || userJabatan.includes("Kabid")) { $('[data-perm*="kabag"], [data-perm*="kabid"]').each(function(){ if($(this).data('perm').includes(userJabatan.toLowerCase().replace(/kepala bagian|kabag/,'kabag').replace(/kepala bidang|kabid/,'kabid').split(' ')[1])) $(this).removeClass('restricted-feature'); }); }
                }
                p.forEach(x => { $(`[data-perm="${x}"]`).removeClass('restricted-feature'); if(x.includes('arsip_masuk')) hasAnyArsipMasuk = true; if(x.includes('arsip_keluar')) hasAnyArsipKeluar = true; }); 
                if(hasAnyArsipMasuk || userJabatan) $('#btnArsipMasukParent').removeClass('restricted-feature'); 
                if(hasAnyArsipKeluar || userJabatan) $('#btnArsipKeluarParent').removeClass('restricted-feature'); 
                if (!$('#subKabag .nav-link').not('.restricted-feature').length) $('#btnInboxKabagParent').hide(); else $('#btnInboxKabagParent').show();
            }
            if (!hasAnyArsipKeluar && !userJabatan) $('#personalArsipContainer').html(`<button class="nav-link w-100 text-start text-success" onclick="openArsipPage('keluar', 'personal:${sessionStorage.getItem('userName')}', this)"><i class="fas fa-archive"></i> Arsip Keluar ${userFirstName}</button>`);
            const delContainer = $('#delegationLinks'); delContainer.empty();
            if(delegations.length > 0) { $('#delegationMenuContainer').show(); delegations.forEach(user => { const dispName = user.name || user.email; const btn = $(`<button class="nav-link w-100 text-start text-warning"><i class="fas fa-user-check"></i> ${dispName}</button>`); btn.on('click', function() { openDisposisiPage('staf', this, user.email, dispName); }); delContainer.append(btn); }); } else { $('#delegationMenuContainer').hide(); }
        }
        
        function toggleManualPembuat(chk) { if(chk.checked) { $('#inputPembuatManual').show().focus().prop('required', true); } else { $('#inputPembuatManual').hide().prop('required', false).val(''); } }
        function openInputKeluar(e) { activateTab('input-keluar-content', e); autoFillAgendaKeluar(); renderPembuatList(); setDefaultDatesKeluar(); }
        function renderPembuatList() {
            const container = $('#containerPembuat'); if(container.find('.pembuat-item').length > 0) return;
            if(allUsersList.length === 0) { fetch(`${GAS_URL}?type=get_users_list`,{method:'POST',body:JSON.stringify({type:'get_users_list',requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{ if(r.status==='success') { allUsersList = r.data || []; populatePembuatCheckboxes(); } else container.html('<span class="text-danger">Gagal memuat daftar.</span>'); }); } else populatePembuatCheckboxes();
        }
        function populatePembuatCheckboxes() {
            const container = $('#containerPembuat'); container.empty();
            const units = ["Direktur", "Wadir Umum & Keuangan", "Wadir Pelayanan", "Bagian Administrasi & Umum", "Bagian Keuangan", "Bagian Program & Pelaporan", "Bidang Pelayanan Medik", "Bidang Pelayanan Penunjang", "Bidang Pelayanan Keperawatan"];
            container.append('<div class="fw-bold small text-primary mb-1 border-bottom">Struktural</div>'); units.forEach(u => container.append(`<div class="form-check pembuat-item"><input class="form-check-input chk-pembuat" type="checkbox" value="${u}"><label class="form-check-label small">${u}</label></div>`));
            container.append('<div class="fw-bold small text-success mt-2 mb-1 border-bottom">Personil</div>'); allUsersList.sort((a,b)=>a.name.localeCompare(b.name)).forEach(u => container.append(`<div class="form-check pembuat-item"><input class="form-check-input chk-pembuat" type="checkbox" value="${u.name}"><label class="form-check-label small">${u.name} <span class="text-muted">(${u.bidang||'-'})</span></label></div>`));
        }
        function filterPembuatList() { const term = $('#searchPembuat').val().toLowerCase(); $('#containerPembuat .pembuat-item').each(function() { $(this).toggle($(this).text().toLowerCase().includes(term)); }); }
        
        $('#formSuratKeluar').on('submit',async function(e){
            e.preventDefault(); showLoading(true); let f="",n=""; const fi=$('#fileSuratKeluar')[0].files[0]; if(fi){f=await readFile(fi);n=fi.name}
            let selected = []; $('.chk-pembuat:checked').each(function() { selected.push($(this).val()); });
            if($('#chkManualPembuat').is(':checked') && $('#inputPembuatManual').val().trim()) selected.push($('#inputPembuatManual').val().trim());
            const d={ type:'simpan_keluar', fileData:f, fileName:n, email:currentUserEmail, pembuat: selected.join(', ') || (sessionStorage.getItem('userName')||currentUserEmail) };
            $(this).serializeArray().forEach(x=>{ if(x.name !== 'pembuat') d[x.name]=x.value; });
            sendData(d,()=> { Swal.fire('OK','Tersimpan','success'); autoFillAgendaKeluar(); $('.chk-pembuat').prop('checked', false); $('#chkManualPembuat').prop('checked', false).trigger('change'); });
        });
        
        function loadArsipMasuk(){ showLoading(true); fetch(`${GAS_URL}?action=read_arsip_masuk&scope=${currentArsipScope}`).then(r=>r.json()).then(r=>{ showLoading(false); const dt=$('#tableArsipMasuk').DataTable({destroy:true, order:[[1,'desc']]}); dt.clear(); const perms = JSON.parse(sessionStorage.getItem('userPermissions')||"[]"); const role = sessionStorage.getItem('userRole'); const canEdit = role === 'Super Admin' || perms.includes('edit_surat_masuk'); const canEditDispo = role === 'Super Admin' || perms.includes('edit_tujuan_disposisi'); if(r.data) r.data.forEach(d=>{ let perihalHtml = d.file ? `<a href="${d.file}" target="_blank" class="fw-bold text-decoration-none text-primary">${d.perihal} <i class="fas fa-paperclip small"></i></a>` : d.perihal; let aksi = `<div class="d-flex gap-1"><button class="btn btn-sm btn-outline-dark" onclick="printDisposisi('${d.agenda}')"><i class="fas fa-print"></i></button><button class="btn btn-sm btn-outline-info" onclick="viewHistory('${d.agenda}', '${d.file||""}', '${d.tglTerima}')"><i class="fas fa-eye"></i></button>`; if(canEditDispo) aksi += `<button class="btn btn-sm btn-outline-danger" onclick='openEditDisposisi(${JSON.stringify(d)})'><i class="fas fa-link"></i></button>`; if(canEdit) aksi += `<button class="btn btn-sm btn-outline-warning" onclick='openEditMasuk(${JSON.stringify(d)})'><i class="fas fa-pencil-alt"></i></button>`; aksi += `</div>`; dt.row.add([d.tglTerima, d.agenda, d.pengirim, perihalHtml, d.status, aksi]); }); dt.draw(); }).catch(e=>{ showLoading(false); Swal.fire('Error','Gagal Load Arsip','error'); }); }
        
        function printDisposisi(agenda) { showLoading(true); fetch(`${GAS_URL}?action=print_disposisi&agenda=${agenda}`).then(r => r.json()).then(r => { showLoading(false); if (r.status === 'success') { const blob = new Blob([new Uint8Array(atob(r.base64).split('').map(c => c.charCodeAt(0)))], {type: 'application/pdf'}); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Disposisi_${agenda}.pdf`; document.body.appendChild(a); a.click(); document.body.removeChild(a); } else Swal.fire('Error', r.message, 'error'); }); }
        function viewHistory(agenda, fileUrl, tglTerima) { new bootstrap.Modal(document.getElementById('modalHistory')).show(); $('#historyLoading').show(); $('#historyContent').hide(); fetch(`${GAS_URL}?action=get_history_surat&agenda=${agenda}`).then(r => r.json()).then(r => { $('#historyLoading').hide(); if(r.status === 'success') { $('#historyContent').fadeIn(); $('#histPerihal').html(`<div>${r.data.perihal}</div><div class="small text-muted fw-normal mt-1">Tgl Surat: ${r.data.tglSurat}</div>`); let html = ''; let waText = `*DETAIL SURAT*\n📎 Link: ${fileUrl||'-'}\n📄 Perihal: ${r.data.perihal}\n📅 Tgl: ${r.data.tglSurat}\n📝 Ringkasan: ${r.data.ringkasan||'-'}\n\n*HISTORY:*\n`; r.data.history.forEach(h => { html += `<div class="timeline-item ${h.status}"><div class="timeline-date">${h.timestamp}</div><div class="timeline-content"><div class="fw-bold">${h.stage}</div><div class="text-primary small">${h.actor}</div><div class="small text-muted">${h.action}</div><div class="small fst-italic border-top pt-1 mt-1">${h.desc}</div></div></div>`; waText += `🔹 ${h.timestamp} - ${h.stage}\n   👤 ${h.actor}\n   ➡ ${h.action}\n   📝 ${h.desc}\n`; }); $('#timelineContainer').html(html); $('#btnShareWA').attr('href', `https://wa.me/?text=${encodeURIComponent(waText)}`).show(); } else $('#timelineContainer').html('<div class="text-danger">History tidak ditemukan.</div>'); }); }
        
        function openEditDisposisi(row) { $('#ed_agenda').val(row.agenda); const wadir = ["Wadir Umum & Keuangan", "Wadir Pelayanan"]; const kabid = ["Bagian Administrasi & Umum", "Bagian Keuangan", "Bagian Program & Pelaporan", "Bidang Pelayanan Medik", "Bidang Pelayanan Penunjang", "Bidang Pelayanan Keperawatan"]; generateCheckboxList('#box_ed_direktur', wadir, row.tujuanDirektur||''); generateCheckboxList('#box_ed_wadir', kabid, row.tujuanWadir||''); $('#val_ed_isi_direktur').val(row.isiDirektur||''); $('#val_ed_isi_wadir').val(row.isiWadir||''); $('#val_ed_isi_kabid').val(row.isiKabid||''); if(allUsersList.length > 0) generateCheckboxList('#box_ed_kabid', allUsersList.filter(u=>u.role==='User'), row.tujuanKabid||''); else fetch(`${GAS_URL}?type=get_users_list`,{method:'POST',body:JSON.stringify({type:'get_users_list',requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{ if(r.status==='success') { allUsersList = r.data||[]; generateCheckboxList('#box_ed_kabid', allUsersList.filter(u=>u.role==='User'), row.tujuanKabid||''); } }); new bootstrap.Modal(document.getElementById('modalEditDisposisi')).show(); }
        function generateCheckboxList(sel, items, valStr) { const c=$(sel); c.empty(); const vals=valStr.split(',').map(s=>s.trim()); items.forEach(i=>{ const v=typeof i==='object'?i.name:i; const d=typeof i==='object'?`${i.name} <small>(${i.bidang||'-'})</small>`:i; c.append(`<div class="form-check edit-dispo-item"><input class="form-check-input" type="checkbox" value="${v}" ${vals.includes(v)?'checked':''}><label class="form-check-label small">${d}</label></div>`); }); }
        function getCheckedValuesFromContainer(sel) { const s=[]; $(`${sel} input:checked`).each(function(){s.push($(this).val())}); return s.join(', '); }
        function filterEditDispoStaf(inp) { const t=inp.value.toLowerCase(); $('#box_ed_kabid .edit-dispo-item').each(function(){ $(this).toggle($(this).text().toLowerCase().includes(t)); }); }
        function saveEditDisposisi() { const d = { type: 'update_disposisi_tujuan', email: currentUserEmail, agenda: $('#ed_agenda').val(), tujuanDirektur: getCheckedValuesFromContainer('#box_ed_direktur'), tujuanWadir: getCheckedValuesFromContainer('#box_ed_wadir'), tujuanKabid: getCheckedValuesFromContainer('#box_ed_kabid'), isiDirektur: $('#val_ed_isi_direktur').val(), isiWadir: $('#val_ed_isi_wadir').val(), isiKabid: $('#val_ed_isi_kabid').val() }; bootstrap.Modal.getInstance(document.getElementById('modalEditDisposisi')).hide(); showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { Swal.fire('Sukses', 'Disposisi diperbarui', 'success'); loadArsipMasuk(); } else Swal.fire('Gagal', r.message, 'error'); }); }
        
        function loadArsipKeluar(){ showLoading(true); fetch(`${GAS_URL}?action=read_arsip_keluar&scope=${currentArsipScope}`).then(r=>r.json()).then(r=>{ showLoading(false); const dt=$('#tableArsipKeluar').DataTable({destroy:true, order:[[0,'desc']], autoWidth: false }); dt.clear(); const perms = JSON.parse(sessionStorage.getItem('userPermissions')||"[]"); const canEdit = sessionStorage.getItem('userRole') === 'Super Admin' || perms.includes('edit_surat_keluar'); const canApprove = sessionStorage.getItem('userRole') === 'Super Admin' || perms.includes('edit_status_approval'); if(r.data) r.data.forEach(d=>{ let statusHtml = d.status; if(canApprove) statusHtml = `<div class="d-flex justify-content-between align-items-center"><span>${d.status}</span><button class="btn btn-sm btn-link text-success p-0 ms-2" onclick='openStatusApproval(${d.agenda})'><i class="fas fa-pencil-alt"></i></button></div>`; let perihalHtml = d.file ? `<a href="${d.file}" target="_blank" class="text-decoration-none fw-bold text-dark">${d.perihal} <i class="fas fa-paperclip small"></i></a>` : d.perihal; let waText = `Agenda: ${d.agenda}\nPerihal: ${d.perihal}\nLink: ${d.file||'-'}${d.ringkasan&&d.ringkasan!=='-'?`\nRingkasan: ${d.ringkasan}`:''}`; let actionHtml = `<div class="d-flex justify-content-center"><a href="https://wa.me/?text=${encodeURIComponent(waText)}" target="_blank" class="btn btn-sm btn-success ms-1"><i class="fab fa-whatsapp"></i></a>${canEdit ? `<button class="btn btn-sm btn-warning ms-1" onclick='openEditKeluar(${JSON.stringify(d)})'><i class="fas fa-pencil-alt"></i></button>` : ''}</div>`; dt.row.add([d.agenda, d.tglSurat, d.tujuan, perihalHtml, d.pembuat||'-', statusHtml, actionHtml]); }); dt.draw(); }); }
        function openStatusApproval(agenda) {$('#esa_agenda').val(agenda);$('#esa_tanggal').val(new Date().toISOString().split('T')[0]);new bootstrap.Modal(document.getElementById('modalStatusApproval')).show();}
        function saveStatusApproval() {const d = {type: 'update_status_approval',email: currentUserEmail,agenda: $('#esa_agenda').val(),tanggal: $('#esa_tanggal').val()};bootstrap.Modal.getInstance(document.getElementById('modalStatusApproval')).hide();showLoading(true);fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success') { Swal.fire('Sukses', 'Status Updated', 'success'); loadArsipKeluar(); }else Swal.fire('Gagal', r.message, 'error');});}
        function openSettingTujuan() { if(allUsersList.length === 0) fetch(`${GAS_URL}?type=get_users_list`,{method:'POST',body:JSON.stringify({type:'get_users_list',requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{ if(r.status==='success') { allUsersList = r.data||[]; renderSettingTujuanList(); } }); else renderSettingTujuanList(); new bootstrap.Modal(document.getElementById('modalSettingTujuan')).show(); }
        function renderSettingTujuanList() { const c=$('#listSettingTujuan'); c.empty(); const mySubs = JSON.parse(sessionStorage.getItem('userSubordinates')||"[]"); allUsersList.forEach(u=>{ c.append(`<div class="user-list-item setting-tujuan-item"><input class="form-check-input me-3 st-check" type="checkbox" value="${u.name}" ${mySubs.includes(u.name)?'checked':''}><div><div class="fw-bold small text-dark">${u.name}</div><div class="text-muted" style="font-size:0.75rem">${u.bidang||'-'} | ${u.role}</div></div></div>`); }); }
        function saveSettingTujuan() { const s=[]; $('.st-check:checked').each(function(){s.push($(this).val())}); fetch(GAS_URL, {method:'POST', body:JSON.stringify({type: 'update_my_subordinates', email: currentUserEmail, subordinates: JSON.stringify(s)})}).then(r=>r.json()).then(r=>{ if(r.status==='success') { Swal.fire('Berhasil', 'Tujuan disimpan', 'success'); sessionStorage.setItem('userSubordinates', JSON.stringify(s)); currentContextSubordinates = s; bootstrap.Modal.getInstance(document.getElementById('modalSettingTujuan')).hide(); } }); }
        function filterSettingTujuan() { const t=$('#searchSettingTujuan').val().toLowerCase(); $('#listSettingTujuan .setting-tujuan-item').each(function(){ $(this).toggle($(this).text().toLowerCase().includes(t)); }); }
        function openDisposisiModal(id, p) { $('#dispIdSurat').val(id); $('#dispPerihal').text(p); $('#dispInstruksi').val(''); $('#dispTglDisposisi').val(new Date().toISOString().split('T')[0]); const c=$('#dispTargetContainer'); c.empty(); let t=[]; if(currentInboxLevel==='direktur') t=['Wadir Umum & Keuangan','Wadir Pelayanan']; else if(currentInboxLevel==='wadir_adm') t=['Bagian Administrasi & Umum','Bagian Keuangan','Bagian Program & Pelaporan']; else if(currentInboxLevel==='wadir_pel') t=['Bidang Pelayanan Medik','Bidang Pelayanan Penunjang','Bidang Pelayanan Keperawatan']; else if(currentContextSubordinates.length>0) t=currentContextSubordinates; if(t.length===0) c.html('<span class="text-muted small">Tidak ada tujuan. Gunakan Setting Tujuan.</span>'); else t.forEach(x=>{ c.append(`<div class="form-check"><input class="form-check-input target-check" type="checkbox" value="${x}"><label class="form-check-label small">${x}</label></div>`); }); new bootstrap.Modal(document.getElementById('modalDisposisi')).show(); }
        function submitDisposisi() { const s=[]; $('.target-check:checked').each(function(){s.push($(this).val())}); if(s.length===0) return Swal.fire('!','Pilih tujuan','warning'); const p={type:'submit_disposisi', idSurat:$('#dispIdSurat').val(), levelAsal:currentInboxLevel, target:s.join(', '), instruksi:$('#dispInstruksi').val(), tglDisposisi:$('#dispTglDisposisi').val(), sender:currentUserEmail, senderName:sessionStorage.getItem('userName')}; if(currentInboxContextEmail && currentInboxContextEmail !== currentUserEmail) { p.onBehalfOf=currentInboxContextEmail; p.onBehalfOfName=currentInboxContextName; } bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide(); showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify(p)}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { Swal.fire('OK','Terkirim','success'); refreshCurrentDisposisi(); updateSidebarBadges(); } else Swal.fire('Err',r.message,'error'); }); }
        
        function openAdvancedSearch(){ new bootstrap.Modal(document.getElementById('modalSearchAdvanced')).show(); }
        function submitSearchAdvanced(){ const d={type:'search_advanced', category:$('#sa_category').val(), keyword:$('#sa_keyword').val(), startDate:$('#sa_start').val(), endDate:$('#sa_end').val()}; bootstrap.Modal.getInstance(document.getElementById('modalSearchAdvanced')).hide(); showLoading(true); fetch(GAS_URL, {method:'POST', body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success'){ activateTab('search-content',null); const dt=$('#tableSearch').DataTable({destroy:true}); dt.clear(); r.data.results.forEach(d=>{ let perihalHtml = d.file ? `<a href="${d.file}" target="_blank" class="fw-bold text-decoration-none text-primary">${d.perihal}</a>` : d.perihal; dt.row.add([d.tgl, d.agenda, d.ref, perihalHtml, `<button class="btn btn-sm btn-outline-info" onclick="viewHistory('${d.agenda}', '${d.file||""}', '${d.tgl}')"><i class="fas fa-eye"></i></button>`]); }); dt.draw(); } }); }
        
        function loadRefCodes() {fetch(`${GAS_URL}?action=get_ref_codes`).then(r => r.json()).then(r => {if (r.status === 'success' && r.data) {$('#listKodeKlarifikasi').empty(); r.data.forEach(i => $('#listKodeKlarifikasi').append(`<option value="${i.code}">${i.desc}</option>`));}});}
        function openEditMasuk(row){ $('#em_noAgenda').val(row.agenda); $('#em_displayAgenda').val(row.agenda); $('#em_noSurat').val(row.noSurat); $('#em_tglSurat').val(formatDateInput(row.tglSurat)); $('#em_tglTerima').val(formatDateInput(row.tglTerima)); $('#em_pengirim').val(row.pengirim); $('#em_perihal').val(row.perihal); $('#em_kodeKlarifikasi').val(row.kode); $('#em_file').val(''); new bootstrap.Modal(document.getElementById('modalEditSuratMasuk')).show(); }
        function openEditKeluar(row){ $('#ek_noAgenda').val(row.agenda); $('#ek_displayAgenda').val(row.agenda); $('#ek_noSurat').val(row.noSurat); $('#ek_tglSurat').val(formatDateInput(row.tglSurat)); $('#ek_tujuan').val(row.tujuan); $('#ek_perihal').val(row.perihal); $('#ek_file').val(''); new bootstrap.Modal(document.getElementById('modalEditSuratKeluar')).show(); }
        async function saveEditMasuk(){const f=$('#em_file')[0].files[0]; let fd="",fn="";if(f){fd=await readFile(f);fn=f.name;}const d={type:'edit_surat_masuk', email:currentUserEmail, noAgenda:$('#em_noAgenda').val(), noSurat:$('#em_noSurat').val(), tglSurat:$('#em_tglSurat').val(), tglTerima:$('#em_tglTerima').val(), pengirim:$('#em_pengirim').val(), perihal:$('#em_perihal').val(), kodeKlarifikasi:$('#em_kodeKlarifikasi').val(), fileData:fd, fileName:fn}; bootstrap.Modal.getInstance(document.getElementById('modalEditSuratMasuk')).hide(); sendData(d, ()=>{Swal.fire('OK','Updated','success'); loadArsipMasuk();});}
        async function saveEditKeluar(){const f=$('#ek_file')[0].files[0]; let fd="",fn="";if(f){fd=await readFile(f);fn=f.name;}const d={type:'edit_surat_keluar', email:currentUserEmail, noAgenda:$('#ek_noAgenda').val(), noSurat:$('#ek_noSurat').val(), tglSurat:$('#ek_tglSurat').val(), tujuan:$('#ek_tujuan').val(), perihal:$('#ek_perihal').val(), fileData:fd, fileName:fn}; bootstrap.Modal.getInstance(document.getElementById('modalEditSuratKeluar')).hide(); sendData(d, ()=>{Swal.fire('OK','Updated','success'); loadArsipKeluar();});}
        function formatDateInput(d){if(!d||d==='-')return ''; const p=d.split('/'); return p.length===3?`${p[2]}-${p[1]}-${p[0]}`:'';}
        function loadUsers(){showLoading(true);fetch(`${GAS_URL}?type=get_users_list`,{method:'POST',body:JSON.stringify({type:'get_users_list',requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{showLoading(false);allUsersList=r.data||[]; const dt=$('#tableUsers').DataTable({destroy:true});dt.clear();if(r.data)r.data.forEach(u=>dt.row.add([u.email,u.name,u.role,u.status,`<button class="btn btn-sm btn-info" onclick='openEditUser(${JSON.stringify(u)})'>Edit</button>`]));dt.draw()});}
        function openEditUser(u){ $('#editUserEmail').val(u.email); $('#editUserName').val(u.name); $('#editUserRole').val(u.role); $('#editUserStatus').val(u.status); $('#editUserBidang').val(u.bidang||''); $('#editUserWA').val(u.wa||''); $('#editUserJabatan').val(u.jabatan||''); const isSuper=sessionStorage.getItem('userRole')==='Super Admin'; $('#editUserName, #editUserBidang, #editUserWA').prop('readonly', !isSuper); $('.perm-check').prop('checked',false); try{ JSON.parse(u.permissions).forEach(x=>$(`input[value="${x}"]`).prop('checked',true)) }catch(e){} $('#searchSubs, #searchDelegations').val(''); const ld=$('#listCandidates'); ld.empty(); const cs=JSON.parse(u.subordinates||"[]"); allUsersList.forEach(user=>{ if(user.email!==u.email) ld.append(`<div class="user-list-item"><input class="form-check-input me-2 sub-check" type="checkbox" value="${user.name}" ${cs.includes(user.name)?'checked':''}><div><div class="fw-bold small">${user.name}</div><div class="text-muted" style="font-size:0.75rem">${user.email}</div></div></div>`); }); const dd=$('#listDelegations'); dd.empty(); let cd=[]; try{ cd = typeof u.delegations === 'string' ? JSON.parse(u.delegations||"[]") : u.delegations; }catch(e){cd=[]} allUsersList.forEach(user=>{ if(user.email!==u.email) dd.append(`<div class="user-list-item delegation-item"><input class="form-check-input me-2 delegation-check" type="checkbox" value="${user.email}" ${cd.includes(user.email)?'checked':''}><div><div class="fw-bold small">${user.name}</div><div class="text-muted" style="font-size:0.75rem">${user.email}</div></div></div>`); }); renderPermissions(u); new bootstrap.Modal(document.getElementById('modalEditUser')).show(); }
        
        // MODIFIED: Tambahkan permission 'chat_ai'
        function renderPermissions(u){ const c=$('#permissionContainer'); c.empty(); const perms = [ {cat:"Input", items:[{v:"input_masuk",l:"Input Masuk"},{v:"input_keluar",l:"Input Keluar"}]}, {cat:"Inbox", items:[{v:"inbox_staf",l:"Inbox Staf"},{v:"inbox_direktur",l:"Direktur"},{v:"inbox_wadir_adm",l:"Wadir Umum"},{v:"inbox_wadir_pel",l:"Wadir Pel"},{v:"inbox_kabag_umum",l:"Kabag Umum"},{v:"inbox_kabag_keu",l:"Kabag Keu"},{v:"inbox_kabag_prog",l:"Kabag Prog"},{v:"inbox_kabid_yanmed",l:"Yanmed"},{v:"inbox_kabid_penunjang",l:"Penunjang"},{v:"inbox_kabid_kep",l:"Keperawatan"}]}, {cat:"Arsip Masuk", items:[{v:"arsip_masuk_all",l:"ALL"},{v:"arsip_masuk_direktur",l:"Direktur"}]}, {cat:"Arsip Keluar", items:[{v:"arsip_keluar_all",l:"ALL"},{v:"arsip_keluar_direktur",l:"Direktur"}]}, {cat:"Edit", items:[{v:"edit_surat_masuk",l:"Edit Masuk"},{v:"edit_surat_keluar",l:"Edit Keluar"},{v:"edit_tujuan_disposisi",l:"Edit Disposisi"},{v:"edit_status_approval",l:"Edit Approval"}]}, {cat:"Admin", items:[{v:"search_advanced",l:"Cari Adv"},{v:"edit_profil",l:"Edit Profil"},{v:"setting_user",l:"Setting User"}]}, {cat:"Fitur AI", items:[{v:"chat_ai",l:"Akses Chat AI"}]} ]; perms.forEach(grp=>{ c.append(`<div class="perm-category">${grp.cat}</div>`); grp.items.forEach(p=>{ const isChecked = u && u.permissions && JSON.parse(u.permissions).includes(p.v); c.append(`<div class="form-check"><input class="form-check-input perm-check" type="checkbox" value="${p.v}" ${isChecked?'checked':''}><label class="form-check-label">${p.l}</label></div>`); }); }); }
        
        function filterSubs() { const t=$('#searchSubs').val().toLowerCase(); $('#listCandidates .user-list-item').each(function(){ $(this).toggle($(this).text().toLowerCase().includes(t)); }); }
        function filterDelegations() { const t=$('#searchDelegations').val().toLowerCase(); $('#listDelegations .user-list-item').each(function(){ $(this).toggle($(this).text().toLowerCase().includes(t)); }); }
        function saveUserPermissions(){ const p=[]; $('.perm-check:checked').each(function(){p.push($(this).val())}); const sl=[]; $('.sub-check:checked').each(function(){sl.push($(this).val())}); const dl=[]; $('.delegation-check:checked').each(function(){dl.push($(this).val())}); const d={ type:'update_user_permissions', requestor:currentUserEmail, targetEmail:$('#editUserEmail').val(), role:$('#editUserRole').val(), status:$('#editUserStatus').val(), permissions:JSON.stringify(p), subordinates:JSON.stringify(sl), delegations:JSON.stringify(dl), name:$('#editUserName').val(), bidang:$('#editUserBidang').val(), wa:$('#editUserWA').val(), jabatan:$('#editUserJabatan').val() }; bootstrap.Modal.getInstance(document.getElementById('modalEditUser')).hide(); showLoading(true); fetch(GAS_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){Swal.fire('OK','Saved','success');loadUsers()}else Swal.fire('Err',r.message,'error')}); }
        function loadStorageStats(){showLoading(true);fetch(`${GAS_URL}?action=get_storage_stats&requestor=${currentUserEmail}`).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){const d=r.data;$('#disp-quota-A').text(d.nodeA.percentage+'%');$('#prog-A').css('width',d.nodeA.percentage+'%');$('#disp-quota-B').text(d.nodeB.percentage+'%');$('#prog-B').css('width',d.nodeB.percentage+'%');$('#disp-quota-C').text(d.nodeC.percentage+'%');$('#prog-C').css('width',d.nodeC.percentage+'%');$('#switchFailover').prop('checked',d.settings.failover);$('#selectActiveNode').val(d.settings.activeNode)}else Swal.fire('Akses Ditolak','Hanya Admin','warning')})}
        function saveStorageSettings(){const f=$('#switchFailover').is(':checked');const a=$('#selectActiveNode').val();showLoading(true);fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'update_storage_settings',failover:f,activeNode:a,requestor:currentUserEmail})}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success')Swal.fire('OK','Disimpan','success');else Swal.fire('Err',r.message,'error')})}
        function openSettingsPage(e){activateTab('settings-content',e,()=>{loadUsers();if(sessionStorage.getItem('userRole')!=='User')loadStorageStats()})}
        $('#formSuratMasuk').on('submit',async function(e){ e.preventDefault(); const ts=new Date($('input[name="tglSurat"]').val()); const tt=new Date($('input[name="tglTerima"]').val()); if(ts>tt) return Swal.fire('Error','Tgl Surat > Tgl Terima','warning'); showLoading(true); let f="",n=""; const fi=$('#fileSuratMasuk')[0].files[0]; if(fi){f=await readFile(fi);n=fi.name} const d={type:'simpan_masuk',fileData:f,fileName:n,email:currentUserEmail}; $(this).serializeArray().forEach(x=>d[x.name]=x.value); sendData(d,()=>{ Swal.fire('OK','Masuk Tersimpan','success'); autoFillAgendaMasuk(); }); });
        function sendData(d,cb){fetch(GAS_URL,{method:'POST',body:JSON.stringify(d)}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){cb();$('form').trigger('reset'); setDefaultDatesMasuk();}else Swal.fire('Err',r.message,'error')}).catch(e=>{showLoading(false);Swal.fire('Error','Gagal Kirim Data. Cek URL.','error')})}
        function readFile(f){return new Promise((resolve,reject)=>{if(f.type.match(/image.*/)){const r=new FileReader();r.readAsDataURL(f);r.onload=(e)=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');const mw=1024;let w=i.width;let h=i.height;if(w>mw){h=Math.round(h*(mw/w));w=mw;}c.width=w;c.height=h;const x=c.getContext('2d');x.drawImage(i,0,0,w,h);resolve(c.toDataURL('image/jpeg',0.7));}};r.onerror=reject;}else{const r=new FileReader();r.readAsDataURL(f);r.onload=()=>resolve(r.result);r.onerror=reject;}});}
        function autoFillAgendaMasuk(){$('#inNoAgenda').val('...'); fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'get_last_agenda_masuk'})}).then(r=>r.json()).then(r=>{if(r.status==='success')$('#inNoAgenda').val(r.data.nextAgenda)});}
        function autoFillAgendaKeluar(){$('#outNoAgenda').val('...'); fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'get_last_agenda_keluar'})}).then(r=>r.json()).then(r=>{if(r.status==='success')$('#outNoAgenda').val(r.data.nextAgenda)});}
        function openBookingModal(c){$('#bookingCategory').val(c);$('#modalBooking .modal-title').text(c==='keluar'?'Booking Keluar':'Booking Masuk');new bootstrap.Modal(document.getElementById('modalBooking')).show();$('#lastAgendaDisplay').text('...');$('#bookingValue').val('');fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:c==='keluar'?'get_last_agenda_keluar':'get_last_agenda_masuk'})}).then(r=>r.json()).then(r=>{if(r.status==='success')$('#lastAgendaDisplay').text(r.data.lastAgenda>0?r.data.lastAgenda:'-');$('#bookingValue').val(r.data.nextAgenda)});}
        function applyBooking(){const v=$('#bookingValue').val();const c=$('#bookingCategory').val();if(v){if(c==='keluar')$('#outNoAgenda').val(v);else $('#inNoAgenda').val(v);bootstrap.Modal.getInstance(document.getElementById('modalBooking')).hide();}}
        function saveBooking(){const v=$('#bookingValue').val();const c=$('#bookingCategory').val();const n=$('#bookingNote').val();if(!v)return Swal.fire('!','Isi Nomor','warning');bootstrap.Modal.getInstance(document.getElementById('modalBooking')).hide();showLoading(true);fetch(GAS_URL,{method:'POST',body:JSON.stringify({type:'booking_agenda',category:c,targetAgenda:v,email:currentUserEmail,note:n})}).then(r=>r.json()).then(r=>{showLoading(false);if(r.status==='success'){Swal.fire('OK',r.data.message,'success');if(c==='keluar')autoFillAgendaKeluar();else autoFillAgendaMasuk();}else Swal.fire('Gagal',r.message,'error')});}
        function setDefaultDatesMasuk(){const t=new Date().toISOString().split('T')[0];if(!$('input[name="tglSurat"]').val())$('input[name="tglSurat"]').val(t);if(!$('input[name="tglTerima"]').val())$('input[name="tglTerima"]').val(t);}
        function setDefaultDatesKeluar(){const t=new Date().toISOString().split('T')[0];if(!$('#sk_tglSurat').val())$('#sk_tglSurat').val(t);}

        // AI FUNCTIONS
        async function callGeminiAPI(prompt, img=null){
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'ai_task', prompt: prompt, image: img }) });
                const r = await res.json();
                if (r.status === 'success') return r.data.text;
                throw new Error(r.message || "AI Error");
            } catch (e) {
                console.error("AI Error:", e);
                Swal.fire('AI Gagal', 'Pastikan URL Backend benar & Quota tersedia.', 'error');
                return null;
            }
        }

        async function aiSuggestDisposition() {
            const p = $('#dispPerihal').text(); if (!p || p === '...') return Swal.fire('Info', 'Perihal belum dimuat.', 'info');
            const btn = event.currentTarget; const org = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            const res = await callGeminiAPI(`Saya ${sessionStorage.getItem('userRole')}. Surat perihal: "${p}". Buatkan instruksi disposisi singkat & tegas (1 kalimat).`);
            if (res) { const c = $('#dispInstruksi').val(); $('#dispInstruksi').val(c ? c + " " + res.trim() : res.trim()); }
            btn.innerHTML = org; btn.disabled = false;
        }

        async function aiRefinePerihal() {
            const t = $('#outPerihal').val(); if (!t || t.length < 3) return Swal.fire('Info', 'Ketik draft dulu.', 'info');
            const btn = event.currentTarget; const org = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled = true;
            const res = await callGeminiAPI(`Ubah ke bahasa surat dinas resmi RSUD (baku, formal): "${t}". Hanya hasil revisi.`);
            if (res) $('#outPerihal').val(res.trim());
            btn.innerHTML = org; btn.disabled = false;
        }

        async function autoFillSuratMasuk() {
            const f = document.getElementById('fileSuratMasuk').files[0]; if (!f) return Swal.fire('Info', 'Pilih file dulu.', 'info');
            const btn = event.currentTarget; const org = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membaca...'; btn.disabled = true;
            try {
                let img = null;
                if (f.type === 'application/pdf') {
                    const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                    const page = await pdf.getPage(1);
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const vp = page.getViewport({ scale: 1.5 }); cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({ canvasContext: ctx, viewport: vp }).promise;
                    img = cvs.toDataURL('image/jpeg', 0.8);
                } else if (f.type.match(/image.*/)) { img = await readFile(f); } else throw new Error("Format salah");

                const res = await callGeminiAPI(`Analisa gambar surat ini. Ekstrak ke JSON valid: {"no_surat": "...", "tgl_surat": "YYYY-MM-DD", "pengirim": "...", "perihal": "...", "ringkasan": "..."}. Tgl harus YYYY-MM-DD.`, img);
                if (res) {
                    const d = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    if (d.no_surat) $('#sm_noSurat').val(d.no_surat);
                    if (d.tgl_surat) $('#sm_tglSurat').val(d.tgl_surat);
                    if (d.pengirim) $('#sm_pengirim').val(d.pengirim);
                    if (d.perihal) $('#sm_perihal').val(d.perihal);
                    if (d.ringkasan) { $('#sm_ringkasan').val(d.ringkasan); $('#divRingkasanMasuk').slideDown(); }
                    Swal.fire('Selesai', 'Data diekstrak.', 'success');
                }
            } catch (e) { Swal.fire('Gagal', 'Tidak dapat membaca file.', 'error'); }
            btn.innerHTML = org; btn.disabled = false;
        }

        async function autoFillSuratKeluar() {
            const f = document.getElementById('fileSuratKeluar').files[0]; if (!f) return Swal.fire('Info', 'Pilih file dulu.', 'info');
            const btn = event.currentTarget; const org = btn.innerHTML; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Membaca...'; btn.disabled = true;
            try {
                let img = null;
                if (f.type === 'application/pdf') {
                    const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                    const page = await pdf.getPage(1);
                    const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                    const vp = page.getViewport({ scale: 1.5 }); cvs.width = vp.width; cvs.height = vp.height;
                    await page.render({ canvasContext: ctx, viewport: vp }).promise;
                    img = cvs.toDataURL('image/jpeg', 0.8);
                } else if (f.type.match(/image.*/)) { img = await readFile(f); } else throw new Error("Format salah");

                const res = await callGeminiAPI(`Analisa surat keluar ini. Ekstrak ke JSON: {"tujuan": "...", "perihal": "...", "tgl_surat": "YYYY-MM-DD", "format_nomor": "ambil nomor surat lengkap termasuk bagian kosong/titik", "ringkasan": "..."}`, img);
                if (res) {
                    const d = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    if (d.tgl_surat) $('#sk_tglSurat').val(d.tgl_surat);
                    if (d.tujuan) $('#sk_tujuan').val(d.tujuan);
                    if (d.perihal) $('#outPerihal').val(d.perihal);
                    if (d.ringkasan) { $('#sk_ringkasan').val(d.ringkasan); $('#divRingkasanKeluar').slideDown(); }
                    if (d.format_nomor) $('#sk_noSurat').val(d.format_nomor.replace(/\/[\s\.]*\//, `/${$('#outNoAgenda').val()}/`));
                    Swal.fire('Selesai', 'Data diekstrak.', 'success');
                }
            } catch (e) { Swal.fire('Gagal', 'Tidak dapat membaca file.', 'error'); }
            btn.innerHTML = org; btn.disabled = false;
        }

        // ==========================================
        // FITUR CHAT AI (DATABASE)
        // ==========================================

        function toggleAIChat() {
            const win = $('#aiChatWindow');
            if(win.is(':visible')) { win.fadeOut(); } else { win.css('display','flex').fadeIn(); $('#aiInput').focus(); }
        }

        function handleAiEnter(e) { if(e.key === 'Enter') sendAiMessage(); }

        async function sendAiMessage() {
            const input = $('#aiInput');
            const msg = input.val().trim();
            if(!msg) return;

            // 1. Tambahkan pesan user ke UI
            addAiMessage(msg, 'user');
            input.val('');
            $('#aiTyping').show();
            
            try {
                // 2. Kirim ke Backend (Simas30.gs)
                const payload = {
                    type: 'ai_chat_database',
                    prompt: msg,
                    email: currentUserEmail
                };
                
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                $('#aiTyping').hide();

                if(result.status === 'success') {
                    addAiMessage(result.data, 'bot');
                } else {
                    addAiMessage("Maaf, terjadi kesalahan saat menghubungi AI: " + result.message, 'bot');
                }

            } catch(e) {
                $('#aiTyping').hide();
                addAiMessage("Error koneksi jaringan.", 'bot');
            }
        }

        function addAiMessage(text, sender) {
            const container = $('#aiMessages');
            // Render Markdown jika bot
            let content = text;
            if(sender === 'bot') {
                content = marked.parse(text); // Gunakan library marked.js
            }
            
            const div = $(`<div class="ai-msg ${sender} ai-markdown">${content}</div>`);
            container.append(div);
            
            // Auto scroll ke bawah
            container.scrollTop(container[0].scrollHeight);
        }
    </script>
</body>
</html>
