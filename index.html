<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #10b981;
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #0f172a 100%); /* Emerald to Dark Blue */
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Utility */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        /* --- LOGIN SECTION --- */
        #loginSection {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            color: white;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 12px;
        }
        
        .form-control:focus {
            background: #fff;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.25); /* Emerald Glow */
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent));
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        /* --- DASHBOARD LAYOUT (PC Sidebar) --- */
        #appContent {
            display: none;
            min-height: 100vh;
        }

        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }

        /* Sidebar Styling */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.3); /* Darker glass for sidebar */
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            color: #fff;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            z-index: 999;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--glass-border);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul li {
            padding: 10px 20px;
        }

        /* Custom Nav Pills inside Sidebar */
        .nav-pills .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 8px;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-pills .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--emerald-accent), transparent);
            color: #fff;
            border-left: 4px solid #fff;
        }

        .nav-link i {
            width: 25px;
            margin-right: 10px;
        }

        .sidebar-divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 10px 0;
        }
        
        .sidebar-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            margin-top: 15px;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        /* Content Styling */
        #content {
            width: 100%;
            padding: 20px;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
        }

        /* Card & Table Customization */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
            margin-bottom: 25px;
        }

        .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid var(--glass-border);
            color: var(--emerald-accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Form Container Limit */
        .form-container-limit {
            max-width: 900px;
            margin: 0 auto;
        }

        /* DataTables Customization for Dark Theme */
        table.dataTable tbody tr {
            background-color: transparent !important;
            color: white !important;
        }
        
        .table {
            color: white !important;
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255,255,255,0.05);
            --bs-table-hover-bg: rgba(16, 185, 129, 0.2);
            --bs-table-border-color: rgba(255,255,255,0.2);
        }

        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            color: #ccc !important;
        }

        .page-link {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .page-item.active .page-link {
            background-color: var(--emerald-accent);
            border-color: var(--emerald-accent);
        }

        /* Modal Customization */
        .modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            border: 1px solid var(--glass-border);
        }
        .modal-header, .modal-footer {
            border-color: rgba(255,255,255,0.1);
        }

        /* Responsive Behavior */
        @media (max-width: 991.98px) {
            #sidebar {
                position: relative;
                height: auto;
                min-width: 100%;
                max-width: 100%;
            }
            #content {
                margin-left: 0;
            }
            .nav-pills {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .nav-pills .nav-link {
                white-space: nowrap;
                margin-right: 10px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .nav-pills .nav-link.active {
                background: none;
                border-left: none;
                border-bottom: 3px solid var(--emerald-accent);
            }
        }

        /* Loading Overlay Fix */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <div id="loginSection">
        <div class="glass-panel login-card text-center">
            <div class="mb-4">
                <div class="bg-white rounded-circle d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-hospital-user fa-3x" style="color: var(--emerald-accent);"></i>
                </div>
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Manajemen Persuratan RSUD</p>
            </div>
            
            <form id="formLogin">
                <div class="mb-4 text-start">
                    <label class="form-label small text-uppercase fw-bold text-white-50">Password Admin</label>
                    <div class="input-group">
                        <span class="input-group-text border-0" style="background: rgba(255,255,255,0.8);"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Masukkan Kode Akses" required>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary shadow-lg">
                        MASUK APLIKASI <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <small class="text-white-50">RSUD dr. R. Koesma &copy; 2024</small>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent">
        <div class="wrapper">
            
            <!-- SIDEBAR -->
            <nav id="sidebar">
                <div class="sidebar-header text-center">
                    <i class="fas fa-hospital-alt fa-2x mb-2 text-white"></i>
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50">Administrator Panel</small>
                </div>

                <div class="p-3">
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-outline-light btn-sm" onclick="showChangePassword()">
                            <i class="fas fa-key me-2"></i> Ganti Password
                        </button>
                    </div>

                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        
                        <div class="sidebar-label">Pencatatan</div>
                        
                        <button class="nav-link active" id="nav-input-masuk" data-bs-toggle="pill" data-bs-target="#input-masuk-content" type="button" role="tab">
                            <i class="fas fa-plus-circle"></i> Surat Masuk
                        </button>
                        
                        <button class="nav-link" id="nav-input-keluar" data-bs-toggle="pill" data-bs-target="#input-keluar-content" type="button" role="tab">
                            <i class="fas fa-paper-plane"></i> Surat Keluar
                        </button>

                        <button class="nav-link text-warning" id="nav-disposisi" data-bs-toggle="pill" data-bs-target="#disposisi-content" type="button" role="tab" onclick="loadDataDisposisiPending()">
                            <i class="fas fa-tasks"></i> Disposisi <span class="badge bg-danger ms-auto small" id="badgePending" style="display:none">!</span>
                        </button>

                        <div class="sidebar-divider"></div>
                        <div class="sidebar-label">Arsip & Data</div>

                        <button class="nav-link" id="nav-arsip-masuk" data-bs-toggle="pill" data-bs-target="#arsip-masuk-content" type="button" role="tab" onclick="loadDataMasuk()">
                            <i class="fas fa-inbox"></i> Arsip Masuk
                        </button>
                        
                        <button class="nav-link" id="nav-arsip-keluar" data-bs-toggle="pill" data-bs-target="#arsip-keluar-content" type="button" role="tab" onclick="loadDataKeluar()">
                            <i class="fas fa-archive"></i> Arsip Keluar
                        </button>

                    </div>
                </div>

                <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
                    <button class="btn btn-danger w-100 btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i> Keluar
                    </button>
                </div>
            </nav>

            <!-- PAGE CONTENT -->
            <div id="content">
                
                <!-- Tab Content Container -->
                <div class="tab-content" id="v-pills-tabContent">
                    
                    <!-- 1. FORM SURAT MASUK (TANPA DISPOSISI) -->
                    <div class="tab-pane fade show active" id="input-masuk-content" role="tabpanel">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-info">Surat Masuk Baru</b></h2>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-pen-fancy me-2"></i>Formulir Agenda Surat Masuk</div>
                                <div class="card-body p-4">
                                    <form id="formSuratMasuk">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">No. Agenda</label>
                                                <input type="text" class="form-control" name="noAgenda" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">Tanggal Terima</label>
                                                <input type="date" class="form-control" name="tglTerima" required>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">No. Surat</label>
                                            <input type="text" class="form-control" name="noSurat" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Pengirim</label>
                                            <input type="text" class="form-control" name="pengirim" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="3" required></textarea>
                                        </div>
                                        
                                        <div class="alert alert-info bg-opacity-10 border-0 text-white small">
                                            <i class="fas fa-info-circle me-2"></i> Surat akan disimpan dengan status <b>"Menunggu Disposisi"</b>. Pimpinan dapat memberikan disposisi melalui menu <i>Disposisi</i>.
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label text-white-50 small">Scan Dokumen (PDF/Img)</label>
                                            <input type="file" class="form-control" id="fileSuratMasuk" accept=".pdf, .jpg, .jpeg, .png">
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Simpan Surat Masuk</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. FORM SURAT KELUAR -->
                    <div class="tab-pane fade" id="input-keluar-content" role="tabpanel">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-success">Surat Keluar Baru</b></h2>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-paper-plane me-2"></i>Formulir Registrasi Surat Keluar</div>
                                <div class="card-body p-4">
                                    <form id="formSuratKeluar">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">No. Surat</label>
                                                <input type="text" class="form-control" name="noSurat" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">Tanggal Surat</label>
                                                <input type="date" class="form-control" name="tglSurat" required>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Tujuan</label>
                                            <input type="text" class="form-control" name="tujuan" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="3" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Pembuat / Bagian</label>
                                            <input type="text" class="form-control" name="pembuat" placeholder="Contoh: Bagian Umum">
                                        </div>
                                        <div class="mb-4">
                                            <label class="form-label text-white-50 small">File Arsip</label>
                                            <input type="file" class="form-control" id="fileSuratKeluar" accept=".pdf, .jpg, .jpeg, .png">
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Simpan Surat Keluar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. HALAMAN DISPOSISI PENDING (BARU) -->
                    <div class="tab-pane fade" id="disposisi-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Antrian <b class="text-warning">Disposisi Surat</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataDisposisiPending()"><i class="fas fa-sync-alt me-2"></i>Refresh</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableDisposisi" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="10%">Tanggal</th>
                                                <th width="10%">Agenda</th>
                                                <th width="20%">Pengirim</th>
                                                <th width="35%">Perihal</th>
                                                <th width="10%">File</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. ARSIP SURAT MASUK -->
                    <div class="tab-pane fade" id="arsip-masuk-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-info">Surat Masuk</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableMasuk" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="10%">Tanggal</th>
                                                <th width="10%">Agenda</th>
                                                <th width="15%">Pengirim</th>
                                                <th width="20%">Disposisi</th>
                                                <th width="30%">Perihal</th>
                                                <th width="10%">Status</th>
                                                <th width="5%">File</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. ARSIP SURAT KELUAR -->
                    <div class="tab-pane fade" id="arsip-keluar-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-success">Surat Keluar</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableKeluar" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="15%">Tgl Surat</th>
                                                <th width="15%">No. Surat</th>
                                                <th width="20%">Tujuan</th>
                                                <th width="40%">Perihal</th>
                                                <th width="10%">File</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- End Tab Content -->
            </div> <!-- End Page Content -->
        </div> <!-- End Wrapper -->
    </div> <!-- End appContent -->

    <!-- MODAL DISPOSISI -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Proses Disposisi Pimpinan</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDisposisi">
                        <input type="hidden" id="dispNoAgenda" name="noAgenda">
                        <input type="hidden" id="dispNoSurat" name="noSurat">
                        
                        <div class="alert alert-secondary text-white small mb-3">
                            <strong>Perihal:</strong> <span id="dispPerihalReview"></span><br>
                            <strong>Pengirim:</strong> <span id="dispPengirimReview"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label small">Level 1: Wadir</label>
                                <select class="form-control form-select" id="disposisiWadir" name="disposisiWadir" required>
                                    <option value="" selected disabled>Pilih Wadir...</option>
                                    <option value="Wadir Pelayanan">Wakil Direktur Pelayanan</option>
                                    <option value="Wadir Admin & Keuangan">Wakil Direktur Admin & Keuangan</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label small">Level 2: Bidang/Bagian</label>
                                <select class="form-control form-select" id="disposisiBidang" name="disposisiBidang" required disabled>
                                    <option value="" selected disabled>-- Menunggu Pilihan Wadir --</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label small">Isi Instruksi</label>
                            <textarea class="form-control" name="isiDisposisi" rows="3" placeholder="Tuliskan instruksi..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Tgl Disposisi</label>
                            <input type="date" class="form-control" name="tglDisposisi" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="submitDisposisi()">Simpan Disposisi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status"></div>
        <div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ================= CONFIGURATION =================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        // ================================================

        // === Cascading Dropdown Logic ===
        const structureOrg = {
            "Wadir Pelayanan": [
                "Bidang Pelayanan Medis",
                "Bidang Keperawatan",
                "Bidang Penunjang Medis"
            ],
            "Wadir Admin & Keuangan": [
                "Bagian Tata Usaha",
                "Bagian Keuangan & Akuntansi",
                "Bagian Perencanaan & Program"
            ]
        };

        $(document).ready(function() {
            // Check Session Login
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
            }

            // Handle Login Submit
            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                
                showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'login', password: pass })
                })
                .then(res => res.json())
                .then(res => {
                    showLoading(false);
                    if (res.status === 'success') {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        showApp();
                    } else {
                        Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: res.message });
                    }
                })
                .catch(err => {
                    showLoading(false);
                    Swal.fire({ icon: 'error', title: 'Koneksi Gagal', text: 'Tidak dapat terhubung ke server' });
                });
            });

            // Initialize DataTables
            const dtConfig = {
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "order": [[ 0, "desc" ]],
                "pageLength": 10,
                "lengthMenu": [10, 25, 50, 100],
                "autoWidth": false
            };
            
            const dtMasuk = $('#tableMasuk').DataTable(dtConfig);
            const dtKeluar = $('#tableKeluar').DataTable(dtConfig);
            const dtDisposisi = $('#tableDisposisi').DataTable(dtConfig);

            // Handler Dropdown Wadir Change (Modal)
            $('#disposisiWadir').change(function() {
                const wadir = $(this).val();
                const bidangSelect = $('#disposisiBidang');
                
                bidangSelect.empty().append('<option value="" selected disabled>Pilih Bagian/Bidang...</option>');
                
                if (wadir && structureOrg[wadir]) {
                    structureOrg[wadir].forEach(function(bidang) {
                        bidangSelect.append(new Option(bidang, bidang));
                    });
                    bidangSelect.prop('disabled', false);
                } else {
                    bidangSelect.prop('disabled', true);
                }
            });

            // === Handle Form Submit Surat Masuk (Tanpa Disposisi) ===
            $('#formSuratMasuk').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratMasuk');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_masuk",
                    noAgenda: $('input[name="noAgenda"]').val(),
                    noSurat: $('input[name="noSurat"]').val(),
                    tglTerima: $('input[name="tglTerima"]').val(),
                    pengirim: $('input[name="pengirim"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratMasuk')[0].reset();
                    Swal.fire('Tersimpan', 'Surat masuk berhasil dicatat. Status: Menunggu Disposisi', 'success');
                });
            });

            // === Handle Form Submit Surat Keluar ===
            $('#formSuratKeluar').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratKeluar');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_keluar",
                    noSurat: $('input[name="noSurat"]').val(),
                    tglSurat: $('input[name="tglSurat"]').val(),
                    tujuan: $('input[name="tujuan"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    pembuat: $('input[name="pembuat"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratKeluar')[0].reset();
                });
            });
        });

        // ================= FUNCTIONS =================

        function showApp() {
            $('#loginSection').fadeOut(300, function() {
                $('#appContent').fadeIn(300);
                // Load data awal jika perlu
            });
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: "Anda yakin ingin keluar?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Keluar!',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('isLoggedIn');
                    location.reload();
                }
            })
        }

        function showChangePassword() {
            Swal.fire({
                title: 'Ganti Password Admin',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Password Lama">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Password Baru">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                background: '#1e293b',
                color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [oldPass, newPass] = result.value;
                    if(!oldPass || !newPass) return;

                    showLoading(true);
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ type: 'change_password', oldPassword: oldPass, newPassword: newPass })
                    })
                    .then(res => res.json())
                    .then(res => {
                        showLoading(false);
                        if (res.status === 'success') {
                            Swal.fire({ title: 'Sukses', text: 'Password berhasil diubah', icon: 'success' });
                        } else {
                            Swal.fire({ title: 'Gagal', text: res.message, icon: 'error' });
                        }
                    });
                }
            })
        }

        function sendData(data, callback) {
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    if (callback) callback();
                    else Swal.fire({ title: 'Berhasil!', text: 'Data telah disimpan.', icon: 'success' });
                } else {
                    Swal.fire({ title: 'Gagal', text: result.message, icon: 'error' });
                }
            })
            .catch(error => {
                showLoading(false);
                Swal.fire({ title: 'Error', text: 'Terjadi kesalahan koneksi.', icon: 'error' });
            });
        }

        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableMasuk').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            // Row: [Ts, Agenda, NoSurat, TglTerima, Pengirim, Perihal, Link, Wadir, Bidang, Isi, TglDisp, Status]
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info" title="Lihat"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            
                            // Status Badge
                            let statusBadge = row[11] === 'Terdisposisi' 
                                ? `<span class="badge bg-success">Selesai</span>` 
                                : `<span class="badge bg-warning text-dark">Menunggu</span>`;
                            
                            // Disposisi Content
                            let dispContent = '-';
                            if(row[11] === 'Terdisposisi') {
                                dispContent = `<div class="d-flex flex-column">
                                    <span class="fw-bold text-info">${row[7]}</span>
                                    <span class="small text-white-50">${row[8]}</span>
                                    <div class="mt-1 small text-warning fst-italic"><i class="fas fa-comment me-1"></i> "${row[9]}"</div>
                                </div>`;
                            }

                            dt.row.add([
                                tgl,
                                `<span class="badge bg-secondary">${row[1]}</span>`,
                                row[4], // Pengirim
                                dispContent,
                                row[5], // Perihal
                                statusBadge,
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                });
        }

        function loadDataDisposisiPending() {
            fetch(`${GAS_URL}?action=read_pending`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableDisposisi').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        $('#badgePending').text(res.data.length).show(); // Update badge count
                        
                        res.data.forEach(row => {
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info" title="Lihat"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            
                            // Tombol Proses: Kirim data row ke fungsi open modal
                            // Kita kirim No Agenda (row[1]), No Surat (row[2]), Pengirim (row[4]), Perihal (row[5])
                            let btnProses = `<button class="btn btn-sm btn-warning text-dark fw-bold" onclick="openModalDisposisi('${row[1]}', '${row[2]}', '${row[4]}', '${row[5]}')">
                                <i class="fas fa-edit me-1"></i> Proses
                            </button>`;

                            dt.row.add([
                                tgl,
                                row[1],
                                row[4],
                                row[5],
                                btnFile,
                                btnProses
                            ]);
                        });
                        dt.draw();
                    } else {
                        $('#badgePending').hide();
                    }
                });
        }

        function openModalDisposisi(agenda, noSurat, pengirim, perihal) {
            $('#dispNoAgenda').val(agenda);
            $('#dispNoSurat').val(noSurat);
            $('#dispPengirimReview').text(pengirim);
            $('#dispPerihalReview').text(perihal);
            
            // Set Default Date Today
            document.querySelector('input[name="tglDisposisi"]').valueAsDate = new Date();
            
            // Reset Form fields
            $('#disposisiWadir').val('');
            $('#disposisiBidang').empty().append('<option value="" selected disabled>-- Menunggu Pilihan Wadir --</option>').prop('disabled', true);
            $('textarea[name="isiDisposisi"]').val('');
            
            const modal = new bootstrap.Modal(document.getElementById('modalDisposisi'));
            modal.show();
        }

        function submitDisposisi() {
            const formData = {
                type: 'update_disposisi',
                noAgenda: $('#dispNoAgenda').val(),
                disposisiWadir: $('#disposisiWadir').val(),
                disposisiBidang: $('#disposisiBidang').val(),
                isiDisposisi: $('textarea[name="isiDisposisi"]').val(),
                tglDisposisi: $('input[name="tglDisposisi"]').val()
            };

            if(!formData.disposisiWadir || !formData.disposisiBidang) {
                Swal.fire('Peringatan', 'Mohon pilih Tujuan Disposisi (Wadir & Bidang)', 'warning');
                return;
            }

            // Close Modal
            const modalEl = document.getElementById('modalDisposisi');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            showLoading(true);
            sendData(formData, () => {
                loadDataDisposisiPending(); // Refresh tabel pending
                Swal.fire('Sukses', 'Surat berhasil didisposisi!', 'success');
            });
        }

        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableKeluar').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            let btnFile = row[5] ? `<a href="${row[5]}" target="_blank" class="btn btn-sm btn-outline-info" title="Lihat"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[2]).toLocaleDateString('id-ID');

                            dt.row.add([
                                tgl,
                                `<span class="badge bg-secondary">${row[1]}</span>`,
                                row[3],
                                row[4],
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                });
        }

        function readFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showLoading(show) {
            if (show) $('#loadingOverlay').css('display', 'flex');
            else $('#loadingOverlay').hide();
        }
    </script>
</body>
</html>
