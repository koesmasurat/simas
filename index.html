<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #10b981;
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #0f172a 100%); /* Emerald to Dark Blue */
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Utility */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        /* --- LOGIN SECTION --- */
        #loginSection {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            color: white;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 12px;
        }
        
        .form-control:focus {
            background: #fff;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.25); /* Emerald Glow */
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent));
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        /* --- DASHBOARD LAYOUT (PC Sidebar) --- */
        #appContent {
            display: none;
            min-height: 100vh;
        }

        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }

        /* Sidebar Styling */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.3); /* Darker glass for sidebar */
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            color: #fff;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            z-index: 999;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--glass-border);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul li {
            padding: 10px 20px;
        }

        /* Custom Nav Pills inside Sidebar */
        .nav-pills .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 8px;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-pills .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--emerald-accent), transparent);
            color: #fff;
            border-left: 4px solid #fff;
        }

        .nav-link i {
            width: 25px;
            margin-right: 10px;
        }

        /* Content Styling */
        #content {
            width: 100%;
            padding: 20px;
            margin-left: var(--sidebar-width); /* Offset for fixed sidebar */
            transition: all 0.3s;
        }

        /* Card & Table Customization */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
            margin-bottom: 25px;
        }

        .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid var(--glass-border);
            color: var(--emerald-accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* DataTables Customization for Dark Theme */
        table.dataTable tbody tr {
            background-color: transparent !important;
            color: white !important;
        }
        
        .table {
            color: white !important;
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255,255,255,0.05);
            --bs-table-hover-bg: rgba(16, 185, 129, 0.2);
            --bs-table-border-color: rgba(255,255,255,0.2);
        }

        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            color: #ccc !important;
        }

        .page-link {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .page-item.active .page-link {
            background-color: var(--emerald-accent);
            border-color: var(--emerald-accent);
        }

        /* Responsive Behavior */
        @media (max-width: 991.98px) {
            #sidebar {
                position: relative;
                height: auto;
                min-width: 100%;
                max-width: 100%;
            }
            #content {
                margin-left: 0;
            }
            .nav-pills {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .nav-pills .nav-link {
                white-space: nowrap;
                margin-right: 10px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .nav-pills .nav-link.active {
                background: none;
                border-left: none;
                border-bottom: 3px solid var(--emerald-accent);
            }
        }

        /* Loading Overlay */
        #loadingOverlay {
            background: rgba(15, 23, 42, 0.9); /* Dark background */
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <div id="loginSection">
        <div class="glass-panel login-card text-center">
            <div class="mb-4">
                <div class="bg-white rounded-circle d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-hospital-user fa-3x" style="color: var(--emerald-accent);"></i>
                </div>
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Manajemen Persuratan RSUD</p>
            </div>
            
            <form id="formLogin">
                <div class="mb-4 text-start">
                    <label class="form-label small text-uppercase fw-bold text-white-50">Password Admin</label>
                    <div class="input-group">
                        <span class="input-group-text border-0" style="background: rgba(255,255,255,0.8);"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Masukkan Kode Akses" required>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary shadow-lg">
                        MASUK APLIKASI <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <small class="text-white-50">RSUD dr. R. Koesma &copy; 2024</small>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent">
        <div class="wrapper">
            
            <!-- SIDEBAR -->
            <nav id="sidebar">
                <div class="sidebar-header text-center">
                    <i class="fas fa-hospital-alt fa-2x mb-2 text-white"></i>
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50">Administrator Panel</small>
                </div>

                <div class="p-3">
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-outline-light btn-sm" onclick="showChangePassword()">
                            <i class="fas fa-key me-2"></i> Ganti Password
                        </button>
                    </div>

                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        <button class="nav-link active" id="masuk-tab" data-bs-toggle="pill" data-bs-target="#masuk-content" type="button" role="tab">
                            <i class="fas fa-inbox"></i> Surat Masuk
                        </button>
                        <button class="nav-link" id="keluar-tab" data-bs-toggle="pill" data-bs-target="#keluar-content" type="button" role="tab">
                            <i class="fas fa-paper-plane"></i> Surat Keluar
                        </button>
                    </div>
                </div>

                <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
                    <button class="btn btn-danger w-100 btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i> Keluar
                    </button>
                </div>
            </nav>

            <!-- PAGE CONTENT -->
            <div id="content">
                
                <!-- Tab Content Container -->
                <div class="tab-content" id="v-pills-tabContent">
                    
                    <!-- TAB SURAT MASUK -->
                    <div class="tab-pane fade show active" id="masuk-content" role="tabpanel">
                        <h2 class="mb-4 fw-light text-white">Dashboard <b class="text-info">Surat Masuk</b></h2>
                        
                        <div class="row">
                            <!-- Form Input -->
                            <div class="col-xl-4 col-lg-5 mb-4">
                                <div class="card h-100">
                                    <div class="card-header"><i class="fas fa-plus-circle me-2"></i>Registrasi Surat Masuk</div>
                                    <div class="card-body">
                                        <form id="formSuratMasuk">
                                            <div class="row">
                                                <div class="col-6 mb-3">
                                                    <label class="form-label text-white-50 small">No. Agenda</label>
                                                    <input type="text" class="form-control" name="noAgenda" required>
                                                </div>
                                                <div class="col-6 mb-3">
                                                    <label class="form-label text-white-50 small">Tanggal Terima</label>
                                                    <input type="date" class="form-control" name="tglTerima" required>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">No. Surat</label>
                                                <input type="text" class="form-control" name="noSurat" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Pengirim</label>
                                                <input type="text" class="form-control" name="pengirim" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Perihal</label>
                                                <textarea class="form-control" name="perihal" rows="2" required></textarea>
                                            </div>
                                            
                                            <!-- Disposisi Logic Box -->
                                            <div class="p-3 rounded mb-3" style="background: rgba(255,255,255,0.08); border: 1px dashed rgba(255,255,255,0.3);">
                                                <small class="text-info fw-bold d-block mb-3"><i class="fas fa-sitemap me-1"></i> LEMBAR DISPOSISI</small>
                                                <div class="mb-3">
                                                    <label class="form-label text-white-50 small">Level 1: Wadir</label>
                                                    <select class="form-control form-select" id="disposisiWadir" name="disposisiWadir" required>
                                                        <option value="" selected disabled>Pilih Wadir...</option>
                                                        <option value="Wadir Pelayanan">Wakil Direktur Pelayanan</option>
                                                        <option value="Wadir Admin & Keuangan">Wakil Direktur Admin & Keuangan</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label text-white-50 small">Level 2: Bidang/Bagian</label>
                                                    <select class="form-control form-select" id="disposisiBidang" name="disposisiBidang" required disabled>
                                                        <option value="" selected disabled>-- Menunggu Pilihan Wadir --</option>
                                                    </select>
                                                </div>

                                                <!-- Isi & Tanggal Disposisi -->
                                                <div class="mb-2">
                                                    <label class="form-label text-white-50 small">Isi Instruksi</label>
                                                    <textarea class="form-control" name="isiDisposisi" rows="2" placeholder="Tuliskan instruksi..."></textarea>
                                                </div>
                                                <div class="mb-0">
                                                    <label class="form-label text-white-50 small">Tgl Disposisi</label>
                                                    <input type="date" class="form-control" name="tglDisposisi">
                                                </div>
                                            </div>

                                            <div class="mb-4">
                                                <label class="form-label text-white-50 small">Scan Dokumen (PDF/Img)</label>
                                                <input type="file" class="form-control" id="fileSuratMasuk" accept=".pdf, .jpg, .jpeg, .png">
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Surat Masuk</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Data -->
                            <div class="col-xl-8 col-lg-7">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-database me-2"></i>Arsip Surat Masuk</span>
                                        <button class="btn btn-sm btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt"></i></button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="tableMasuk" class="table table-hover w-100 align-middle">
                                                <thead>
                                                    <tr>
                                                        <th>Tanggal</th>
                                                        <th>Agenda</th>
                                                        <th>Pengirim</th>
                                                        <th>Disposisi</th>
                                                        <th>Perihal</th>
                                                        <th>Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB SURAT KELUAR -->
                    <div class="tab-pane fade" id="keluar-content" role="tabpanel">
                        <h2 class="mb-4 fw-light text-white">Dashboard <b class="text-success">Surat Keluar</b></h2>
                        
                        <div class="row">
                            <!-- Form Input -->
                            <div class="col-xl-4 col-lg-5 mb-4">
                                <div class="card h-100">
                                    <div class="card-header"><i class="fas fa-paper-plane me-2"></i>Registrasi Surat Keluar</div>
                                    <div class="card-body">
                                        <form id="formSuratKeluar">
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">No. Surat</label>
                                                <input type="text" class="form-control" name="noSurat" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Tanggal Surat</label>
                                                <input type="date" class="form-control" name="tglSurat" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Tujuan</label>
                                                <input type="text" class="form-control" name="tujuan" required>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Perihal</label>
                                                <textarea class="form-control" name="perihal" rows="3" required></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label text-white-50 small">Pembuat / Bagian</label>
                                                <input type="text" class="form-control" name="pembuat" placeholder="Contoh: Bagian Umum">
                                            </div>
                                            <div class="mb-4">
                                                <label class="form-label text-white-50 small">File Arsip</label>
                                                <input type="file" class="form-control" id="fileSuratKeluar" accept=".pdf, .jpg, .jpeg, .png">
                                            </div>

                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Surat Keluar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>

                            <!-- Table Data -->
                            <div class="col-xl-8 col-lg-7">
                                <div class="card h-100">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-database me-2"></i>Arsip Surat Keluar</span>
                                        <button class="btn btn-sm btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt"></i></button>
                                    </div>
                                    <div class="card-body">
                                        <div class="table-responsive">
                                            <table id="tableKeluar" class="table table-hover w-100 align-middle">
                                                <thead>
                                                    <tr>
                                                        <th>Tgl Surat</th>
                                                        <th>No. Surat</th>
                                                        <th>Tujuan</th>
                                                        <th>Perihal</th>
                                                        <th>File</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- End Tab Content -->
            </div> <!-- End Page Content -->
        </div> <!-- End Wrapper -->
    </div> <!-- End appContent -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status"></div>
        <div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ================= CONFIGURATION =================
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        // ================================================

        // === Cascading Dropdown Logic ===
        const structureOrg = {
            "Wadir Pelayanan": [
                "Bidang Pelayanan Medis",
                "Bidang Keperawatan",
                "Bidang Penunjang Medis"
            ],
            "Wadir Admin & Keuangan": [
                "Bagian Tata Usaha",
                "Bagian Keuangan & Akuntansi",
                "Bagian Perencanaan & Program"
            ]
        };

        $(document).ready(function() {
            // Check Session Login
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
            }

            // Handle Login Submit
            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                
                showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'login', password: pass })
                })
                .then(res => res.json())
                .then(res => {
                    showLoading(false);
                    if (res.status === 'success') {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        showApp();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Akses Ditolak',
                            text: res.message,
                            background: '#1e293b',
                            color: '#fff'
                        });
                    }
                })
                .catch(err => {
                    showLoading(false);
                    Swal.fire({
                        icon: 'error',
                        title: 'Koneksi Gagal',
                        text: 'Tidak dapat terhubung ke server',
                        background: '#1e293b',
                        color: '#fff'
                    });
                });
            });

            // Initialize DataTables with Dark Theme Config
            const dtConfig = {
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "order": [[ 0, "desc" ]],
                "pageLength": 5,
                "lengthMenu": [5, 10, 25, 50],
                "autoWidth": false
            };
            
            const dtMasuk = $('#tableMasuk').DataTable(dtConfig);
            const dtKeluar = $('#tableKeluar').DataTable(dtConfig);

            // Handler Dropdown Wadir Change
            $('#disposisiWadir').change(function() {
                const wadir = $(this).val();
                const bidangSelect = $('#disposisiBidang');
                
                bidangSelect.empty().append('<option value="" selected disabled>Pilih Bagian/Bidang...</option>');
                
                if (wadir && structureOrg[wadir]) {
                    structureOrg[wadir].forEach(function(bidang) {
                        bidangSelect.append(new Option(bidang, bidang));
                    });
                    bidangSelect.prop('disabled', false);
                } else {
                    bidangSelect.prop('disabled', true);
                }
            });

            // === Handle Form Submit Surat Masuk ===
            $('#formSuratMasuk').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratMasuk');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_masuk",
                    noAgenda: $('input[name="noAgenda"]').val(),
                    noSurat: $('input[name="noSurat"]').val(),
                    tglTerima: $('input[name="tglTerima"]').val(),
                    pengirim: $('input[name="pengirim"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    disposisiWadir: $('#disposisiWadir').val(),
                    disposisiBidang: $('#disposisiBidang').val(),
                    isiDisposisi: $('textarea[name="isiDisposisi"]').val(),
                    tglDisposisi: $('input[name="tglDisposisi"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratMasuk')[0].reset();
                    $('#disposisiBidang').prop('disabled', true);
                    loadDataMasuk();
                });
            });

            // === Handle Form Submit Surat Keluar ===
            $('#formSuratKeluar').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratKeluar');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_keluar",
                    noSurat: $('input[name="noSurat"]').val(),
                    tglSurat: $('input[name="tglSurat"]').val(),
                    tujuan: $('input[name="tujuan"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    pembuat: $('input[name="pembuat"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratKeluar')[0].reset();
                    loadDataKeluar();
                });
            });
        });

        // ================= FUNCTIONS =================

        function showApp() {
            $('#loginSection').fadeOut(300, function() {
                $('#appContent').fadeIn(300);
                loadDataMasuk();
                loadDataKeluar();
            });
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: "Anda yakin ingin keluar?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, Keluar!',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('isLoggedIn');
                    location.reload();
                }
            })
        }

        function showChangePassword() {
            Swal.fire({
                title: 'Ganti Password Admin',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Password Lama">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Password Baru">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                background: '#1e293b',
                color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [oldPass, newPass] = result.value;
                    if(!oldPass || !newPass) return;

                    showLoading(true);
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ type: 'change_password', oldPassword: oldPass, newPassword: newPass })
                    })
                    .then(res => res.json())
                    .then(res => {
                        showLoading(false);
                        if (res.status === 'success') {
                            Swal.fire({
                                title: 'Sukses',
                                text: 'Password berhasil diubah',
                                icon: 'success',
                                background: '#1e293b',
                                color: '#fff'
                            });
                        } else {
                            Swal.fire({
                                title: 'Gagal',
                                text: res.message,
                                icon: 'error',
                                background: '#1e293b',
                                color: '#fff'
                            });
                        }
                    });
                }
            })
        }

        function sendData(data, callback) {
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    Swal.fire({
                        title: 'Berhasil!',
                        text: 'Data telah disimpan.',
                        icon: 'success',
                        background: '#1e293b',
                        color: '#fff'
                    });
                    if (callback) callback();
                } else {
                    Swal.fire({
                        title: 'Gagal',
                        text: result.message,
                        icon: 'error',
                        background: '#1e293b',
                        color: '#fff'
                    });
                }
            })
            .catch(error => {
                showLoading(false);
                Swal.fire({
                    title: 'Error',
                    text: 'Terjadi kesalahan koneksi.',
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
            });
        }

        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableMasuk').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info" title="Lihat File"><i class="fas fa-file-pdf"></i></a>` : '<span class="text-white-50">-</span>';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            
                            let dispContent = `<div class="d-flex flex-column">
                                <span class="fw-bold text-info">${row[7]}</span>
                                <span class="small text-white-50">${row[8]}</span>`;
                            
                            if(row[9]) dispContent += `<div class="mt-1 small text-warning fst-italic"><i class="fas fa-comment me-1"></i> "${row[9]}"</div>`;
                            dispContent += `</div>`;
                            
                            dt.row.add([
                                tgl,
                                `<span class="badge bg-secondary">${row[1]}</span>`,
                                row[4],
                                dispContent,
                                row[5],
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                })
                .catch(err => console.error("Gagal load data masuk", err));
        }

        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableKeluar').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            let btnFile = row[5] ? `<a href="${row[5]}" target="_blank" class="btn btn-sm btn-outline-info" title="Lihat File"><i class="fas fa-file-pdf"></i></a>` : '<span class="text-white-50">-</span>';
                            let tgl = new Date(row[2]).toLocaleDateString('id-ID');

                            dt.row.add([
                                tgl,
                                `<span class="badge bg-secondary">${row[1]}</span>`,
                                row[3],
                                row[4],
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                })
                .catch(err => console.error("Gagal load data keluar", err));
        }

        function readFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showLoading(show) {
            if (show) $('#loadingOverlay').css('display', 'flex');
            else $('#loadingOverlay').hide();
        }
    </script>
</body>
</html>
