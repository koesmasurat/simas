<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #10b981;
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #0f172a 100%); /* Emerald to Dark Blue */
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Utility */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
        }

        /* --- LOGIN SECTION --- */
        #loginSection {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 2.5rem;
            color: white;
        }

        .form-control {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 8px;
            padding: 12px;
        }
        
        .form-control:focus {
            background: #fff;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.25);
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent));
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        /* --- DASHBOARD LAYOUT (PC Sidebar) --- */
        #appContent {
            display: none;
            min-height: 100vh;
        }

        .wrapper {
            display: flex;
            width: 100%;
            align-items: stretch;
        }

        /* Sidebar Styling */
        #sidebar {
            min-width: var(--sidebar-width);
            max-width: var(--sidebar-width);
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--glass-border);
            color: #fff;
            transition: all 0.3s;
            position: fixed;
            height: 100vh;
            z-index: 999;
        }

        #sidebar .sidebar-header {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--glass-border);
        }

        #sidebar ul.components {
            padding: 20px 0;
        }

        #sidebar ul li {
            padding: 10px 20px;
        }

        .nav-pills .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 8px;
            text-align: left;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }

        .nav-pills .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .nav-pills .nav-link.active {
            background: linear-gradient(90deg, var(--emerald-accent), transparent);
            color: #fff;
            border-left: 4px solid #fff;
        }

        .nav-link i {
            width: 25px;
            margin-right: 10px;
        }

        .sidebar-divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 10px 0;
        }
        
        .sidebar-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.4);
            margin-top: 15px;
            margin-bottom: 5px;
            padding-left: 10px;
        }

        #content {
            width: 100%;
            padding: 20px;
            margin-left: var(--sidebar-width);
            transition: all 0.3s;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
            margin-bottom: 25px;
        }

        .card-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid var(--glass-border);
            color: var(--emerald-accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-container-limit {
            max-width: 900px;
            margin: 0 auto;
        }

        table.dataTable tbody tr {
            background-color: transparent !important;
            color: white !important;
        }
        
        .table {
            color: white !important;
            --bs-table-bg: transparent;
            --bs-table-striped-bg: rgba(255,255,255,0.05);
            --bs-table-hover-bg: rgba(16, 185, 129, 0.2);
            --bs-table-border-color: rgba(255,255,255,0.2);
        }

        .dataTables_wrapper .dataTables_length, 
        .dataTables_wrapper .dataTables_filter, 
        .dataTables_wrapper .dataTables_info, 
        .dataTables_wrapper .dataTables_processing, 
        .dataTables_wrapper .dataTables_paginate {
            color: #ccc !important;
        }

        .page-link {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.1);
            color: white;
        }
        
        .page-item.active .page-link {
            background-color: var(--emerald-accent);
            border-color: var(--emerald-accent);
        }

        /* Modal Customization for 4 Levels */
        .modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            border: 1px solid var(--glass-border);
        }
        .modal-header, .modal-footer {
            border-color: rgba(255,255,255,0.1);
        }
        
        .level-box {
            border-left: 3px solid var(--emerald-accent);
            padding-left: 15px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.03);
            padding: 15px;
            border-radius: 0 8px 8px 0;
        }
        
        .level-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--blue-accent);
            display: flex;
            align-items: center;
        }

        @media (max-width: 991.98px) {
            #sidebar {
                position: relative;
                height: auto;
                min-width: 100%;
                max-width: 100%;
            }
            #content {
                margin-left: 0;
            }
            .nav-pills {
                display: flex;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            .nav-pills .nav-link {
                white-space: nowrap;
                margin-right: 10px;
                border-left: none;
                border-bottom: 3px solid transparent;
            }
            .nav-pills .nav-link.active {
                background: none;
                border-left: none;
                border-bottom: 3px solid var(--emerald-accent);
            }
        }

        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <div id="loginSection">
        <div class="glass-panel login-card text-center">
            <div class="mb-4">
                <div class="bg-white rounded-circle d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-hospital-user fa-3x" style="color: var(--emerald-accent);"></i>
                </div>
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Manajemen Persuratan RSUD</p>
            </div>
            
            <form id="formLogin">
                <div class="mb-4 text-start">
                    <label class="form-label small text-uppercase fw-bold text-white-50">Password Admin</label>
                    <div class="input-group">
                        <span class="input-group-text border-0" style="background: rgba(255,255,255,0.8);"><i class="fas fa-lock"></i></span>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Masukkan Kode Akses" required>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary shadow-lg">
                        MASUK APLIKASI <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <small class="text-white-50">RSUD dr. R. Koesma &copy; 2024</small>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent">
        <div class="wrapper">
            
            <!-- SIDEBAR -->
            <nav id="sidebar">
                <div class="sidebar-header text-center">
                    <i class="fas fa-hospital-alt fa-2x mb-2 text-white"></i>
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50">Administrator Panel</small>
                </div>

                <div class="p-3">
                    <div class="d-grid gap-2 mb-4">
                        <button class="btn btn-outline-light btn-sm" onclick="showChangePassword()">
                            <i class="fas fa-key me-2"></i> Ganti Password
                        </button>
                    </div>

                    <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                        
                        <div class="sidebar-label">Pencatatan</div>
                        
                        <button class="nav-link active" id="nav-input-masuk" data-bs-toggle="pill" data-bs-target="#input-masuk-content" type="button" role="tab">
                            <i class="fas fa-plus-circle"></i> Surat Masuk
                        </button>
                        
                        <button class="nav-link" id="nav-input-keluar" data-bs-toggle="pill" data-bs-target="#input-keluar-content" type="button" role="tab">
                            <i class="fas fa-paper-plane"></i> Surat Keluar
                        </button>

                        <button class="nav-link text-warning" id="nav-disposisi" data-bs-toggle="pill" data-bs-target="#disposisi-content" type="button" role="tab" onclick="loadDataDisposisiPending()">
                            <i class="fas fa-tasks"></i> Disposisi <span class="badge bg-danger ms-auto small" id="badgePending" style="display:none">!</span>
                        </button>

                        <div class="sidebar-divider"></div>
                        <div class="sidebar-label">Arsip & Data</div>

                        <button class="nav-link" id="nav-arsip-masuk" data-bs-toggle="pill" data-bs-target="#arsip-masuk-content" type="button" role="tab" onclick="loadDataMasuk()">
                            <i class="fas fa-inbox"></i> Arsip Masuk
                        </button>
                        
                        <button class="nav-link" id="nav-arsip-keluar" data-bs-toggle="pill" data-bs-target="#arsip-keluar-content" type="button" role="tab" onclick="loadDataKeluar()">
                            <i class="fas fa-archive"></i> Arsip Keluar
                        </button>

                    </div>
                </div>

                <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
                    <button class="btn btn-danger w-100 btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt me-2"></i> Keluar
                    </button>
                </div>
            </nav>

            <!-- PAGE CONTENT -->
            <div id="content">
                
                <div class="tab-content" id="v-pills-tabContent">
                    
                    <!-- 1. FORM SURAT MASUK (TANPA DISPOSISI) -->
                    <div class="tab-pane fade show active" id="input-masuk-content" role="tabpanel">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-info">Surat Masuk Baru</b></h2>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-pen-fancy me-2"></i>Formulir Agenda Surat Masuk</div>
                                <div class="card-body p-4">
                                    <form id="formSuratMasuk">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">No. Agenda</label>
                                                <input type="text" class="form-control" name="noAgenda" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">Tanggal Terima</label>
                                                <input type="date" class="form-control" name="tglTerima" required>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">No. Surat</label>
                                            <input type="text" class="form-control" name="noSurat" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Pengirim</label>
                                            <input type="text" class="form-control" name="pengirim" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="3" required></textarea>
                                        </div>
                                        
                                        <div class="alert alert-info bg-opacity-10 border-0 text-white small">
                                            <i class="fas fa-info-circle me-2"></i> Surat akan disimpan dengan status <b>"Menunggu Disposisi"</b>. Disposisi Direktur, Wadir, dll dilakukan via menu <i>Disposisi</i>.
                                        </div>

                                        <div class="mb-4">
                                            <label class="form-label text-white-50 small">Scan Dokumen (PDF/Img)</label>
                                            <input type="file" class="form-control" id="fileSuratMasuk" accept=".pdf, .jpg, .jpeg, .png">
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Simpan Surat Masuk</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. FORM SURAT KELUAR -->
                    <div class="tab-pane fade" id="input-keluar-content" role="tabpanel">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-success">Surat Keluar Baru</b></h2>
                            
                            <div class="card">
                                <div class="card-header"><i class="fas fa-paper-plane me-2"></i>Formulir Registrasi Surat Keluar</div>
                                <div class="card-body p-4">
                                    <form id="formSuratKeluar">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">No. Surat</label>
                                                <input type="text" class="form-control" name="noSurat" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label text-white-50 small">Tanggal Surat</label>
                                                <input type="date" class="form-control" name="tglSurat" required>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Tujuan</label>
                                            <input type="text" class="form-control" name="tujuan" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="3" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-white-50 small">Pembuat / Bagian</label>
                                            <input type="text" class="form-control" name="pembuat" placeholder="Contoh: Bagian Umum">
                                        </div>
                                        <div class="mb-4">
                                            <label class="form-label text-white-50 small">File Arsip</label>
                                            <input type="file" class="form-control" id="fileSuratKeluar" accept=".pdf, .jpg, .jpeg, .png">
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Simpan Surat Keluar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. HALAMAN DISPOSISI PENDING -->
                    <div class="tab-pane fade" id="disposisi-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Antrian <b class="text-warning">Disposisi Surat</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataDisposisiPending()"><i class="fas fa-sync-alt me-2"></i>Refresh</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableDisposisi" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="10%">Tanggal</th>
                                                <th width="10%">Agenda</th>
                                                <th width="20%">Pengirim</th>
                                                <th width="35%">Perihal</th>
                                                <th width="10%">File</th>
                                                <th width="15%">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. ARSIP SURAT MASUK (REVISED DISPLAY) -->
                    <div class="tab-pane fade" id="arsip-masuk-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-info">Surat Masuk</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableMasuk" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="10%">Tanggal</th>
                                                <th width="10%">Agenda</th>
                                                <th width="15%">Pengirim</th>
                                                <th width="35%">Lembar Disposisi (Berjenjang)</th>
                                                <th width="20%">Perihal</th>
                                                <th width="10%">File</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 5. ARSIP SURAT KELUAR -->
                    <div class="tab-pane fade" id="arsip-keluar-content" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-success">Surat Keluar</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt me-2"></i>Refresh Data</button>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableKeluar" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th width="15%">Tgl Surat</th>
                                                <th width="15%">No. Surat</th>
                                                <th width="20%">Tujuan</th>
                                                <th width="40%">Perihal</th>
                                                <th width="10%">File</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DISPOSISI 4 LEVEL -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Input Disposisi Berjenjang</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDisposisi">
                        <input type="hidden" id="dispNoAgenda" name="noAgenda">
                        
                        <div class="alert alert-secondary text-white small mb-3 p-2">
                            <strong>Info Surat:</strong> <span id="dispInfoReview"></span>
                        </div>

                        <!-- LEVEL 1: DIREKTUR -->
                        <div class="level-box" style="border-color: #f59e0b;">
                            <div class="level-title text-warning"><i class="fas fa-user-tie me-2"></i>Level 1: Direktur</div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Tujuan (Wadir)</label>
                                    <select class="form-control form-select form-select-sm" id="targetWadir" name="targetWadir" required>
                                        <option value="" selected disabled>Pilih Wadir...</option>
                                        <option value="Wadir Pelayanan">Wadir Pelayanan</option>
                                        <option value="Wadir Admin & Keuangan">Wadir Admin & Keuangan</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Instruksi Direktur</label>
                                    <textarea class="form-control form-control-sm" name="instruksiDirektur" rows="1" placeholder="Isi instruksi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- LEVEL 2: WADIR -->
                        <div class="level-box" style="border-color: #3b82f6;">
                            <div class="level-title text-primary"><i class="fas fa-user-shield me-2"></i>Level 2: Wadir</div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Tujuan (Bidang/Bagian)</label>
                                    <select class="form-control form-select form-select-sm" id="targetBidang" name="targetBidang" required disabled>
                                        <option value="" selected disabled>-- Menunggu Pilihan Direktur --</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Instruksi Wadir</label>
                                    <textarea class="form-control form-control-sm" name="instruksiWadir" rows="1" placeholder="Isi instruksi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- LEVEL 3: KABID -->
                        <div class="level-box" style="border-color: #10b981;">
                            <div class="level-title text-success"><i class="fas fa-user-tag me-2"></i>Level 3: Kabag/Kabid</div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Nama JF Tujuan</label>
                                    <input type="text" class="form-control form-control-sm" name="targetJF" placeholder="Ketik nama JF...">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Instruksi Kabag/Kabid</label>
                                    <textarea class="form-control form-control-sm" name="instruksiKabid" rows="1" placeholder="Isi instruksi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- LEVEL 4: JF -->
                        <div class="level-box" style="border-color: #8b5cf6;">
                            <div class="level-title text-info" style="color: #a78bfa !important;"><i class="fas fa-users me-2"></i>Level 4: JF (Ke Staf)</div>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Nama Staf Pelaksana</label>
                                    <input type="text" class="form-control form-control-sm" name="targetStaf" placeholder="Ketik nama Staf...">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <label class="form-label small text-white-50">Instruksi JF</label>
                                    <textarea class="form-control form-control-sm" name="instruksiJF" rows="1" placeholder="Isi instruksi..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="mb-0 text-end">
                             <div class="d-inline-block text-start">
                                <label class="form-label small text-white-50">Tanggal Disposisi</label>
                                <input type="date" class="form-control form-control-sm" name="tglDisposisi" required>
                             </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="submitDisposisi()">Simpan Semua Disposisi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-info" style="width: 4rem; height: 4rem;" role="status"></div>
        <div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        
        const structureOrg = {
            "Wadir Pelayanan": [
                "Bidang Pelayanan Medis",
                "Bidang Keperawatan",
                "Bidang Penunjang Medis"
            ],
            "Wadir Admin & Keuangan": [
                "Bagian Tata Usaha",
                "Bagian Keuangan & Akuntansi",
                "Bagian Perencanaan & Program"
            ]
        };

        $(document).ready(function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
            }

            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                
                showLoading(true);
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'login', password: pass })
                })
                .then(res => res.json())
                .then(res => {
                    showLoading(false);
                    if (res.status === 'success') {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        showApp();
                    } else {
                        Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: res.message });
                    }
                })
                .catch(err => {
                    showLoading(false);
                    Swal.fire({ icon: 'error', title: 'Koneksi Gagal', text: 'Tidak dapat terhubung ke server' });
                });
            });

            const dtConfig = {
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "order": [[ 0, "desc" ]],
                "pageLength": 10,
                "lengthMenu": [10, 25, 50, 100],
                "autoWidth": false
            };
            
            const dtMasuk = $('#tableMasuk').DataTable(dtConfig);
            const dtKeluar = $('#tableKeluar').DataTable(dtConfig);
            const dtDisposisi = $('#tableDisposisi').DataTable(dtConfig);

            // Handler Cascading Dropdown (Direktur -> Wadir -> Bidang)
            $('#targetWadir').change(function() {
                const wadir = $(this).val();
                const bidangSelect = $('#targetBidang');
                
                bidangSelect.empty().append('<option value="" selected disabled>Pilih Bagian/Bidang...</option>');
                
                if (wadir && structureOrg[wadir]) {
                    structureOrg[wadir].forEach(function(bidang) {
                        bidangSelect.append(new Option(bidang, bidang));
                    });
                    bidangSelect.prop('disabled', false);
                } else {
                    bidangSelect.prop('disabled', true);
                }
            });

            // === Surat Masuk (Tanpa Disposisi) ===
            $('#formSuratMasuk').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratMasuk');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_masuk",
                    noAgenda: $('input[name="noAgenda"]').val(),
                    noSurat: $('input[name="noSurat"]').val(),
                    tglTerima: $('input[name="tglTerima"]').val(),
                    pengirim: $('input[name="pengirim"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratMasuk')[0].reset();
                    Swal.fire('Tersimpan', 'Surat masuk berhasil dicatat.', 'success');
                });
            });

            // === Surat Keluar ===
            $('#formSuratKeluar').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratKeluar');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_keluar",
                    noSurat: $('input[name="noSurat"]').val(),
                    tglSurat: $('input[name="tglSurat"]').val(),
                    tujuan: $('input[name="tujuan"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    pembuat: $('input[name="pembuat"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratKeluar')[0].reset();
                });
            });
        });

        function showApp() {
            $('#loginSection').fadeOut(300, function() {
                $('#appContent').fadeIn(300);
            });
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi', text: "Yakin keluar?", icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya',
                background: '#1e293b', color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('isLoggedIn');
                    location.reload();
                }
            })
        }

        function showChangePassword() {
            Swal.fire({
                title: 'Ganti Password',
                html: '<input id="swal-input1" class="swal2-input" placeholder="Lama"><input id="swal-input2" class="swal2-input" placeholder="Baru">',
                showCancelButton: true, confirmButtonText: 'Simpan', background: '#1e293b', color: '#fff',
                preConfirm: () => [document.getElementById('swal-input1').value, document.getElementById('swal-input2').value]
            }).then((result) => {
                if (result.isConfirmed) {
                    const [oldPass, newPass] = result.value;
                    showLoading(true);
                    fetch(GAS_URL, {
                        method: 'POST', body: JSON.stringify({ type: 'change_password', oldPassword: oldPass, newPassword: newPass })
                    }).then(res=>res.json()).then(res=>{
                        showLoading(false);
                        Swal.fire(res.status==='success'?'Sukses':'Gagal', res.message, res.status);
                    });
                }
            })
        }

        function sendData(data, callback) {
            fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    if (callback) callback();
                    else Swal.fire({ title: 'Berhasil!', icon: 'success' });
                } else {
                    Swal.fire({ title: 'Gagal', text: result.message, icon: 'error' });
                }
            }).catch(error => { showLoading(false); Swal.fire({ title: 'Error', text: 'Koneksi error', icon: 'error' }); });
        }

        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableMasuk').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            // Structure: 0:Ts, 1:Agenda, 2:Surat, 3:Tgl, 4:Pengirim, 5:Perihal, 6:Link
                            // 7:TargetWadir, 8:InstrDir, 9:TargetBidang, 10:InstrWadir
                            // 11:TargetJF, 12:InstrKabid, 13:TargetStaf, 14:InstrJF, 15:TglDisp, 16:Status
                            
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            
                            let dispContent = '-';
                            if(row[16] === 'Terdisposisi') {
                                dispContent = `<div class="d-flex flex-column gap-2 text-start small">
                                    <div class="border-start border-warning border-3 ps-2">
                                        <div class="fw-bold text-warning">DIR &rarr; ${row[7]}</div>
                                        <div class="text-white-50 fst-italic">"${row[8]}"</div>
                                    </div>
                                    <div class="border-start border-primary border-3 ps-2">
                                        <div class="fw-bold text-primary">WADIR &rarr; ${row[9]}</div>
                                        <div class="text-white-50 fst-italic">"${row[10]}"</div>
                                    </div>
                                    <div class="border-start border-success border-3 ps-2">
                                        <div class="fw-bold text-success">KABID &rarr; ${row[11]}</div>
                                        <div class="text-white-50 fst-italic">"${row[12]}"</div>
                                    </div>
                                    <div class="border-start border-info border-3 ps-2">
                                        <div class="fw-bold text-info">JF &rarr; ${row[13]}</div>
                                        <div class="text-white-50 fst-italic">"${row[14]}"</div>
                                    </div>
                                </div>`;
                            } else {
                                dispContent = `<span class="badge bg-warning text-dark">Belum ada disposisi</span>`;
                            }

                            dt.row.add([
                                tgl,
                                `<span class="badge bg-secondary">${row[1]}</span>`,
                                row[4], // Pengirim
                                dispContent, // Disposisi 4 Level
                                row[5], // Perihal
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                });
        }

        function loadDataDisposisiPending() {
            fetch(`${GAS_URL}?action=read_pending`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableDisposisi').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        $('#badgePending').text(res.data.length).show();
                        res.data.forEach(row => {
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            
                            let btnProses = `<button class="btn btn-sm btn-warning text-dark fw-bold" onclick="openModalDisposisi('${row[1]}', '${row[2]}', '${row[4]}', '${row[5]}')">
                                <i class="fas fa-edit me-1"></i> Input
                            </button>`;

                            dt.row.add([
                                tgl, row[1], row[4], row[5], btnFile, btnProses
                            ]);
                        });
                        dt.draw();
                    } else { $('#badgePending').hide(); }
                });
        }

        function openModalDisposisi(agenda, noSurat, pengirim, perihal) {
            $('#dispNoAgenda').val(agenda);
            $('#dispInfoReview').html(`${pengirim} <br> <span class="text-white-50">${perihal}</span>`);
            document.querySelector('input[name="tglDisposisi"]').valueAsDate = new Date();
            
            // Reset Form fields
            $('#formDisposisi')[0].reset();
            $('#targetBidang').prop('disabled', true);
            
            new bootstrap.Modal(document.getElementById('modalDisposisi')).show();
        }

        function submitDisposisi() {
            const formData = {
                type: 'update_disposisi',
                noAgenda: $('#dispNoAgenda').val(),
                
                targetWadir: $('#targetWadir').val(),
                instruksiDirektur: $('textarea[name="instruksiDirektur"]').val(),
                
                targetBidang: $('#targetBidang').val(),
                instruksiWadir: $('textarea[name="instruksiWadir"]').val(),
                
                targetJF: $('input[name="targetJF"]').val(),
                instruksiKabid: $('textarea[name="instruksiKabid"]').val(),
                
                targetStaf: $('input[name="targetStaf"]').val(),
                instruksiJF: $('textarea[name="instruksiJF"]').val(),
                
                tglDisposisi: $('input[name="tglDisposisi"]').val()
            };

            if(!formData.targetWadir) {
                Swal.fire('Peringatan', 'Minimal Target Wadir harus dipilih', 'warning');
                return;
            }

            bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide();
            showLoading(true);
            sendData(formData, () => {
                loadDataDisposisiPending();
                Swal.fire('Sukses', 'Disposisi berjenjang berhasil disimpan!', 'success');
            });
        }

        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableKeluar').DataTable();
                    dt.clear();
                    if (res.data) {
                        res.data.forEach(row => {
                            let btnFile = row[5] ? `<a href="${row[5]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                            let tgl = new Date(row[2]).toLocaleDateString('id-ID');
                            dt.row.add([ tgl, `<span class="badge bg-secondary">${row[1]}</span>`, row[3], row[4], btnFile ]);
                        });
                        dt.draw();
                    }
                });
        }

        function readFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showLoading(show) {
            if (show) $('#loadingOverlay').css('display', 'flex');
            else $('#loadingOverlay').hide();
        }
    </script>
</body>
</html>
