<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
        }
        /* Login Screen Styles */
        #loginSection {
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0d6efd 0%, #0099ff 100%);
        }
        #appContent {
            display: none; /* Hidden by default */
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-brand {
            font-weight: bold;
            letter-spacing: 1px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: white;
            border-bottom: 2px solid #f1f1f1;
            font-weight: bold;
            color: var(--primary-color);
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            color: var(--primary-color);
            border-top: 3px solid var(--primary-color);
        }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>

    <!-- LOGIN SECTION -->
    <div id="loginSection">
        <div class="card shadow-lg p-4" style="width: 100%; max-width: 400px; border-radius: 15px;">
            <div class="text-center mb-4">
                <i class="fas fa-hospital-user fa-3x text-primary mb-3"></i>
                <h4 class="fw-bold">Login SIMAS KOESMA</h4>
                <p class="text-muted small">Silakan masukkan password admin</p>
            </div>
            <form id="formLogin">
                <div class="mb-3">
                    <input type="password" class="form-control form-control-lg" id="loginPassword" placeholder="Password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Masuk Aplikasi</button>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">Default Pass: admin</small>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContent">

        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-hospital-alt me-2"></i> SIMAS KOESMA
                </a>
                <div class="d-flex">
                    <button class="btn btn-sm btn-outline-light me-2" onclick="showChangePassword()">
                        <i class="fas fa-key"></i> Ganti Password
                    </button>
                    <button class="btn btn-sm btn-light text-primary fw-bold" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Keluar
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mt-4">
            
            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4" id="mainTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="masuk-tab" data-bs-toggle="tab" data-bs-target="#masuk" type="button" role="tab">
                        <i class="fas fa-inbox me-2"></i>Surat Masuk & Disposisi
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="keluar-tab" data-bs-toggle="tab" data-bs-target="#keluar" type="button" role="tab">
                        <i class="fas fa-paper-plane me-2"></i>Surat Keluar
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                
                <!-- TAB SURAT MASUK -->
                <div class="tab-pane fade show active" id="masuk" role="tabpanel">
                    <div class="row">
                        <!-- Form Input -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header"><i class="fas fa-plus-circle me-2"></i>Input Surat Masuk</div>
                                <div class="card-body">
                                    <form id="formSuratMasuk">
                                        <div class="mb-3">
                                            <label class="form-label">No. Agenda</label>
                                            <input type="text" class="form-control" name="noAgenda" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">No. Surat</label>
                                            <input type="text" class="form-control" name="noSurat" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tanggal Terima</label>
                                            <input type="date" class="form-control" name="tglTerima" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Pengirim</label>
                                            <input type="text" class="form-control" name="pengirim" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="2" required></textarea>
                                        </div>
                                        
                                        <!-- Disposisi Logic -->
                                        <div class="p-3 bg-light rounded mb-3 border">
                                            <small class="text-muted fw-bold d-block mb-2">DISPOSISI PIMPINAN</small>
                                            <div class="mb-3">
                                                <label class="form-label">Disposisi Wadir (Level 1)</label>
                                                <select class="form-select" id="disposisiWadir" name="disposisiWadir" required>
                                                    <option value="" selected disabled>Pilih Wadir...</option>
                                                    <option value="Wadir Pelayanan">Wakil Direktur Pelayanan</option>
                                                    <option value="Wadir Admin & Keuangan">Wakil Direktur Admin & Keuangan</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Teruskan Ke (Level 2)</label>
                                                <select class="form-select" id="disposisiBidang" name="disposisiBidang" required disabled>
                                                    <option value="" selected disabled>Pilih Wadir Terlebih Dahulu...</option>
                                                </select>
                                            </div>

                                            <!-- NEW: Kolom Isi & Tanggal Disposisi -->
                                            <div class="mb-3">
                                                <label class="form-label">Isi Instruksi / Disposisi</label>
                                                <textarea class="form-control" name="isiDisposisi" rows="2" placeholder="Tuliskan instruksi disposisi disini..."></textarea>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Tgl Disposisi</label>
                                                <input type="date" class="form-control" name="tglDisposisi">
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Upload File (PDF/Gambar)</label>
                                            <input type="file" class="form-control" id="fileSuratMasuk" accept=".pdf, .jpg, .jpeg, .png">
                                            <small class="text-muted">Max 5MB</small>
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Data</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Table Data -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-table me-2"></i>Daftar Surat Masuk</span>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadDataMasuk()"><i class="fas fa-sync-alt"></i> Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="tableMasuk" class="table table-striped table-hover w-100">
                                            <thead>
                                                <tr>
                                                    <th>Tgl Terima</th>
                                                    <th>No. Agenda</th>
                                                    <th>Pengirim</th>
                                                    <th>Disposisi</th>
                                                    <th>Perihal</th>
                                                    <th>File</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB SURAT KELUAR -->
                <div class="tab-pane fade" id="keluar" role="tabpanel">
                    <div class="row">
                        <!-- Form Input -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header"><i class="fas fa-paper-plane me-2"></i>Input Surat Keluar</div>
                                <div class="card-body">
                                    <form id="formSuratKeluar">
                                        <div class="mb-3">
                                            <label class="form-label">No. Surat</label>
                                            <input type="text" class="form-control" name="noSurat" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tanggal Surat</label>
                                            <input type="date" class="form-control" name="tglSurat" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tujuan</label>
                                            <input type="text" class="form-control" name="tujuan" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Perihal</label>
                                            <textarea class="form-control" name="perihal" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Pembuat / Bagian</label>
                                            <input type="text" class="form-control" name="pembuat" placeholder="Misal: Bagian Umum">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Upload File (Arsip)</label>
                                            <input type="file" class="form-control" id="fileSuratKeluar" accept=".pdf, .jpg, .jpeg, .png">
                                        </div>

                                        <div class="d-grid">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan Data</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Table Data -->
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><i class="fas fa-table me-2"></i>Daftar Surat Keluar</span>
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadDataKeluar()"><i class="fas fa-sync-alt"></i> Refresh</button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="tableKeluar" class="table table-striped table-hover w-100">
                                            <thead>
                                                <tr>
                                                    <th>Tgl Surat</th>
                                                    <th>No. Surat</th>
                                                    <th>Tujuan</th>
                                                    <th>Perihal</th>
                                                    <th>File</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div> <!-- End appContent -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3 fw-bold text-primary">Memproses Data...</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ================= CONFIGURATION =================
        // URL Web App GAS Anda
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        // ================================================

        // === Cascading Dropdown Logic (Disposisi) ===
        const structureOrg = {
            "Wadir Pelayanan": [
                "Bidang Pelayanan Medis",
                "Bidang Keperawatan",
                "Bidang Penunjang Medis"
            ],
            "Wadir Admin & Keuangan": [
                "Bagian Tata Usaha",
                "Bagian Keuangan & Akuntansi",
                "Bagian Perencanaan & Program"
            ]
        };

        $(document).ready(function() {
            // Check Session Login
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
            }

            // Handle Login Submit
            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                
                showLoading(true);
                // Cek Login ke GAS
                fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ type: 'login', password: pass })
                })
                .then(res => res.json())
                .then(res => {
                    showLoading(false);
                    if (res.status === 'success') {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        showApp();
                    } else {
                        Swal.fire('Gagal', res.message, 'error');
                    }
                })
                .catch(err => {
                    showLoading(false);
                    Swal.fire('Error', 'Gagal menghubungi server', 'error');
                });
            });

            // Initialize DataTables
            const dtMasuk = $('#tableMasuk').DataTable({
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "order": [[ 0, "desc" ]]
            });
            const dtKeluar = $('#tableKeluar').DataTable({
                "language": { "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" },
                "order": [[ 0, "desc" ]]
            });

            // Handler Dropdown Wadir Change
            $('#disposisiWadir').change(function() {
                const wadir = $(this).val();
                const bidangSelect = $('#disposisiBidang');
                
                bidangSelect.empty().append('<option value="" selected disabled>Pilih Bagian/Bidang...</option>');
                
                if (wadir && structureOrg[wadir]) {
                    structureOrg[wadir].forEach(function(bidang) {
                        bidangSelect.append(new Option(bidang, bidang));
                    });
                    bidangSelect.prop('disabled', false);
                } else {
                    bidangSelect.prop('disabled', true);
                }
            });

            // === Handle Form Submit Surat Masuk ===
            $('#formSuratMasuk').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratMasuk');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_masuk",
                    noAgenda: $('input[name="noAgenda"]').val(),
                    noSurat: $('input[name="noSurat"]').val(),
                    tglTerima: $('input[name="tglTerima"]').val(),
                    pengirim: $('input[name="pengirim"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    disposisiWadir: $('#disposisiWadir').val(),
                    disposisiBidang: $('#disposisiBidang').val(),
                    isiDisposisi: $('textarea[name="isiDisposisi"]').val(), // New Field
                    tglDisposisi: $('input[name="tglDisposisi"]').val(),     // New Field
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratMasuk')[0].reset();
                    $('#disposisiBidang').prop('disabled', true);
                    loadDataMasuk();
                });
            });

            // === Handle Form Submit Surat Keluar ===
            $('#formSuratKeluar').on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);

                const fileInput = document.getElementById('fileSuratKeluar');
                let fileData = "";
                let fileName = "";

                if (fileInput.files.length > 0) {
                    try {
                        const file = fileInput.files[0];
                        fileName = file.name;
                        fileData = await readFileToBase64(file);
                    } catch (err) {
                        Swal.fire('Error', 'Gagal memproses file', 'error');
                        showLoading(false);
                        return;
                    }
                }

                const formData = {
                    type: "simpan_keluar",
                    noSurat: $('input[name="noSurat"]').val(),
                    tglSurat: $('input[name="tglSurat"]').val(),
                    tujuan: $('input[name="tujuan"]').val(),
                    perihal: $('textarea[name="perihal"]').val(),
                    pembuat: $('input[name="pembuat"]').val(),
                    fileData: fileData,
                    fileName: fileName
                };

                sendData(formData, () => {
                    $('#formSuratKeluar')[0].reset();
                    loadDataKeluar();
                });
            });
        });

        // ================= FUNCTIONS =================

        function showApp() {
            $('#loginSection').fadeOut(300, function() {
                $('#appContent').fadeIn(300);
                loadDataMasuk();
                loadDataKeluar();
            });
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            location.reload();
        }

        function showChangePassword() {
            Swal.fire({
                title: 'Ganti Password Admin',
                html:
                    '<input id="swal-input1" class="swal2-input" placeholder="Password Lama">' +
                    '<input id="swal-input2" class="swal2-input" placeholder="Password Baru">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Simpan',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-input1').value,
                        document.getElementById('swal-input2').value
                    ]
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const [oldPass, newPass] = result.value;
                    if(!oldPass || !newPass) return;

                    showLoading(true);
                    fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ type: 'change_password', oldPassword: oldPass, newPassword: newPass })
                    })
                    .then(res => res.json())
                    .then(res => {
                        showLoading(false);
                        if (res.status === 'success') {
                            Swal.fire('Sukses', 'Password berhasil diubah', 'success');
                        } else {
                            Swal.fire('Gagal', res.message, 'error');
                        }
                    });
                }
            })
        }

        function sendData(data, callback) {
            // Menggunakan fetch dengan method POST dan body text/plain (bukan JSON)
            // untuk menghindari preflight CORS issue pada GAS
            fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showLoading(false);
                if (result.status === 'success') {
                    Swal.fire('Berhasil!', 'Data telah disimpan.', 'success');
                    if (callback) callback();
                } else {
                    Swal.fire('Gagal', result.message, 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Error:', error);
                Swal.fire('Error', 'Terjadi kesalahan koneksi.', 'error');
            });
        }

        function loadDataMasuk() {
            // Show loading indicator on table (optional) or just fetch silently
            fetch(`${GAS_URL}?action=read_masuk`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableMasuk').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            // Mapping Array Row dari GAS ke Kolom Table
                            // Row: [Timestamp, Agenda, NoSurat, TglTerima, Pengirim, Perihal, Link, Wadir, Bidang, IsiDisp, TglDisp, Status]
                            // Indices: 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11
                            
                            let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-info text-white"><i class="fas fa-file-download"></i> Lihat</a>` : '-';
                            let tgl = new Date(row[3]).toLocaleDateString('id-ID');
                            let dispContent = `<b>${row[7]}</b><br><small>${row[8]}</small>`;
                            
                            // Tambahan info disposisi jika ada
                            if(row[9]) dispContent += `<br><span class="badge bg-warning text-dark mt-1" title="Isi Disposisi"><i class="fas fa-comment-dots"></i> ${row[9]}</span>`;
                            
                            dt.row.add([
                                tgl,
                                row[1], // Agenda
                                row[4], // Pengirim
                                dispContent, // Disposisi Lengkap
                                row[5], // Perihal
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                })
                .catch(err => console.error("Gagal load data masuk", err));
        }

        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`)
                .then(res => res.json())
                .then(res => {
                    const dt = $('#tableKeluar').DataTable();
                    dt.clear();
                    
                    if (res.data) {
                        res.data.forEach(row => {
                            // Row: [Timestamp, NoSurat, TglSurat, Tujuan, Perihal, Link, Pembuat]
                            // Indices: 0, 1, 2, 3, 4, 5, 6
                            
                            let btnFile = row[5] ? `<a href="${row[5]}" target="_blank" class="btn btn-sm btn-info text-white"><i class="fas fa-file-download"></i> Lihat</a>` : '-';
                            let tgl = new Date(row[2]).toLocaleDateString('id-ID');

                            dt.row.add([
                                tgl,
                                row[1], // No Surat
                                row[3], // Tujuan
                                row[4], // Perihal
                                btnFile
                            ]);
                        });
                        dt.draw();
                    }
                })
                .catch(err => console.error("Gagal load data keluar", err));
        }

        function readFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function showLoading(show) {
            if (show) $('#loadingOverlay').css('display', 'flex');
            else $('#loadingOverlay').hide();
        }
    </script>
</body>
</html>
