<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    <link rel="icon" href="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" type="image/png">
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #f97316; 
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #9a3412 0%, #0f172a 100%);
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Defaults */
        .glass-panel, .card, .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
        }
        
        .card { margin-bottom: 25px; border-radius: 16px; transition: transform 0.2s; }
        .modal-content { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }

        /* Login */
        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 2.5rem; }
        .form-control { background: rgba(255, 255, 255, 0.9); border: none; border-radius: 8px; padding: 12px; }
        .form-control:focus { background: #fff; box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.25); }
        .btn-primary { background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent)); border: none; padding: 12px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(249, 115, 22, 0.4); }

        /* Main App Container (Hidden by Default) */
        #appContent { display: none; width: 100%; min-height: 100vh; }

        /* Sidebar Toggle Logic */
        .wrapper { display: flex; width: 100%; align-items: stretch; transition: all 0.3s; }
        
        #sidebar {
            min-width: var(--sidebar-width); 
            max-width: var(--sidebar-width); 
            background: rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(15px); 
            border-right: 1px solid var(--glass-border); 
            color: #fff; 
            transition: all 0.3s; 
            position: fixed; 
            height: 100vh; 
            z-index: 1000;
            margin-left: 0;
        }
        
        #sidebar.toggled {
            margin-left: calc(var(--sidebar-width) * -1);
        }

        #content {
            width: 100%; 
            padding: 20px; 
            margin-left: var(--sidebar-width); 
            transition: all 0.3s;
        }
        
        #content.toggled {
            margin-left: 0;
        }

        /* Toggle Button */
        #sidebarCollapse {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        #sidebarCollapse:hover { background: var(--emerald-accent); }

        /* ARSIP SPECIFIC STYLES (Light Theme & Compact) */
        #arsip-masuk-content .card, 
        #arsip-keluar-content .card,
        #disposisi-container .card {
            background: #ffffff !important; /* Putih Solid */
            backdrop-filter: none;
            color: #333333; /* Teks Hitam */
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #arsip-masuk-content .card-header,
        #arsip-keluar-content .card-header {
            background-color: #fff7ed; /* Light Orange Background */
            border-bottom: 2px solid #ffedd5;
            color: #c2410c; /* Dark Orange Text */
        }

        #disposisi-container .card-header {
            background-color: #fffbeb; 
            border-bottom: 2px solid #fcd34d;
            color: #b45309; 
        }

        #arsip-masuk-content .table,
        #arsip-keluar-content .table,
        #disposisi-container .table {
            color: #333 !important;
            font-size: 0.9rem;
        }
        
        #arsip-masuk-content .table th,
        #arsip-keluar-content .table th,
        #disposisi-container .table th {
            background-color: #ffedd5; /* Light Orange Header */
            color: #9a3412;
            padding: 8px 8px;
            font-weight: 600;
        }

        #arsip-masuk-content .table td,
        #arsip-keluar-content .table td,
        #disposisi-container .table td {
            padding: 4px 8px;
            vertical-align: middle;
            border-color: #fed7aa; /* Orange border */
        }

        #tableMasuk tbody tr,
        #tableKeluar tbody tr,
        #tableDisposisi tbody tr {
            background-color: transparent !important;
            color: #333 !important;
        }

        .table-striped > tbody > tr:nth-of-type(odd) > * {
            background-color: rgba(255, 237, 213, 0.3) !important; /* Very Light Orange Striped */
            color: #333 !important;
        }

        .table-hover tbody tr:hover > * {
            background-color: #ffedd5 !important; /* Hover Highlight */
            color: #000 !important;
        }

        #arsip-masuk-content .page-link,
        #arsip-keluar-content .page-link,
        #disposisi-container .page-link {
            background: white;
            color: #c2410c; /* Dark Orange */
            border: 1px solid #fed7aa;
        }
        #arsip-masuk-content .page-item.active .page-link,
        #arsip-keluar-content .page-item.active .page-link {
            background: #f97316; /* Orange */
            color: white;
            border-color: #f97316;
        }
        
        #arsip-masuk-content .form-control, 
        #arsip-keluar-content .form-control,
        #disposisi-container .form-control,
        #arsip-masuk-content .form-select, 
        #arsip-keluar-content .form-select,
        #disposisi-container .form-select { 
            background: #fff; border: 1px solid #ced4da; color: #333; 
        }
        
        #arsip-masuk-content .dataTables_info,
        #arsip-keluar-content .dataTables_info,
        #disposisi-container .dataTables_info { color: #6c757d !important; font-size: 0.85rem; }

        /* Nav Pills */
        .nav-pills .nav-link { color: rgba(255, 255, 255, 0.7); border-radius: 10px; padding: 12px 20px; margin-bottom: 8px; text-align: left; display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease-in-out; }
        .nav-pills .nav-link:hover { background: rgba(255, 255, 255, 0.1); color: #fff; transform: translateX(5px); }
        .nav-pills .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; }
        .nav-link i { width: 25px; margin-right: 10px; }

        .submenu { padding-left: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; }
        .submenu .nav-link { font-size: 0.9em; padding: 8px 15px; border-left: none !important; }
        .submenu .nav-link.active { background: rgba(255,255,255,0.1); color: var(--emerald-accent); font-weight: bold; transform: none; }
        .badge-count { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; margin-left: auto; background: var(--blue-accent); color: white; display: none; }
        .badge-count.has-data { display: inline-block; background: #ef4444; }

        .tab-pane { transition: opacity 0.3s ease-in-out; opacity: 0; display: none; }
        .tab-pane.active { display: block; }
        .tab-pane.show { opacity: 1; }

        .form-container-limit { max-width: 900px; margin: 0 auto; }
        .card-header { background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid var(--glass-border); color: var(--emerald-accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        
        .timeline-item { padding-left: 30px; border-left: 2px solid rgba(255,255,255,0.2); position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--blue-accent); border: 2px solid #fff; }
        .timeline-item.done::before { background: var(--emerald-accent); }
        .timeline-content { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }

        @media (max-width: 991.98px) {
            #sidebar { margin-left: calc(var(--sidebar-width) * -1); }
            #sidebar.toggled { margin-left: 0; }
            #content { margin-left: 0; }
        }

        #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="glass-panel login-card text-center">
            <div class="mb-4">
                <!-- UPDATED LOGO -->
                <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo RSUD" style="width: 100px; height: auto;" class="mb-3">
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Informasi Manajemen Arsip Surat<br>RSUD dr. R. Koesma</p>
            </div>
            <form id="formLogin">
                <div class="mb-4 text-start">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Kode Akses Admin" required>
                </div>
                <div class="d-grid"><button type="submit" class="btn btn-primary shadow-lg">MASUK APLIKASI</button></div>
            </form>
        </div>
    </div>

    <div id="appContent">
        <div class="wrapper">
            <!-- SIDEBAR -->
            <nav id="sidebar">
                <div class="sidebar-header text-center position-relative">
                    <!-- Tombol Close Khusus Mobile -->
                    <button type="button" id="sidebarCloseMobile" class="btn btn-sm btn-outline-light d-lg-none position-absolute top-0 end-0 m-2">
                        <i class="fas fa-times"></i>
                    </button>

                    <!-- UPDATED LOGO -->
                    <img src="https://github.com/koesmasurat/simas/blob/main/logo%20rsud%202%20png.png?raw=true" alt="Logo" class="mb-2" style="width: 60px; height: auto;">
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50">Admin Panel</small>
                </div>
                <div class="p-3">
                    <div class="nav flex-column nav-pills">
                        
                        <!-- Added IDs to buttons for state persistence -->
                        <button class="nav-link active" id="btn-input-masuk" onclick="activateTab('input-masuk-content', this)">
                            <i class="fas fa-plus-circle"></i> Surat Masuk
                        </button>
                        <button class="nav-link" id="btn-input-keluar" onclick="activateTab('input-keluar-content', this)">
                            <i class="fas fa-paper-plane"></i> Surat Keluar
                        </button>

                        <div class="sidebar-divider"></div>

                        <a class="nav-link text-warning" data-bs-toggle="collapse" href="#submenuDisposisi" role="button" aria-expanded="false">
                            <i class="fas fa-tasks"></i> Menu Disposisi <i class="fas fa-chevron-down ms-auto small"></i>
                        </a>
                        <div class="collapse submenu" id="submenuDisposisi">
                            <button class="nav-link w-100 d-flex justify-content-between" id="btn-disp-direktur" onclick="openDisposisiPage('direktur', this)">
                                <span>1. Direktur</span> <span class="badge-count" id="count-direktur">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" id="btn-disp-wadir" onclick="openDisposisiPage('wadir', this)">
                                <span>2. Wadir</span> <span class="badge-count" id="count-wadir">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" id="btn-disp-kabid" onclick="openDisposisiPage('kabid', this)">
                                <span>3. Kabag/Kabid</span> <span class="badge-count" id="count-kabid">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" id="btn-disp-jf" onclick="openDisposisiPage('jf', this)">
                                <span>4. JF (Final)</span> <span class="badge-count" id="count-jf">0</span>
                            </button>
                        </div>

                        <div class="sidebar-divider"></div>

                        <button class="nav-link" id="btn-arsip-masuk" onclick="activateTab('arsip-masuk-content', this, loadDataMasuk)">
                            <i class="fas fa-inbox"></i> Arsip Masuk
                        </button>
                        <button class="nav-link" id="btn-arsip-keluar" onclick="activateTab('arsip-keluar-content', this, loadDataKeluar)">
                            <i class="fas fa-archive"></i> Arsip Keluar
                        </button>
                    </div>
                </div>
                <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
                    <button class="btn btn-danger w-100 btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button>
                </div>
            </nav>

            <!-- CONTENT -->
            <div id="content">
                
                <!-- NAVBAR TOGGLE BUTTON -->
                <button type="button" id="sidebarCollapse" class="btn">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="tab-content">
                    
                    <!-- INPUT MASUK -->
                    <div class="tab-pane active show" id="input-masuk-content">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-info">Surat Masuk</b></h2>
                            <div class="card">
                                <div class="card-body p-4">
                                    <form id="formSuratMasuk">
                                        <div class="row">
                                            <div class="col-md-4 mb-3"><label class="small text-white-50">No. Agenda (Auto)</label><input type="text" class="form-control" name="noAgenda" required></div>
                                            <div class="col-md-4 mb-3"><label class="small text-white-50">Tanggal Surat</label><input type="date" class="form-control" name="tglSurat" required></div>
                                            <div class="col-md-4 mb-3"><label class="small text-white-50">Tanggal Terima</label><input type="date" class="form-control" name="tglTerima" required></div>
                                        </div>
                                        <div class="mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" name="noSurat" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Pengirim</label><input type="text" class="form-control" name="pengirim" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                        <div class="mb-4"><label class="small text-white-50">File (PDF/Img)</label><input type="file" class="form-control" id="fileSuratMasuk"></div>
                                        <div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- INPUT KELUAR -->
                    <div class="tab-pane" id="input-keluar-content">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-success">Surat Keluar</b></h2>
                            <div class="card">
                                <div class="card-body p-4">
                                    <form id="formSuratKeluar">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="small text-white-50">No. Agenda (Auto)</label>
                                                <div class="input-group">
                                                    <input type="text" class="form-control" name="noAgenda" id="outNoAgenda" required>
                                                    <button class="btn btn-warning" type="button" onclick="openBookingModal()">Booking No.</button>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3"><label class="small text-white-50">Tanggal Surat Diterima</label><input type="date" class="form-control" name="tglSurat" required></div>
                                        </div>
                                        <div class="mb-3"><label class="small text-white-50">No. Surat (Format Dinas)</label><input type="text" class="form-control" name="noSurat" required placeholder="Contoh: 445/001/405.08/2024"></div>
                                        <div class="mb-3"><label class="small text-white-50">Tujuan</label><input type="text" class="form-control" name="tujuan" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                        <div class="mb-3"><label class="small text-white-50">Pembuat</label><input type="text" class="form-control" name="pembuat"></div>
                                        <div class="mb-4"><label class="small text-white-50">File</label><input type="file" class="form-control" id="fileSuratKeluar"></div>
                                        <div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DYNAMIC DISPOSISI PAGE (Light Theme) -->
                    <div class="tab-pane" id="disposisi-container">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Inbox Disposisi: <b class="text-warning" id="dispPageTitle">Direktur</b></h2>
                            <button class="btn btn-outline-light" onclick="refreshCurrentDisposisi()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        </div>
                        <div class="card shadow-lg">
                            <div class="card-header border-bottom">
                                <i class="fas fa-tasks me-2"></i> Daftar Tunggu
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableDisposisi" class="table table-striped table-hover table-sm w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th>File</th><th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARSIP MASUK (Light Theme & Compact) -->
                    <div class="tab-pane" id="arsip-masuk-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-info">Surat Masuk</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                        </div>
                        <div class="card shadow-lg">
                            <div class="card-header bg-light border-bottom">
                                <i class="fas fa-table me-2"></i> Data Surat Masuk
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableMasuk" class="table table-striped table-hover table-sm w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th>Tgl Terima</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th>
                                                <th>Status</th><th>File</th><th class="text-center">History</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARSIP KELUAR (Light Theme & Compact) -->
                    <div class="tab-pane" id="arsip-keluar-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-success">Surat Keluar</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                        </div>
                        <div class="card shadow-lg">
                            <div class="card-header bg-light border-bottom">
                                <i class="fas fa-table me-2"></i> Data Surat Keluar
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableKeluar" class="table table-striped table-hover table-sm w-100 align-middle">
                                        <thead>
                                            <tr><th>Tgl Diterima</th><th>No. Surat</th><th>Tujuan</th><th>Perihal</th><th>File</th><th>Status</th></tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROCESS DISPOSISI -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Proses Disposisi: <span id="modalDispLevelTitle" class="text-warning"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDisposisiAction">
                        <input type="hidden" id="actNoAgenda">
                        <div class="alert alert-light border border-secondary text-dark mb-3 p-3 shadow-sm rounded">
                            <small class="text-muted text-uppercase d-block mb-1 font-weight-bold">Perihal Surat:</small>
                            <span id="actPerihal" class="fw-bold fs-6"></span>
                        </div>
                        <div id="fieldDirektur" class="disp-field d-none">
                            <label class="small text-info">Tujuan Wadir</label>
                            <select class="form-select mb-2" id="actTargetWadir">
                                <option value="Wadir Pelayanan">Wadir Pelayanan</option>
                                <option value="Wadir Admin & Keuangan">Wadir Admin & Keuangan</option>
                            </select>
                        </div>
                        <div id="fieldWadir" class="disp-field d-none">
                            <label class="small text-info">Tujuan Bidang/Bagian</label>
                            <select class="form-select mb-2" id="actTargetBidang"></select>
                        </div>
                        <div id="fieldKabid" class="disp-field d-none">
                            <label class="small text-info">Nama JF Tujuan</label>
                            <input type="text" class="form-control mb-2" id="actTargetJF" placeholder="Nama JF...">
                        </div>
                        <div id="fieldJF" class="disp-field d-none">
                            <label class="small text-info">Nama Staf Pelaksana</label>
                            <input type="text" class="form-control mb-2" id="actTargetStaf" placeholder="Nama Staf...">
                        </div>
                        <label class="small text-white-50 mt-2">Isi Instruksi</label>
                        <textarea class="form-control mb-3" id="actInstruksi" rows="3" placeholder="Instruksi..."></textarea>
                        <label class="small text-white-50">Tanggal Proses</label>
                        <input type="date" class="form-control" id="actTgl" required>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-primary w-100" onclick="submitDisposisiLevel()">Kirim Disposisi</button></div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORY TIMELINE -->
    <div class="modal fade" id="modalHistory" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Riwayat Perjalanan Surat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body"><div id="timelineContent" class="ps-2 pt-2"></div></div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" style="display:none;"><div class="spinner-border text-info" style="width: 4rem; height: 4rem;"></div><div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        let currentLevel = ""; 
        const structureOrg = {
            "Wadir Pelayanan": ["Bidang Pelayanan Medis", "Bidang Keperawatan", "Bidang Penunjang Medis"],
            "Wadir Admin & Keuangan": ["Bagian Tata Usaha", "Bagian Keuangan & Akuntansi", "Bagian Perencanaan & Program"]
        };

        $(document).ready(function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
                loadCounters(); 
                restoreState(); // Restore Tab State
            }
            
            const today = new Date();
            document.querySelectorAll('input[type="date"]').forEach(el => el.valueAsDate = today);
            
            // Sidebar Toggle & Close Mobile
            $('#sidebarCollapse, #sidebarCloseMobile').on('click', function() {
                $('#sidebar, #content').toggleClass('toggled');
            });
            
            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                showLoading(true);
                fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'login', password: $('#loginPassword').val() }) })
                .then(r => r.json()).then(r => {
                    showLoading(false);
                    if (r.status === 'success') { 
                        sessionStorage.setItem('isLoggedIn', 'true'); 
                        showApp(); 
                        loadCounters();
                        restoreState(); 
                    }
                    else Swal.fire({ icon: 'error', title: 'Gagal', text: r.message });
                }).catch(e => { showLoading(false); Swal.fire('Error', 'Koneksi', 'error'); });
            });

            const dtConfig = { language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" }, pageLength: 10, autoWidth: false };
            $('#tableDisposisi').DataTable(dtConfig);
            $('#tableMasuk').DataTable(dtConfig);
            $('#tableKeluar').DataTable(dtConfig);

            setupSimpleForm('#formSuratMasuk', 'simpan_masuk', 'Tercatat.');
            setupSimpleForm('#formSuratKeluar', 'simpan_keluar', 'Tercatat.');
            
            // Auto collapse submenu if not clicked
            $('button[onclick^="activateTab"]').on('click', function (e) { $('.submenu .nav-link').removeClass('active'); });
        });

        function restoreState() {
            const lastBtnId = sessionStorage.getItem('lastActiveBtn');
            if(lastBtnId && $('#'+lastBtnId).length) {
                // If button is inside submenu, open submenu
                if($('#'+lastBtnId).closest('.submenu').length) {
                    $('#submenuDisposisi').addClass('show');
                    $('a[href="#submenuDisposisi"]').removeClass('collapsed').attr('aria-expanded', 'true');
                }
                $('#'+lastBtnId).click();
            }
        }

        function loadCounters() {
            fetch(`${GAS_URL}?action=get_counts`).then(r=>r.json()).then(r => {
                if(r.status === 'success') {
                    setCount('direktur', r.data.direktur);
                    setCount('wadir', r.data.wadir);
                    setCount('kabid', r.data.kabid);
                    setCount('jf', r.data.jf);
                }
            });
            fetch(`${GAS_URL}?action=get_auto_numbers`).then(r=>r.json()).then(r => {
                if(r.status === 'success') {
                    $('input[name="noAgenda"]').val(r.data.masuk);
                    $('#outNoAgenda').val(r.data.keluar);
                }
            });
        }

        function openBookingModal() {
            Swal.fire({
                title: 'Booking Nomor Agenda',
                text: 'Masukkan jumlah nomor yang ingin diloncati/dibooking:',
                input: 'number',
                inputAttributes: { min: 1 },
                showCancelButton: true,
                confirmButtonText: 'Booking Sekarang',
                showLoaderOnConfirm: true,
                preConfirm: (amount) => {
                    return fetch(GAS_URL, {
                        method: 'POST',
                        body: JSON.stringify({ type: 'booking_keluar', amount: amount })
                    }).then(response => {
                        if (!response.ok) throw new Error(response.statusText);
                        return response.json();
                    }).catch(error => { Swal.showValidationMessage(`Request failed: ${error}`); });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    const nextNum = result.value.data.nextAvailable;
                    $('#outNoAgenda').val(nextNum);
                    Swal.fire('Berhasil', `Nomor berhasil dibooking. Nomor agenda berikutnya: ${nextNum}`, 'success');
                }
            });
        }

        function setupSimpleForm(selector, type, msg) {
            $(selector).on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);
                let fileData = "", fileName = "";
                const fileInput = $(this).find('input[type="file"]')[0];
                if (fileInput.files.length > 0) {
                    try { fileData = await readFileToBase64(fileInput.files[0]); fileName = fileInput.files[0].name; } 
                    catch(e) { showLoading(false); return Swal.fire('Error File', '', 'error'); }
                }
                const formData = { type: type, fileData: fileData, fileName: fileName };
                $(this).serializeArray().forEach(item => formData[item.name] = item.value);
                
                sendData(formData, () => {
                    $(selector)[0].reset();
                    document.querySelectorAll('input[type="date"]').forEach(el => el.valueAsDate = new Date());
                    loadCounters(); 
                    Swal.fire('Sukses', msg, 'success');
                });
            });
        }

        function logout() {
            Swal.fire({
                title: 'Konfirmasi Logout',
                text: "Anda yakin ingin keluar?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Keluar'
            }).then((result) => {
                if (result.isConfirmed) {
                    sessionStorage.removeItem('isLoggedIn');
                    sessionStorage.removeItem('lastActiveBtn'); // Clear state on logout
                    $('#appContent').stop().hide(); 
                    $('#loginSection').stop().css('display', 'flex').hide().fadeIn(300);
                    setTimeout(() => { location.reload(); }, 500); 
                }
            });
        }

        function activateTab(tabId, element, callback) {
            if(element && element.id) sessionStorage.setItem('lastActiveBtn', element.id); // Save State
            
            $('#sidebar .nav-link').removeClass('active'); $('.submenu .nav-link').removeClass('active'); 
            if(element) $(element).addClass('active');
            $('.tab-pane').removeClass('show active'); 
            const target = $('#' + tabId); target.addClass('active');
            setTimeout(() => { target.addClass('show'); }, 50);
            
            if ($(window).width() <= 991) {
                $('#sidebar, #content').removeClass('toggled');
            }

            if (callback) callback();
        }
        
        function openDisposisiPage(level, element) {
            if(element && element.id) sessionStorage.setItem('lastActiveBtn', element.id); // Save State
            
            currentLevel = level; 
            // Call activateTab internally just for transitions, callback is separate
            $('#sidebar .nav-link').removeClass('active'); $('.submenu .nav-link').removeClass('active'); 
            if(element) $(element).addClass('active');
            $('.tab-pane').removeClass('show active'); 
            $('#disposisi-container').addClass('active').addClass('show');
            
            if ($(window).width() <= 991) $('#sidebar, #content').removeClass('toggled');

            $('#dispPageTitle').text(level === 'kabid' ? "KABAG / KABID" : level.toUpperCase());
            refreshCurrentDisposisi();
        }
        
        function refreshCurrentDisposisi() {
            showLoading(true);
            fetch(`${GAS_URL}?action=read_pending&level=${currentLevel}`).then(r=>r.json()).then(r => {
                showLoading(false);
                const dt = $('#tableDisposisi').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    let btnFile = row[7] ? `<a href="${row[7]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                    let btnProses = `<button class="btn btn-sm btn-warning fw-bold" onclick='openModalAction(${JSON.stringify(row)})'>Proses</button>`;
                    dt.row.add([ new Date(row[4]).toLocaleDateString('id-ID'), row[1], row[5], row[6], btnFile, btnProses ]);
                });
                dt.draw();
            });
        }
        function openModalAction(rowData) {
            $('#actNoAgenda').val(rowData[1]); $('#actPerihal').text(rowData[6]); 
            document.querySelector('#actTgl').valueAsDate = new Date(); $('#actInstruksi').val('');
            $('#modalDispLevelTitle').text(currentLevel.toUpperCase()); $('.disp-field').addClass('d-none');
            if(currentLevel === 'direktur') $('#fieldDirektur').removeClass('d-none');
            else if (currentLevel === 'wadir') {
                $('#fieldWadir').removeClass('d-none');
                let html = (structureOrg[rowData[8]] || []).map(o => `<option value="${o}">${o}</option>`).join('');
                $('#actTargetBidang').html(html);
            } else if (currentLevel === 'kabid') $('#fieldKabid').removeClass('d-none');
            else if (currentLevel === 'jf') $('#fieldJF').removeClass('d-none');
            new bootstrap.Modal(document.getElementById('modalDisposisi')).show();
        }
        function submitDisposisiLevel() {
            const formData = { type: 'update_disposisi_level', level: currentLevel, noAgenda: $('#actNoAgenda').val(), tglDisposisi: $('#actTgl').val(), instruksi: $('#actInstruksi').val() };
            if(currentLevel === 'direktur') formData.targetWadir = $('#actTargetWadir').val();
            if(currentLevel === 'wadir') formData.targetBidang = $('#actTargetBidang').val();
            if(currentLevel === 'kabid') formData.targetJF = $('#actTargetJF').val();
            if(currentLevel === 'jf') formData.targetStaf = $('#actTargetStaf').val();
            bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide();
            showLoading(true);
            sendData(formData, () => { refreshCurrentDisposisi(); loadCounters(); Swal.fire('Sukses', 'Disposisi Terkirim', 'success'); });
        }
        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`).then(r=>r.json()).then(r=>{
                const dt = $('#tableMasuk').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    let btnFile = row[7] ? `<a href="${row[7]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                    let status = `<span class="badge bg-secondary">${row[20]}</span>`;
                    if(row[20] === 'Selesai') status = `<span class="badge bg-success">Selesai</span>`;
                    let btnHistory = `<button class="btn btn-sm btn-light text-primary border" onclick='viewHistory(${JSON.stringify(row)})'><i class="fas fa-eye"></i></button>`;
                    dt.row.add([ new Date(row[4]).toLocaleDateString('id-ID'), row[1], row[5], row[6], status, btnFile, btnHistory ]);
                });
                dt.draw();
            });
        }
        function viewHistory(row) {
            let html = createTimelineItem(true, "SURAT DITERIMA", `Agenda: ${row[1]}`, `Tgl Surat: ${new Date(row[3]).toLocaleDateString('id-ID')}`, row[0]);
            if(row[8]) html += createTimelineItem(true, "DIREKTUR", `Ke: ${row[8]}`, row[9], row[10]); else html += createTimelineItem(false, "DIREKTUR", "Menunggu Proses", "", "");
            if(row[11]) html += createTimelineItem(true, "WADIR", `Ke: ${row[11]}`, row[12], row[13]);
            if(row[14]) html += createTimelineItem(true, "KABAG/KABID", `Ke: ${row[14]}`, row[15], row[16]);
            if(row[17]) html += createTimelineItem(true, "JF", `Ke Staf: ${row[17]}`, row[18], row[19]);
            $('#timelineContent').html(html);
            new bootstrap.Modal(document.getElementById('modalHistory')).show();
        }
        function formatDateTime(dateString) {
            if(!dateString) return '';
            const d = new Date(dateString);
            if(isNaN(d.getTime())) return '';
            return d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        }
        function createTimelineItem(isDone, title, target, note, date) {
            let cls = isDone ? 'done' : '';
            let dateStr = date ? `<span class="badge bg-dark ms-2">${formatDateTime(date)}</span>` : '';
            return `<div class="timeline-item ${cls}"><div class="fw-bold text-warning small d-flex justify-content-between"><span>${title}</span>${dateStr}</div><div class="timeline-content mt-1"><div class="fw-bold small mb-1">${target}</div><div class="text-white-50 small fst-italic">"${note || '-'}"</div></div></div>`;
        }
        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`).then(r=>r.json()).then(r=>{
                const dt = $('#tableKeluar').DataTable(); dt.clear();
                if(r.data) r.data.forEach(row => {
                    let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                    let status = row[8] === 'Selesai' ? `<span class="badge bg-success">Selesai</span>` : `<span class="badge bg-warning text-dark">Proses</span> <button class="btn btn-sm btn-outline-success ms-2 py-0" onclick="updateStatusSelesai('${row[2]}')"><i class="fas fa-check"></i></button>`;
                    dt.row.add([ new Date(row[2]).toLocaleDateString('id-ID'), row[1], row[3], row[4], btnFile, status ]);
                });
                dt.draw();
            });
        }
        function updateStatusSelesai(noSurat) {
            Swal.fire({ title: 'Konfirmasi', text: "Tandai Selesai?", icon: 'question', showCancelButton: true, confirmButtonText: 'Ya' }).then((r) => {
                if(r.isConfirmed) { showLoading(true); fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'update_status_keluar', noSurat: noSurat }) }).then(r=>r.json()).then(r=>{ showLoading(false); if(r.status==='success') { Swal.fire('Berhasil', '', 'success'); loadDataKeluar(); }}); }
            });
        }
        function setCount(id, c) { $(`#count-${id}`).text(c).toggleClass('has-data', c > 0); }
        function showApp() { $('#loginSection').fadeOut(300, ()=> $('#appContent').fadeIn(300)); }
        function showLoading(show) { $('#loadingOverlay').css('display', show ? 'flex' : 'none'); }
        function sendData(data, cb) { fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(r=>r.json()).then(r=> { showLoading(false); if(r.status==='success') cb(); else Swal.fire('Gagal', r.message, 'error'); }); }
        function readFileToBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result); r.onerror = e => rej(e); }); }
        function showChangePassword() { /* Logic same as previous */ }
    </script>
</body>
</html>
