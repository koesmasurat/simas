<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMAS KOESMA - RSUD dr. R. Koesma</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --text-light: #f8f9fa;
            --emerald-accent: #10b981;
            --blue-accent: #3b82f6;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #064e3b 0%, #0f172a 100%);
            background-attachment: fixed;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism */
        .glass-panel, .card, .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            color: white;
        }
        
        .card { margin-bottom: 25px; border-radius: 16px; transition: transform 0.2s; }
        .modal-content { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }

        /* Login */
        #loginSection { height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; z-index: 10; }
        .login-card { width: 100%; max-width: 400px; padding: 2.5rem; }
        .form-control { background: rgba(255, 255, 255, 0.9); border: none; border-radius: 8px; padding: 12px; }
        .form-control:focus { background: #fff; box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.25); }
        .btn-primary { background: linear-gradient(45deg, var(--emerald-accent), var(--blue-accent)); border: none; padding: 12px; border-radius: 8px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }

        /* Sidebar & Layout */
        #appContent { display: none; min-height: 100vh; }
        .wrapper { display: flex; width: 100%; align-items: stretch; }
        #sidebar { min-width: var(--sidebar-width); max-width: var(--sidebar-width); background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(15px); border-right: 1px solid var(--glass-border); color: #fff; transition: all 0.3s; position: fixed; height: 100vh; z-index: 999; }
        #sidebar .sidebar-header { padding: 20px; background: rgba(255, 255, 255, 0.05); border-bottom: 1px solid var(--glass-border); }
        #content { width: 100%; padding: 20px; margin-left: var(--sidebar-width); transition: all 0.3s; }
        
        .nav-pills .nav-link { color: rgba(255, 255, 255, 0.7); border-radius: 10px; padding: 12px 20px; margin-bottom: 8px; text-align: left; display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease-in-out; }
        .nav-pills .nav-link:hover { background: rgba(255, 255, 255, 0.1); color: #fff; transform: translateX(5px); }
        .nav-pills .nav-link.active { background: linear-gradient(90deg, var(--emerald-accent), transparent); color: #fff; border-left: 4px solid #fff; }
        .nav-link i { width: 25px; margin-right: 10px; }

        /* Submenu & Badges */
        .submenu { padding-left: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 10px; }
        .submenu .nav-link { font-size: 0.9em; padding: 8px 15px; border-left: none !important; }
        .submenu .nav-link.active { background: rgba(255,255,255,0.1); color: var(--emerald-accent); font-weight: bold; transform: none; }
        .badge-count { font-size: 0.75rem; padding: 4px 8px; border-radius: 12px; margin-left: auto; background: var(--blue-accent); color: white; display: none; }
        .badge-count.has-data { display: inline-block; background: #ef4444; }

        /* Tab Transitions */
        .tab-pane { transition: opacity 0.3s ease-in-out; opacity: 0; display: none; }
        .tab-pane.active { display: block; }
        .tab-pane.show { opacity: 1; }

        /* Table & Utils */
        .form-container-limit { max-width: 900px; margin: 0 auto; }
        .card-header { background: rgba(255, 255, 255, 0.1); border-bottom: 1px solid var(--glass-border); color: var(--emerald-accent); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        table.dataTable tbody tr { background-color: transparent !important; color: white !important; }
        .table { color: white !important; --bs-table-bg: transparent; --bs-table-striped-bg: rgba(255,255,255,0.05); --bs-table-hover-bg: rgba(16, 185, 129, 0.2); --bs-table-border-color: rgba(255,255,255,0.2); }
        .page-link { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); color: white; }
        .page-item.active .page-link { background-color: var(--emerald-accent); border-color: var(--emerald-accent); }
        
        /* Timeline */
        .timeline-item { padding-left: 30px; border-left: 2px solid rgba(255,255,255,0.2); position: relative; padding-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -9px; top: 0; width: 16px; height: 16px; border-radius: 50%; background: var(--blue-accent); border: 2px solid #fff; }
        .timeline-item.done::before { background: var(--emerald-accent); }
        .timeline-content { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }

        @media (max-width: 991.98px) {
            #sidebar { position: relative; height: auto; min-width: 100%; max-width: 100%; }
            #content { margin-left: 0; }
        }

        #loadingOverlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10000; display: none; justify-content: center; align-items: center; flex-direction: column; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="loginSection">
        <div class="glass-panel login-card text-center">
            <div class="mb-4">
                <div class="bg-white rounded-circle d-inline-flex justify-content-center align-items-center mb-3" style="width: 80px; height: 80px;">
                    <i class="fas fa-hospital-user fa-3x" style="color: var(--emerald-accent);"></i>
                </div>
                <h3 class="fw-bold">SIMAS KOESMA</h3>
                <p class="text-white-50">Sistem Manajemen Persuratan RSUD</p>
            </div>
            <form id="formLogin">
                <div class="mb-4 text-start">
                    <input type="password" class="form-control" id="loginPassword" placeholder="Kode Akses Admin" required>
                </div>
                <div class="d-grid"><button type="submit" class="btn btn-primary shadow-lg">MASUK APLIKASI</button></div>
            </form>
        </div>
    </div>

    <div id="appContent">
        <div class="wrapper">
            <!-- SIDEBAR -->
            <nav id="sidebar">
                <div class="sidebar-header text-center">
                    <i class="fas fa-hospital-alt fa-2x mb-2 text-white"></i>
                    <h5 class="fw-bold m-0">SIMAS KOESMA</h5>
                    <small class="text-white-50">Admin Panel</small>
                </div>
                <div class="p-3">
                    <div class="nav flex-column nav-pills">
                        
                        <button class="nav-link active" onclick="activateTab('input-masuk-content', this)">
                            <i class="fas fa-plus-circle"></i> Surat Masuk
                        </button>
                        <button class="nav-link" onclick="activateTab('input-keluar-content', this)">
                            <i class="fas fa-paper-plane"></i> Surat Keluar
                        </button>

                        <div class="sidebar-divider"></div>

                        <a class="nav-link text-warning" data-bs-toggle="collapse" href="#submenuDisposisi" role="button" aria-expanded="false">
                            <i class="fas fa-tasks"></i> Menu Disposisi <i class="fas fa-chevron-down ms-auto small"></i>
                        </a>
                        <div class="collapse submenu" id="submenuDisposisi">
                            <button class="nav-link w-100 d-flex justify-content-between" onclick="openDisposisiPage('direktur', this)">
                                <span>1. Direktur</span> <span class="badge-count" id="count-direktur">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" onclick="openDisposisiPage('wadir', this)">
                                <span>2. Wadir</span> <span class="badge-count" id="count-wadir">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" onclick="openDisposisiPage('kabid', this)">
                                <span>3. Kabag/Kabid</span> <span class="badge-count" id="count-kabid">0</span>
                            </button>
                            <button class="nav-link w-100 d-flex justify-content-between" onclick="openDisposisiPage('jf', this)">
                                <span>4. JF (Final)</span> <span class="badge-count" id="count-jf">0</span>
                            </button>
                        </div>

                        <div class="sidebar-divider"></div>

                        <button class="nav-link" onclick="activateTab('arsip-masuk-content', this, loadDataMasuk)">
                            <i class="fas fa-inbox"></i> Arsip Masuk
                        </button>
                        <button class="nav-link" onclick="activateTab('arsip-keluar-content', this, loadDataKeluar)">
                            <i class="fas fa-archive"></i> Arsip Keluar
                        </button>
                    </div>
                </div>
                <div class="mt-auto p-3" style="position: absolute; bottom: 0; width: 100%;">
                    <button class="btn btn-danger w-100 btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i> Keluar</button>
                </div>
            </nav>

            <!-- CONTENT -->
            <div id="content">
                <div class="tab-content">
                    
                    <!-- INPUT MASUK -->
                    <div class="tab-pane active show" id="input-masuk-content">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-info">Surat Masuk</b></h2>
                            <div class="card">
                                <div class="card-body p-4">
                                    <form id="formSuratMasuk">
                                        <div class="row">
                                            <div class="col-md-6 mb-3"><label class="small text-white-50">No. Agenda</label><input type="text" class="form-control" name="noAgenda" required></div>
                                            <div class="col-md-6 mb-3"><label class="small text-white-50">Tanggal Terima</label><input type="date" class="form-control" name="tglTerima" required></div>
                                        </div>
                                        <div class="mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" name="noSurat" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Pengirim</label><input type="text" class="form-control" name="pengirim" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                        <div class="mb-4"><label class="small text-white-50">File (PDF/Img)</label><input type="file" class="form-control" id="fileSuratMasuk"></div>
                                        <div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- INPUT KELUAR -->
                    <div class="tab-pane" id="input-keluar-content">
                        <div class="form-container-limit">
                            <h2 class="mb-4 fw-light text-white">Catat <b class="text-success">Surat Keluar</b></h2>
                            <div class="card">
                                <div class="card-body p-4">
                                    <form id="formSuratKeluar">
                                        <div class="row">
                                            <div class="col-md-6 mb-3"><label class="small text-white-50">No. Surat</label><input type="text" class="form-control" name="noSurat" required></div>
                                            <div class="col-md-6 mb-3"><label class="small text-white-50">Tanggal Surat</label><input type="date" class="form-control" name="tglSurat" required></div>
                                        </div>
                                        <div class="mb-3"><label class="small text-white-50">Tujuan</label><input type="text" class="form-control" name="tujuan" required></div>
                                        <div class="mb-3"><label class="small text-white-50">Perihal</label><textarea class="form-control" name="perihal" rows="3" required></textarea></div>
                                        <div class="mb-3"><label class="small text-white-50">Pembuat</label><input type="text" class="form-control" name="pembuat"></div>
                                        <div class="mb-4"><label class="small text-white-50">File</label><input type="file" class="form-control" id="fileSuratKeluar"></div>
                                        <div class="d-grid"><button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Simpan</button></div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DYNAMIC DISPOSISI PAGE -->
                    <div class="tab-pane" id="disposisi-container">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Inbox Disposisi: <b class="text-warning" id="dispPageTitle">Direktur</b></h2>
                            <button class="btn btn-outline-light" onclick="refreshCurrentDisposisi()"><i class="fas fa-sync-alt"></i> Refresh</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableDisposisi" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th><th>File</th><th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARSIP MASUK (FIXED) -->
                    <div class="tab-pane" id="arsip-masuk-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-info">Surat Masuk</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataMasuk()"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableMasuk" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr>
                                                <th>Tanggal</th><th>Agenda</th><th>Pengirim</th><th>Perihal</th>
                                                <th>Status</th><th>File</th><th class="text-center">History</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ARSIP KELUAR -->
                    <div class="tab-pane" id="arsip-keluar-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="fw-light text-white m-0">Arsip <b class="text-success">Surat Keluar</b></h2>
                            <button class="btn btn-outline-light" onclick="loadDataKeluar()"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                        </div>
                        <div class="card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="tableKeluar" class="table table-hover w-100 align-middle">
                                        <thead>
                                            <tr><th>Tgl</th><th>No. Surat</th><th>Tujuan</th><th>Perihal</th><th>File</th></tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROCESS DISPOSISI -->
    <div class="modal fade" id="modalDisposisi" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Proses Disposisi: <span id="modalDispLevelTitle" class="text-warning"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDisposisiAction">
                        <input type="hidden" id="actNoAgenda">
                        <div class="alert alert-secondary text-white small mb-3 p-2">
                            <strong>Perihal:</strong> <span id="actPerihal"></span>
                        </div>

                        <!-- INPUT DYNAMIC -->
                        <div id="fieldDirektur" class="disp-field d-none">
                            <label class="small text-info">Tujuan Wadir</label>
                            <select class="form-select mb-2" id="actTargetWadir">
                                <option value="Wadir Pelayanan">Wadir Pelayanan</option>
                                <option value="Wadir Admin & Keuangan">Wadir Admin & Keuangan</option>
                            </select>
                        </div>

                        <div id="fieldWadir" class="disp-field d-none">
                            <label class="small text-info">Tujuan Bidang/Bagian</label>
                            <select class="form-select mb-2" id="actTargetBidang">
                                <!-- Populated by JS -->
                            </select>
                        </div>

                        <div id="fieldKabid" class="disp-field d-none">
                            <label class="small text-info">Nama JF Tujuan</label>
                            <input type="text" class="form-control mb-2" id="actTargetJF" placeholder="Nama JF...">
                        </div>

                        <div id="fieldJF" class="disp-field d-none">
                            <label class="small text-info">Nama Staf Pelaksana</label>
                            <input type="text" class="form-control mb-2" id="actTargetStaf" placeholder="Nama Staf...">
                        </div>

                        <label class="small text-white-50 mt-2">Isi Instruksi</label>
                        <textarea class="form-control mb-3" id="actInstruksi" rows="3" placeholder="Instruksi..."></textarea>
                        
                        <label class="small text-white-50">Tanggal Proses</label>
                        <input type="date" class="form-control" id="actTgl" required>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" onclick="submitDisposisiLevel()">Kirim Disposisi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORY TIMELINE -->
    <div class="modal fade" id="modalHistory" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Riwayat Perjalanan Surat</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="timelineContent" class="ps-2 pt-2">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay"><div class="spinner-border text-info" style="width: 4rem; height: 4rem;"></div><div class="mt-4 fw-bold text-white fs-5">Sedang Memproses...</div></div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzuRKsINcUfY9tku6r1K7T-UBNOO054M9iiJdrgoIjqOf3jKfPeuBq1YX9moB9iJIMOvQ/exec"; 
        let currentLevel = ""; // 'direktur', 'wadir', 'kabid', 'jf'
        const structureOrg = {
            "Wadir Pelayanan": ["Bidang Pelayanan Medis", "Bidang Keperawatan", "Bidang Penunjang Medis"],
            "Wadir Admin & Keuangan": ["Bagian Tata Usaha", "Bagian Keuangan & Akuntansi", "Bagian Perencanaan & Program"]
        };

        $(document).ready(function() {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
                updateCounts();
            }
            
            // Set Default Date Today for Input
            document.querySelector('#formSuratMasuk input[name="tglTerima"]').valueAsDate = new Date();
            
            $('#formLogin').on('submit', function(e) {
                e.preventDefault();
                const pass = $('#loginPassword').val();
                showLoading(true);
                fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ type: 'login', password: pass }) })
                .then(res => res.json()).then(res => {
                    showLoading(false);
                    if (res.status === 'success') { 
                        sessionStorage.setItem('isLoggedIn', 'true'); 
                        showApp(); 
                        updateCounts();
                    }
                    else Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: res.message });
                }).catch(e => { showLoading(false); Swal.fire('Error', 'Koneksi Gagal', 'error'); });
            });

            // Initialize Tables
            const dtConfig = { language: { url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/id.json" }, pageLength: 10, autoWidth: false };
            $('#tableDisposisi').DataTable(dtConfig);
            $('#tableMasuk').DataTable(dtConfig);
            $('#tableKeluar').DataTable(dtConfig);

            // Setup Forms
            setupSimpleForm('#formSuratMasuk', 'simpan_masuk', 'Surat masuk tercatat.');
            setupSimpleForm('#formSuratKeluar', 'simpan_keluar', 'Surat keluar tercatat.');
        });

        // ========================================================
        // CORE NAVIGATION SYSTEM (SMOOTH TRANSITION FIX)
        // ========================================================
        
        function activateTab(tabId, element, callback) {
            // 1. Reset Sidebar State
            $('#sidebar .nav-link').removeClass('active'); 
            $('.submenu .nav-link').removeClass('active'); 
            
            // 2. Set Active to Clicked Element
            if(element) $(element).addClass('active');

            // 3. Handle Content Transition
            $('.tab-pane').removeClass('show active'); 
            
            const target = $('#' + tabId);
            target.addClass('active');
            setTimeout(() => { target.addClass('show'); }, 50);

            // 4. Run Callback if provided
            if (callback) callback();
        }

        // --- DISPOSISI LOGIC ---

        function openDisposisiPage(level, element) {
            currentLevel = level;
            activateTab('disposisi-container', element, refreshCurrentDisposisi);

            let title = level.toUpperCase();
            if(level==='kabid') title = "KABAG / KABID";
            $('#dispPageTitle').text(title);
        }

        function updateCounts() {
            fetch(`${GAS_URL}?action=get_counts`)
            .then(res => res.json())
            .then(res => {
                if(res.status === 'success') {
                    setCount('direktur', res.data.direktur);
                    setCount('wadir', res.data.wadir);
                    setCount('kabid', res.data.kabid);
                    setCount('jf', res.data.jf);
                }
            });
        }

        function setCount(id, count) {
            const el = $(`#count-${id}`);
            el.text(count);
            if(count > 0) el.addClass('has-data');
            else el.removeClass('has-data');
        }

        function refreshCurrentDisposisi() {
            showLoading(true);
            fetch(`${GAS_URL}?action=read_pending&level=${currentLevel}`)
            .then(res => res.json()).then(res => {
                showLoading(false);
                const dt = $('#tableDisposisi').DataTable();
                dt.clear();
                if(res.data) {
                    res.data.forEach(row => {
                        let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                        let btnProses = `<button class="btn btn-sm btn-warning fw-bold" onclick='openModalAction(${JSON.stringify(row)})'>Proses</button>`;
                        dt.row.add([ new Date(row[3]).toLocaleDateString('id-ID'), row[1], row[4], row[5], btnFile, btnProses ]);
                    });
                }
                dt.draw();
            });
        }

        function openModalAction(rowData) {
            $('#actNoAgenda').val(rowData[1]); // Agenda
            $('#actPerihal').text(rowData[5]); // Perihal
            document.querySelector('#actTgl').valueAsDate = new Date();
            $('#actInstruksi').val('');
            $('#modalDispLevelTitle').text(currentLevel.toUpperCase());

            // Show Hide Fields
            $('.disp-field').addClass('d-none');
            
            if(currentLevel === 'direktur') {
                $('#fieldDirektur').removeClass('d-none');
            } else if (currentLevel === 'wadir') {
                $('#fieldWadir').removeClass('d-none');
                let selectedWadir = rowData[7]; 
                let options = structureOrg[selectedWadir] || [];
                let html = options.map(o => `<option value="${o}">${o}</option>`).join('');
                $('#actTargetBidang').html(html);
            } else if (currentLevel === 'kabid') {
                $('#fieldKabid').removeClass('d-none');
            } else if (currentLevel === 'jf') {
                $('#fieldJF').removeClass('d-none');
            }

            new bootstrap.Modal(document.getElementById('modalDisposisi')).show();
        }

        function submitDisposisiLevel() {
            const formData = {
                type: 'update_disposisi_level',
                level: currentLevel,
                noAgenda: $('#actNoAgenda').val(),
                tglDisposisi: $('#actTgl').val(), // Note: Backend will use NEW DATE() for history, this is just for reference/unused
                instruksi: $('#actInstruksi').val()
            };

            if(currentLevel === 'direktur') formData.targetWadir = $('#actTargetWadir').val();
            if(currentLevel === 'wadir') formData.targetBidang = $('#actTargetBidang').val();
            if(currentLevel === 'kabid') formData.targetJF = $('#actTargetJF').val();
            if(currentLevel === 'jf') formData.targetStaf = $('#actTargetStaf').val();

            bootstrap.Modal.getInstance(document.getElementById('modalDisposisi')).hide();
            showLoading(true);
            sendData(formData, () => {
                refreshCurrentDisposisi();
                updateCounts(); 
                Swal.fire('Sukses', 'Disposisi berhasil diteruskan!', 'success');
            });
        }

        // --- ARSIP & HISTORY ---

        function loadDataMasuk() {
            fetch(`${GAS_URL}?action=read_masuk`).then(res=>res.json()).then(res=>{
                const dt = $('#tableMasuk').DataTable();
                dt.clear();
                if(res.data) {
                    res.data.forEach(row => {
                        let btnFile = row[6] ? `<a href="${row[6]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                        let status = `<span class="badge bg-secondary">${row[19]}</span>`;
                        if(row[19] === 'Selesai') status = `<span class="badge bg-success">Selesai</span>`;
                        
                        let btnHistory = `<button class="btn btn-sm btn-light text-primary border" onclick='viewHistory(${JSON.stringify(row)})'><i class="fas fa-eye"></i></button>`;

                        dt.row.add([ new Date(row[3]).toLocaleDateString('id-ID'), row[1], row[4], row[5], status, btnFile, btnHistory ]);
                    });
                }
                dt.draw();
            });
        }

        function viewHistory(row) {
            let html = '';
            
            // Step 0: Surat Diterima (Using Timestamp in row[0])
            html += createTimelineItem(true, "SURAT DITERIMA", `Agenda No: ${row[1]}`, "Surat berhasil dicatat oleh staf.", row[0]);

            // Direktur (Tgl: row[9])
            if(row[7]) html += createTimelineItem(true, "DIREKTUR", `Ke: ${row[7]}`, row[8], row[9]);
            else html += createTimelineItem(false, "DIREKTUR", "Menunggu Proses", "", "");

            // Wadir (Tgl: row[12])
            if(row[10]) html += createTimelineItem(true, "WADIR", `Ke: ${row[10]}`, row[11], row[12]);
            
            // Kabid (Tgl: row[15])
            if(row[13]) html += createTimelineItem(true, "KABAG/KABID", `Ke: ${row[13]}`, row[14], row[15]);

            // JF (Tgl: row[18])
            if(row[16]) html += createTimelineItem(true, "JF", `Ke Staf: ${row[16]}`, row[17], row[18]);

            $('#timelineContent').html(html);
            new bootstrap.Modal(document.getElementById('modalHistory')).show();
        }

        function formatDateTime(dateString) {
            if(!dateString) return '';
            const d = new Date(dateString);
            if(isNaN(d.getTime())) return '';
            // Format: dd/mm/yyyy HH:MM
            return d.toLocaleDateString('id-ID') + ' ' + d.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
        }

        function createTimelineItem(isDone, title, target, note, date) {
            let cls = isDone ? 'done' : '';
            let dateStr = date ? `<span class="badge bg-dark ms-2">${formatDateTime(date)}</span>` : '';
            return `
            <div class="timeline-item ${cls}">
                <div class="fw-bold text-warning small d-flex justify-content-between align-items-center">
                    <span>${title}</span>
                    ${dateStr}
                </div>
                <div class="timeline-content mt-1">
                    <div class="fw-bold small mb-1">${target}</div>
                    <div class="text-white-50 small fst-italic">"${note || '-'}"</div>
                </div>
            </div>`;
        }

        function loadDataKeluar() {
            fetch(`${GAS_URL}?action=read_keluar`).then(res=>res.json()).then(res=>{
                const dt = $('#tableKeluar').DataTable();
                dt.clear();
                if(res.data) {
                    res.data.forEach(row => {
                        let btnFile = row[5] ? `<a href="${row[5]}" target="_blank" class="btn btn-sm btn-outline-info"><i class="fas fa-file-pdf"></i></a>` : '-';
                        dt.row.add([ new Date(row[2]).toLocaleDateString('id-ID'), row[1], row[3], row[4], btnFile ]);
                    });
                }
                dt.draw();
            });
        }

        // --- UTILS ---
        function setupSimpleForm(selector, type, successMsg) {
            $(selector).on('submit', async function(e) {
                e.preventDefault();
                showLoading(true);
                let fileData = "", fileName = "";
                const fileInput = $(this).find('input[type="file"]')[0];
                if (fileInput.files.length > 0) {
                    try {
                        fileData = await readFileToBase64(fileInput.files[0]);
                        fileName = fileInput.files[0].name;
                    } catch(e) { showLoading(false); return Swal.fire('Error File', '', 'error'); }
                }
                const formData = { type: type, fileData: fileData, fileName: fileName };
                $(this).serializeArray().forEach(item => formData[item.name] = item.value);
                
                sendData(formData, () => {
                    $(selector)[0].reset();
                    // Reset default date again after submit
                    document.querySelector('#formSuratMasuk input[name="tglTerima"]').valueAsDate = new Date();
                    updateCounts(); 
                    Swal.fire('Sukses', successMsg, 'success');
                });
            });
        }

        function showApp() { $('#loginSection').fadeOut(300, ()=> $('#appContent').fadeIn(300)); }
        function logout() { sessionStorage.removeItem('isLoggedIn'); location.reload(); }
        function showLoading(show) { $('#loadingOverlay').css('display', show ? 'flex' : 'none'); }
        function sendData(data, cb) { fetch(GAS_URL, { method: 'POST', body: JSON.stringify(data) }).then(r=>r.json()).then(r=> { showLoading(false); if(r.status==='success') cb(); else Swal.fire('Gagal', r.message, 'error'); }); }
        function readFileToBase64(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = () => res(r.result); r.onerror = e => rej(e); }); }
        function showChangePassword() { /* Logic same as previous */ }
    </script>
</body>
</html>
